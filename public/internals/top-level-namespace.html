<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
    <meta name="Content-Type" content="text/html; charset=utf-8" />
<title>Top Level Namespace</title>
<link rel="stylesheet" href="css/style.css" type="text/css" media="screen" charset="utf-8" />
<link rel="stylesheet" href="css/common.css" type="text/css" media="screen" charset="utf-8" />

<script type="text/javascript" charset="utf-8">
  relpath = '';
  if (relpath != '') relpath += '/';
</script>
<script type="text/javascript" charset="utf-8" src="js/jquery.js"></script>
<script type="text/javascript" charset="utf-8" src="js/app.js"></script>

  </head>
  <body>
    <script type="text/javascript" charset="utf-8">
      if (window.top.frames.main) document.body.className = 'frames';
    </script>
    
    <div id="header">
      <div id="menu">
  
    <a href="_index.html">Index</a> &raquo; 
    
    
    <span class="title">Top Level Namespace</span>
  
  
  <div class="noframes"><span class="title">(</span><a href="." target="_top">no frames</a><span class="title">)</span></div>
</div>

      <div id="search">
  <a id="class_list_link" href="#">Class List</a>
  <a id="method_list_link" href="#">Method List</a>
  <a id ="file_list_link" href="#">File List</a>
</div>

      <div class="clear"></div>
    </div>
    
    <iframe id="search_frame"></iframe>
    
    <div id="content"><h1>Top Level Namespace
  
  
  
</h1>

<dl class="box">
  
  
    
  
    
      <dt class="r1">Includes:</dt>
      <dd class="r1"><span class='object_link'><a href="Store.html" title="Store (module)">Store</a></span></dd>
      
    
  
  
  
</dl>
<div class="clear"></div>

<h2>Defined Under Namespace</h2>
<p class="children">
   
    
      <strong class="modules">Modules:</strong> <span class='object_link'><a href="MySqlConnectionMixIn.html" title="MySqlConnectionMixIn (module)">MySqlConnectionMixIn</a></span>, <span class='object_link'><a href="MySqlTableMixIn.html" title="MySqlTableMixIn (module)">MySqlTableMixIn</a></span>, <span class='object_link'><a href="PostgresTableMixIn.html" title="PostgresTableMixIn (module)">PostgresTableMixIn</a></span>, <span class='object_link'><a href="PostgressConnectionMixIn.html" title="PostgressConnectionMixIn (module)">PostgressConnectionMixIn</a></span>, <span class='object_link'><a href="Store.html" title="Store (module)">Store</a></span>, <span class='object_link'><a href="StoreUtils.html" title="StoreUtils (module)">StoreUtils</a></span>
    
   
    
      <strong class="classes">Classes:</strong> <span class='object_link'><a href="ArrayBasedStream.html" title="ArrayBasedStream (class)">ArrayBasedStream</a></span>, <span class='object_link'><a href="ComparisonStream.html" title="ComparisonStream (class)">ComparisonStream</a></span>, <span class='object_link'><a href="Connection.html" title="Connection (class)">Connection</a></span>, <span class='object_link'><a href="ConnectionId.html" title="ConnectionId (class)">ConnectionId</a></span>, <span class='object_link'><a href="DbStream.html" title="DbStream (class)">DbStream</a></span>, <span class='object_link'><a href="FileStream.html" title="FileStream (class)">FileStream</a></span>, <span class='object_link'><a href="Logger.html" title="Logger (class)">Logger</a></span>, <span class='object_link'><a href="SiloFixityStream.html" title="SiloFixityStream (class)">SiloFixityStream</a></span>, <span class='object_link'><a href="SiloStream.html" title="SiloStream (class)">SiloStream</a></span>, <span class='object_link'><a href="Trie.html" title="Trie (class)">Trie</a></span>
    
  
</p>

  <h2>Constant Summary</h2>
  
    <dl class="constants">
      
        <dt id="PACKAGES_PER_PAGE-constant" class="">PACKAGES_PER_PAGE =
          <div class="docstring">
  <div class="discussion">
    <p>
TODO: recent sinatra fixed relative-redirection problem, check to see if we
can remove &#8216;absolutely&#8217;
</p>


  </div>
</div>
<div class="tags">
  
</div>
        </dt>
        <dd><pre class="code"><span class='integer val'>40</span>
</pre></dd>
      
        <dt id="REVISION-constant" class="">REVISION =
          
        </dt>
        <dd><pre class="code"><span class='Store constant id'>Store</span><span class='dot token'>.</span><span class='version identifier id'>version</span><span class='dot token'>.</span><span class='rev identifier id'>rev</span>
</pre></dd>
      
        <dt id="DEBUG-constant" class="">DEBUG =
          
        </dt>
        <dd><pre class="code"><span class='true true kw'>true</span>
</pre></dd>
      
    </dl>
  


  
  
  
  
  <h3 class="inherited">Constants included from <span class='object_link'><a href="Store.html" title="Store (module)">Store</a></span></h3>
  <p class="inherited"><span class='object_link'><a href="Store.html#NAME-constant" title="Store::NAME (constant)">NAME</a></span>, <span class='object_link'><a href="Store.html#RELEASE-constant" title="Store::RELEASE (constant)">RELEASE</a></span>, <span class='object_link'><a href="Store.html#REVISION-constant" title="Store::REVISION (constant)">REVISION</a></span>, <span class='object_link'><a href="Store.html#VERSION-constant" title="Store::VERSION (constant)">VERSION</a></span></p>


  
    <h2>
      Instance Method Summary
      <small>(<a href="#" class="summary_toggle">collapse</a>)</small>
    </h2>

    <ul class="summary">
      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#check_for_missing-instance_method" title="#check_for_missing (instance method)">- (Object) <strong>check_for_missing</strong>(web_server, silo, filesystem) </a>
    

    
  </span>
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'><p>
TODO: rename to database_check.
</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#check_package_fixities-instance_method" title="#check_package_fixities (instance method)">- (Object) <strong>check_package_fixities</strong>(web_server, silo_name, filesystem) </a>
    

    
  </span>
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'><p>
check_package_fixities CONF.
</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#clean_up_scratch_disk-instance_method" title="#clean_up_scratch_disk (instance method)">- (Object) <strong>clean_up_scratch_disk</strong>(filesystem) </a>
    

    
  </span>
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'><p>
clean_up_scratch_disk filesystem.
</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#get_capistrano_git_revision-instance_method" title="#get_capistrano_git_revision (instance method)">- (Object) <strong>get_capistrano_git_revision</strong> </a>
    

    
  </span>
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'><p>
When we deploy with Capistrano it checks out the code using Git into its
own branch, and places the git revision hash into the
&#8216;REVISION&#8217; file.
</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#get_capistrano_release-instance_method" title="#get_capistrano_release (instance method)">- (Object) <strong>get_capistrano_release</strong> </a>
    

    
  </span>
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'><p>
When we deploy with Capistrano, it places a newly checked out version of
the code into a directory created under ../releases/, with names such as
20100516175736.
</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#iam-instance_method" title="#iam (instance method)">- (Object) <strong>iam</strong>(ob) </a>
    

    
  </span>
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'></div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#pluralize_maybe-instance_method" title="#pluralize_maybe (instance method)">- (Object) <strong>pluralize_maybe</strong>(count, singular, plural = nil) </a>
    

    
  </span>
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'></div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#restore_to_scratch_disk-instance_method" title="#restore_to_scratch_disk (instance method)">- (Object) <strong>restore_to_scratch_disk</strong>(tape_server, silo, destination_directory) </a>
    

    
  </span>
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'><p>
restore_to_scratch_disk .
</p>
</div></span>
  
</li>

      
    </ul>
  


  
  
  
  
  
  
  
  <h3 class="inherited">Methods included from <span class='object_link'><a href="Store.html" title="Store (module)">Store</a></span></h3>
  <p class="inherited"><span class='object_link'><a href="Store.html#version-class_method" title="Store.version (method)">version</a></span></p>


  <div id="instance_method_details" class="method_details_list">
    <h2>Instance Method Details</h2>
    
    
      <div class="method_details first">
  <p class="signature first" id="check_for_missing-instance_method">
  
    - (<tt>Object</tt>) <strong>check_for_missing</strong>(web_server, silo, filesystem) 
  

  
</p><div class="docstring">
  <div class="discussion">
    <p>
TODO: rename to database_check
</p>


  </div>
</div>
<div class="tags">
  <h3>Raises:</h3>
<ul class="raise">
  
    <li>
      
        <span class='type'>(<tt><span class='object_link'><a href="Store/FatalFixityError.html" title="Store::FatalFixityError (class)">FatalFixityError</a></span></tt>)</span>
      
      
      
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File '/Users/fischer/WorkProjects/daitss2/silo-pool/lib/store/fixityutils.rb', line 103</span>

<span class='def def kw'>def</span> <span class='check_for_missing identifier id'>check_for_missing</span> <span class='web_server identifier id'>web_server</span><span class='comma token'>,</span> <span class='silo identifier id'>silo</span><span class='comma token'>,</span> <span class='filesystem identifier id'>filesystem</span>   
  <span class='info identifier id'>info</span> <span class='assign token'>=</span> <span class='Struct constant id'>Struct</span><span class='colon2 op'>::</span><span class='FileIssues constant id'>FileIssues</span><span class='dot token'>.</span><span class='new identifier id'>new</span><span class='lparen token'>(</span><span class='integer val'>0</span><span class='comma token'>,</span> <span class='integer val'>0</span><span class='comma token'>,</span> <span class='integer val'>0</span><span class='rparen token'>)</span>

  <span class='Logger constant id'>Logger</span><span class='dot token'>.</span><span class='info identifier id'>info</span> <span class='dstring node'>&quot;Database check for missing, ghost and alien packages for the silo #{silo} on filesystem #{filesystem}.&quot;</span>

  <span class='silo_stream identifier id'>silo_stream</span> <span class='assign token'>=</span> <span class='SiloStream constant id'>SiloStream</span><span class='dot token'>.</span><span class='new identifier id'>new</span><span class='lparen token'>(</span><span class='filesystem identifier id'>filesystem</span><span class='rparen token'>)</span>
  <span class='db_stream identifier id'>db_stream</span>   <span class='assign token'>=</span> <span class='DbStream constant id'>DbStream</span><span class='dot token'>.</span><span class='new identifier id'>new</span><span class='lparen token'>(</span><span class='web_server identifier id'>web_server</span><span class='comma token'>,</span> <span class='silo identifier id'>silo</span><span class='rparen token'>)</span>

  <span class='missing identifier id'>missing</span>  <span class='assign token'>=</span> <span class='lbrack token'>[</span><span class='rbrack token'>]</span>  <span class='comment val'># in db, but not on filesystem</span>
  <span class='aliens identifier id'>aliens</span>   <span class='assign token'>=</span> <span class='lbrack token'>[</span><span class='rbrack token'>]</span>  <span class='comment val'># on filesystem, but not in db at all</span>
  <span class='ghosts identifier id'>ghosts</span>   <span class='assign token'>=</span> <span class='lbrack token'>[</span><span class='rbrack token'>]</span>  <span class='comment val'># on filesystem, but marked as deleted in db</span>

  <span class='comment val'># on_disk is nil if package was not present on disk,  true otherwise</span>
  <span class='comment val'># in_db is nil if no package record in db, false if package was marked as deleted, and true if it should exist   #### TODO: need better than true/false here</span>

  <span class='ComparisonStream constant id'>ComparisonStream</span><span class='dot token'>.</span><span class='new identifier id'>new</span><span class='lparen token'>(</span><span class='silo_stream identifier id'>silo_stream</span><span class='comma token'>,</span> <span class='db_stream identifier id'>db_stream</span><span class='rparen token'>)</span><span class='dot token'>.</span><span class='get identifier id'>get</span> <span class='do do kw'>do</span> <span class='bitor op'>|</span><span class='package_name identifier id'>package_name</span><span class='comma token'>,</span> <span class='on_disk identifier id'>on_disk</span><span class='comma token'>,</span> <span class='in_db identifier id'>in_db</span><span class='bitor op'>|</span>
    <span class='if if kw'>if</span> <span class='on_disk identifier id'>on_disk</span><span class='dot token'>.</span><span class='nil? fid id'>nil?</span>
      <span class='missing identifier id'>missing</span><span class='dot token'>.</span><span class='push identifier id'>push</span> <span class='package_name identifier id'>package_name</span> <span class='if if_mod kw'>if</span> <span class='in_db identifier id'>in_db</span>       <span class='comment val'># we don't care if not on disk and marked as deleted in the db;</span>
    <span class='elsif elsif kw'>elsif</span> <span class='in_db identifier id'>in_db</span><span class='dot token'>.</span><span class='nil? fid id'>nil?</span>                           
      <span class='aliens identifier id'>aliens</span><span class='dot token'>.</span><span class='push identifier id'>push</span> <span class='package_name identifier id'>package_name</span>    
    <span class='else else kw'>else</span>
      <span class='ghosts identifier id'>ghosts</span><span class='dot token'>.</span><span class='push identifier id'>push</span> <span class='package_name identifier id'>package_name</span>  <span class='if if_mod kw'>if</span> <span class='not not kw'>not</span> <span class='in_db identifier id'>in_db</span>   <span class='comment val'># It is on_disk, but is marked in the db as deleted - this will happen over time for silos restored from tapes,</span>
    <span class='end end kw'>end</span>                                        <span class='comment val'># but it indicates a real problem for disk silos.</span>
  <span class='end end kw'>end</span>

  <span class='if if kw'>if</span> <span class='not not kw'>not</span> <span class='ghosts identifier id'>ghosts</span><span class='dot token'>.</span><span class='empty? fid id'>empty?</span>
    <span class='info identifier id'>info</span><span class='dot token'>.</span><span class='ghosts identifier id'>ghosts</span> <span class='assign token'>=</span> <span class='ghosts identifier id'>ghosts</span><span class='dot token'>.</span><span class='count identifier id'>count</span>
    <span class='Logger constant id'>Logger</span><span class='dot token'>.</span><span class='info identifier id'>info</span> <span class='dstring node'>&quot;The filesystem #{filesystem} has #{info.ghosts} #{pluralize_maybe(ghosts.count, 'package')} that the database indicates have been deleted from #{silo}: package names follow:&quot;</span>
    <span class='ghosts identifier id'>ghosts</span><span class='dot token'>.</span><span class='each_slice identifier id'>each_slice</span><span class='lparen token'>(</span><span class='integer val'>5</span><span class='rparen token'>)</span> <span class='lbrace token'>{</span> <span class='bitor op'>|</span><span class='slice identifier id'>slice</span><span class='bitor op'>|</span> <span class='Logger constant id'>Logger</span><span class='dot token'>.</span><span class='info identifier id'>info</span> <span class='slice identifier id'>slice</span><span class='dot token'>.</span><span class='join identifier id'>join</span><span class='lparen token'>(</span><span class='string val'>' '</span><span class='rparen token'>)</span> <span class='rbrace token'>}</span>
  <span class='end end kw'>end</span>
  
  <span class='if if kw'>if</span> <span class='not not kw'>not</span> <span class='aliens identifier id'>aliens</span><span class='dot token'>.</span><span class='empty? fid id'>empty?</span>
    <span class='info identifier id'>info</span><span class='dot token'>.</span><span class='aliens identifier id'>aliens</span> <span class='assign token'>=</span> <span class='aliens identifier id'>aliens</span><span class='dot token'>.</span><span class='count identifier id'>count</span>
    <span class='Logger constant id'>Logger</span><span class='dot token'>.</span><span class='info identifier id'>info</span> <span class='dstring node'>&quot;The filesystem #{filesystem} has #{info.aliens} #{pluralize_maybe(aliens.count, 'package')} that the database for #{silo} has no record of, package names follow:&quot;</span>
    <span class='aliens identifier id'>aliens</span><span class='dot token'>.</span><span class='each_slice identifier id'>each_slice</span><span class='lparen token'>(</span><span class='integer val'>5</span><span class='rparen token'>)</span> <span class='lbrace token'>{</span> <span class='bitor op'>|</span><span class='slice identifier id'>slice</span><span class='bitor op'>|</span> <span class='Logger constant id'>Logger</span><span class='dot token'>.</span><span class='warn identifier id'>warn</span> <span class='slice identifier id'>slice</span><span class='dot token'>.</span><span class='join identifier id'>join</span><span class='lparen token'>(</span><span class='string val'>' '</span><span class='rparen token'>)</span> <span class='rbrace token'>}</span>
  <span class='end end kw'>end</span>

  <span class='if if kw'>if</span> <span class='not not kw'>not</span> <span class='missing identifier id'>missing</span><span class='dot token'>.</span><span class='empty? fid id'>empty?</span>
    <span class='info identifier id'>info</span><span class='dot token'>.</span><span class='missing identifier id'>missing</span> <span class='assign token'>=</span> <span class='missing identifier id'>missing</span><span class='dot token'>.</span><span class='count identifier id'>count</span>
    <span class='Logger constant id'>Logger</span><span class='dot token'>.</span><span class='err identifier id'>err</span> <span class='dstring node'>&quot;The filesystem #{filesystem} is missing #{info.missing} #{pluralize_maybe(missing.count, 'package')} that the database for #{silo} indicates should be there, package names follow:&quot;</span>
    <span class='missing identifier id'>missing</span><span class='dot token'>.</span><span class='each_slice identifier id'>each_slice</span><span class='lparen token'>(</span><span class='integer val'>5</span><span class='rparen token'>)</span> <span class='lbrace token'>{</span> <span class='bitor op'>|</span><span class='slice identifier id'>slice</span><span class='bitor op'>|</span> <span class='Logger constant id'>Logger</span><span class='dot token'>.</span><span class='err identifier id'>err</span> <span class='slice identifier id'>slice</span><span class='dot token'>.</span><span class='join identifier id'>join</span><span class='lparen token'>(</span><span class='string val'>' '</span><span class='rparen token'>)</span> <span class='rbrace token'>}</span>
  <span class='end end kw'>end</span>

  <span class='return return kw'>return</span> <span class='info identifier id'>info</span>
<span class='rescue rescue kw'>rescue</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='e identifier id'>e</span>
  <span class='raise identifier id'>raise</span> <span class='FatalFixityError constant id'>FatalFixityError</span><span class='comma token'>,</span> <span class='dstring node'>&quot;Error while doing database checking for missing, alien or ghost packages: #{e}&quot;</span>
<span class='end end kw'>end</span>
</pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <p class="signature " id="check_package_fixities-instance_method">
  
    - (<tt>Object</tt>) <strong>check_package_fixities</strong>(web_server, silo_name, filesystem) 
  

  
</p><div class="docstring">
  <div class="discussion">
    <p>
check_package_fixities CONF
</p>
<p>
Recompute all checksums and record into a database.  Log error if we get a
mismatch with a previous checksum.
</p>


  </div>
</div>
<div class="tags">
  <h3>Raises:</h3>
<ul class="raise">
  
    <li>
      
        <span class='type'>(<tt><span class='object_link'><a href="Store/FatalFixityError.html" title="Store::FatalFixityError (class)">FatalFixityError</a></span></tt>)</span>
      
      
      
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File '/Users/fischer/WorkProjects/daitss2/silo-pool/lib/store/fixityutils.rb', line 9</span>

<span class='def def kw'>def</span> <span class='check_package_fixities identifier id'>check_package_fixities</span> <span class='web_server identifier id'>web_server</span><span class='comma token'>,</span> <span class='silo_name identifier id'>silo_name</span><span class='comma token'>,</span> <span class='filesystem identifier id'>filesystem</span>
  <span class='success identifier id'>success</span> <span class='assign token'>=</span> <span class='true true kw'>true</span>

  <span class='Logger constant id'>Logger</span><span class='dot token'>.</span><span class='info identifier id'>info</span> <span class='dstring node'>&quot;Checking package fixities from the database records for silo #{silo_name} against the filesystem #{filesystem}.&quot;</span>

  <span class='silo_record identifier id'>silo_record</span> <span class='assign token'>=</span> <span class='Store constant id'>Store</span><span class='colon2 op'>::</span><span class='DB constant id'>DB</span><span class='colon2 op'>::</span><span class='SiloRecord constant id'>SiloRecord</span><span class='dot token'>.</span><span class='lookup identifier id'>lookup</span><span class='lparen token'>(</span><span class='web_server identifier id'>web_server</span><span class='comma token'>,</span> <span class='silo_name identifier id'>silo_name</span><span class='rparen token'>)</span>
  <span class='silo identifier id'>silo</span>        <span class='assign token'>=</span> <span class='Store constant id'>Store</span><span class='colon2 op'>::</span><span class='Silo constant id'>Silo</span><span class='dot token'>.</span><span class='new identifier id'>new</span><span class='lparen token'>(</span><span class='filesystem identifier id'>filesystem</span><span class='rparen token'>)</span>

  <span class='silo identifier id'>silo</span><span class='dot token'>.</span><span class='each identifier id'>each</span> <span class='do do kw'>do</span> <span class='bitor op'>|</span><span class='package identifier id'>package</span><span class='bitor op'>|</span>
    <span class='begin begin kw'>begin</span>

      <span class='package_record identifier id'>package_record</span> <span class='assign token'>=</span> <span class='Store constant id'>Store</span><span class='colon2 op'>::</span><span class='DB constant id'>DB</span><span class='colon2 op'>::</span><span class='PackageRecord constant id'>PackageRecord</span><span class='dot token'>.</span><span class='lookup identifier id'>lookup</span><span class='lparen token'>(</span><span class='silo_record identifier id'>silo_record</span><span class='comma token'>,</span> <span class='package identifier id'>package</span><span class='rparen token'>)</span> 
      <span class='md5 identifier id'>md5</span>  <span class='assign token'>=</span> <span class='Digest constant id'>Digest</span><span class='colon2 op'>::</span><span class='MD5 constant id'>MD5</span><span class='dot token'>.</span><span class='new identifier id'>new</span>
      <span class='sha1 identifier id'>sha1</span> <span class='assign token'>=</span> <span class='Digest constant id'>Digest</span><span class='colon2 op'>::</span><span class='SHA1 constant id'>SHA1</span><span class='dot token'>.</span><span class='new identifier id'>new</span>
      <span class='silo identifier id'>silo</span><span class='dot token'>.</span><span class='get identifier id'>get</span><span class='lparen token'>(</span><span class='package identifier id'>package</span><span class='rparen token'>)</span> <span class='do do kw'>do</span> <span class='bitor op'>|</span><span class='buff identifier id'>buff</span><span class='bitor op'>|</span>
        <span class='md5 identifier id'>md5</span>  <span class='lshft op'>&lt;&lt;</span> <span class='buff identifier id'>buff</span>
        <span class='sha1 identifier id'>sha1</span> <span class='lshft op'>&lt;&lt;</span> <span class='buff identifier id'>buff</span> 
     <span class='end end kw'>end</span>
      <span class='md5 identifier id'>md5</span>  <span class='assign token'>=</span> <span class='md5 identifier id'>md5</span><span class='dot token'>.</span><span class='hexdigest identifier id'>hexdigest</span>
      <span class='sha1 identifier id'>sha1</span> <span class='assign token'>=</span> <span class='sha1 identifier id'>sha1</span><span class='dot token'>.</span><span class='hexdigest identifier id'>hexdigest</span>
    <span class='rescue rescue kw'>rescue</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='e identifier id'>e</span>              <span class='comment val'># We attempt to continue from a single package error</span>
      <span class='Logger constant id'>Logger</span><span class='dot token'>.</span><span class='err identifier id'>err</span> <span class='dstring node'>&quot;Fixity failure for package #{package} on #{filesytem}: #{e.message}.&quot;</span>
      <span class='success identifier id'>success</span> <span class='assign token'>=</span> <span class='false false kw'>false</span>
    <span class='else else kw'>else</span>

      <span class='Store constant id'>Store</span><span class='colon2 op'>::</span><span class='DB constant id'>DB</span><span class='colon2 op'>::</span><span class='HistoryRecord constant id'>HistoryRecord</span><span class='dot token'>.</span><span class='fixity identifier id'>fixity</span><span class='lparen token'>(</span><span class='silo_record identifier id'>silo_record</span><span class='comma token'>,</span> <span class='package identifier id'>package</span><span class='comma token'>,</span> <span class='symbol val'>:md5</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='md5 identifier id'>md5</span><span class='comma token'>,</span> <span class='symbol val'>:sha1</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='sha1 identifier id'>sha1</span><span class='rparen token'>)</span>   
      <span class='errors identifier id'>errors</span> <span class='assign token'>=</span> <span class='lbrack token'>[</span><span class='rbrack token'>]</span>
      <span class='errors identifier id'>errors</span><span class='dot token'>.</span><span class='push identifier id'>push</span> <span class='dstring node'>&quot;database md5 mismatch - expected #{package_record.initial_md5} but got #{md5}&quot;</span>        <span class='if if_mod kw'>if</span> <span class='lparen token'>(</span><span class='md5 identifier id'>md5</span>  <span class='neq op'>!=</span> <span class='package_record identifier id'>package_record</span><span class='dot token'>.</span><span class='initial_md5 identifier id'>initial_md5</span><span class='rparen token'>)</span>
      <span class='errors identifier id'>errors</span><span class='dot token'>.</span><span class='push identifier id'>push</span> <span class='dstring node'>&quot;filesystem md5 mismatch - expected #{silo.md5(package)} but got #{md5}&quot;</span>               <span class='if if_mod kw'>if</span> <span class='lparen token'>(</span><span class='md5 identifier id'>md5</span>  <span class='neq op'>!=</span> <span class='silo identifier id'>silo</span><span class='dot token'>.</span><span class='md5 identifier id'>md5</span><span class='lparen token'>(</span><span class='package identifier id'>package</span><span class='rparen token'>)</span><span class='rparen token'>)</span>
      <span class='errors identifier id'>errors</span><span class='dot token'>.</span><span class='push identifier id'>push</span> <span class='dstring node'>&quot;database sha1 mismatch - expected #{package_record.initial_sha1} but got #{sha1}&quot;</span>     <span class='if if_mod kw'>if</span> <span class='lparen token'>(</span><span class='sha1 identifier id'>sha1</span> <span class='neq op'>!=</span> <span class='package_record identifier id'>package_record</span><span class='dot token'>.</span><span class='initial_sha1 identifier id'>initial_sha1</span><span class='rparen token'>)</span>
      <span class='errors identifier id'>errors</span><span class='dot token'>.</span><span class='push identifier id'>push</span> <span class='dstring node'>&quot;filesystem sha1 mismatch - expected #{silo.sha1(package)} but got #{sha1}&quot;</span>            <span class='if if_mod kw'>if</span> <span class='lparen token'>(</span><span class='sha1 identifier id'>sha1</span> <span class='neq op'>!=</span> <span class='silo identifier id'>silo</span><span class='dot token'>.</span><span class='sha1 identifier id'>sha1</span><span class='lparen token'>(</span><span class='package identifier id'>package</span><span class='rparen token'>)</span><span class='rparen token'>)</span>
      <span class='if if kw'>if</span> <span class='errors identifier id'>errors</span><span class='dot token'>.</span><span class='count identifier id'>count</span> <span class='gt op'>&gt;</span> <span class='integer val'>0</span>
         <span class='Logger constant id'>Logger</span><span class='dot token'>.</span><span class='err identifier id'>err</span>  <span class='dstring node'>&quot;Fixity failure for package #{package} belonging to silo #{silo_name} (checked at #{filesystem}): #{errors.join('; ')}.&quot;</span>
         <span class='success identifier id'>success</span> <span class='assign token'>=</span> <span class='false false kw'>false</span>
      <span class='end end kw'>end</span>
    <span class='end end kw'>end</span>
  <span class='end end kw'>end</span>

  <span class='return return kw'>return</span> <span class='success identifier id'>success</span>
<span class='rescue rescue kw'>rescue</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='e identifier id'>e</span>
  <span class='raise identifier id'>raise</span> <span class='FatalFixityError constant id'>FatalFixityError</span><span class='comma token'>,</span> <span class='dstring node'>&quot;Fixity check failure, #{e}&quot;</span>
<span class='end end kw'>end</span>
</pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <p class="signature " id="clean_up_scratch_disk-instance_method">
  
    - (<tt>Object</tt>) <strong>clean_up_scratch_disk</strong>(filesystem) 
  

  
</p><div class="docstring">
  <div class="discussion">
    <p>
clean_up_scratch_disk filesystem
</p>
<p>
Attempt to remove all silo directories from the scratch disk.
</p>


  </div>
</div>
<div class="tags">
  <h3>Raises:</h3>
<ul class="raise">
  
    <li>
      
        <span class='type'>(<tt><span class='object_link'><a href="Store/FatalFixityError.html" title="Store::FatalFixityError (class)">FatalFixityError</a></span></tt>)</span>
      
      
      
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File '/Users/fischer/WorkProjects/daitss2/silo-pool/lib/store/fixityutils.rb', line 156</span>

<span class='def def kw'>def</span> <span class='clean_up_scratch_disk identifier id'>clean_up_scratch_disk</span> <span class='filesystem identifier id'>filesystem</span>

  <span class='Logger constant id'>Logger</span><span class='dot token'>.</span><span class='info identifier id'>info</span> <span class='dstring node'>&quot;Cleaning scratch disk #{filesystem}.&quot;</span>

  <span class='targets identifier id'>targets</span> <span class='assign token'>=</span> <span class='lbrack token'>[</span><span class='rbrack token'>]</span>
  <span class='Dir constant id'>Dir</span><span class='dot token'>.</span><span class='open identifier id'>open</span> <span class='filesystem identifier id'>filesystem</span> <span class='do do kw'>do</span> <span class='bitor op'>|</span><span class='root identifier id'>root</span><span class='bitor op'>|</span>
    <span class='root identifier id'>root</span><span class='dot token'>.</span><span class='sort identifier id'>sort</span><span class='dot token'>.</span><span class='each identifier id'>each</span> <span class='do do kw'>do</span> <span class='bitor op'>|</span><span class='subdir identifier id'>subdir</span><span class='bitor op'>|</span>
      <span class='target identifier id'>target</span> <span class='assign token'>=</span> <span class='File constant id'>File</span><span class='dot token'>.</span><span class='join identifier id'>join</span><span class='lparen token'>(</span><span class='filesystem identifier id'>filesystem</span><span class='comma token'>,</span> <span class='subdir identifier id'>subdir</span><span class='rparen token'>)</span>
      <span class='next next kw'>next</span> <span class='unless unless_mod kw'>unless</span> <span class='File constant id'>File</span><span class='dot token'>.</span><span class='directory? fid id'>directory?</span> <span class='target identifier id'>target</span>
      <span class='next next kw'>next</span> <span class='unless unless_mod kw'>unless</span> <span class='subdir identifier id'>subdir</span> <span class='match op'>=~</span> <span class='regexp val'>%r{[a-f0-9]{3}}</span>        <span class='comment val'># only target the top-level directories we expect</span>
      <span class='targets identifier id'>targets</span><span class='dot token'>.</span><span class='push identifier id'>push</span> <span class='target identifier id'>target</span>
    <span class='end end kw'>end</span>
  <span class='end end kw'>end</span>
  <span class='FileUtils constant id'>FileUtils</span><span class='dot token'>.</span><span class='chmod_R identifier id'>chmod_R</span> <span class='integer val'>0777</span><span class='comma token'>,</span> <span class='targets identifier id'>targets</span>
  <span class='FileUtils constant id'>FileUtils</span><span class='dot token'>.</span><span class='rm_rf identifier id'>rm_rf</span> <span class='targets identifier id'>targets</span>

<span class='rescue rescue kw'>rescue</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='e identifier id'>e</span>
  <span class='raise identifier id'>raise</span> <span class='FatalFixityError constant id'>FatalFixityError</span><span class='comma token'>,</span> <span class='dstring node'>&quot;Unable to remove directories from the scratch disk #{filesystem}: #{e.message}&quot;</span>
<span class='end end kw'>end</span>
</pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <p class="signature " id="get_capistrano_git_revision-instance_method">
  
    - (<tt>Object</tt>) <strong>get_capistrano_git_revision</strong> 
  

  
</p><div class="docstring">
  <div class="discussion">
    <p>
When we deploy with Capistrano it checks out the code using Git into its
own branch, and places the git revision hash into the
&#8216;REVISION&#8217; file.  Here we search for that file, and if found,
return its contents.
</p>


  </div>
</div>
<div class="tags">
  
</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


8
9
10
11</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File '/Users/fischer/WorkProjects/daitss2/silo-pool/lib/store.rb', line 8</span>

<span class='def def kw'>def</span> <span class='get_capistrano_git_revision identifier id'>get_capistrano_git_revision</span>
  <span class='revision_file identifier id'>revision_file</span> <span class='assign token'>=</span> <span class='File constant id'>File</span><span class='dot token'>.</span><span class='expand_path identifier id'>expand_path</span><span class='lparen token'>(</span><span class='File constant id'>File</span><span class='dot token'>.</span><span class='join identifier id'>join</span><span class='lparen token'>(</span><span class='File constant id'>File</span><span class='dot token'>.</span><span class='dirname identifier id'>dirname</span><span class='lparen token'>(</span><span class='__FILE__ __file__ kw'>__FILE__</span><span class='rparen token'>)</span><span class='comma token'>,</span> <span class='string val'>'..'</span><span class='comma token'>,</span> <span class='string val'>'REVISION'</span><span class='rparen token'>)</span><span class='rparen token'>)</span>
  <span class='File constant id'>File</span><span class='dot token'>.</span><span class='exists? fid id'>exists?</span><span class='lparen token'>(</span><span class='revision_file identifier id'>revision_file</span><span class='rparen token'>)</span> <span class='question op'>?</span> <span class='File constant id'>File</span><span class='dot token'>.</span><span class='readlines identifier id'>readlines</span><span class='lparen token'>(</span><span class='revision_file identifier id'>revision_file</span><span class='rparen token'>)</span><span class='lbrack token'>[</span><span class='integer val'>0</span><span class='rbrack token'>]</span><span class='dot token'>.</span><span class='chomp identifier id'>chomp</span> <span class='colon op'>:</span> <span class='string val'>'Unknown'</span>
<span class='end end kw'>end</span>
</pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <p class="signature " id="get_capistrano_release-instance_method">
  
    - (<tt>Object</tt>) <strong>get_capistrano_release</strong> 
  

  
</p><div class="docstring">
  <div class="discussion">
    <p>
When we deploy with Capistrano, it places a newly checked out version of
the code into a directory created under ../releases/, with names such as
20100516175736.  Now this is a nice thing, since these directories are
backed up in the normal course of events: we&#8217;d like to include this
release number in our service version information so we can easily locate
the specific version of the code, if need be, in the future.
</p>
<p>
Note that this release information is more specific than a git release; it
includes configuration information that may not be checked in.
</p>


  </div>
</div>
<div class="tags">
  
</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


25
26
27
28</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File '/Users/fischer/WorkProjects/daitss2/silo-pool/lib/store.rb', line 25</span>

<span class='def def kw'>def</span> <span class='get_capistrano_release identifier id'>get_capistrano_release</span>
  <span class='full_path identifier id'>full_path</span> <span class='assign token'>=</span> <span class='File constant id'>File</span><span class='dot token'>.</span><span class='expand_path identifier id'>expand_path</span><span class='lparen token'>(</span><span class='File constant id'>File</span><span class='dot token'>.</span><span class='join identifier id'>join</span><span class='lparen token'>(</span><span class='File constant id'>File</span><span class='dot token'>.</span><span class='dirname identifier id'>dirname</span><span class='lparen token'>(</span><span class='__FILE__ __file__ kw'>__FILE__</span><span class='rparen token'>)</span><span class='rparen token'>)</span><span class='rparen token'>)</span>
  <span class='lparen token'>(</span><span class='full_path identifier id'>full_path</span> <span class='match op'>=~</span> <span class='regexp val'>%r{/releases/((\d+){14})/}</span><span class='rparen token'>)</span> <span class='question op'>?</span> <span class='$1 nth_ref id'>$1</span> <span class='colon op'>:</span> <span class='string val'>&quot;Not Available&quot;</span>
<span class='end end kw'>end</span>
</pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <p class="signature " id="iam-instance_method">
  
    - (<tt>Object</tt>) <strong>iam</strong>(ob) 
  

  
</p><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


13
14
15</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File '/Users/fischer/WorkProjects/daitss2/silo-pool/lib/irb-setup.rb', line 13</span>

<span class='def def kw'>def</span> <span class='iam identifier id'>iam</span> <span class='ob identifier id'>ob</span>
  <span class='lparen token'>(</span><span class='ob identifier id'>ob</span><span class='dot token'>.</span><span class='methods identifier id'>methods</span> <span class='minus op'>-</span> <span class='Object constant id'>Object</span><span class='dot token'>.</span><span class='methods identifier id'>methods</span><span class='rparen token'>)</span><span class='dot token'>.</span><span class='sort identifier id'>sort</span>
<span class='end end kw'>end</span>
</pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <p class="signature " id="pluralize_maybe-instance_method">
  
    - (<tt>Object</tt>) <strong>pluralize_maybe</strong>(count, singular, plural = nil) 
  

  
</p><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


79
80
81
82</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File '/Users/fischer/WorkProjects/daitss2/silo-pool/lib/store/fixityutils.rb', line 79</span>

<span class='def def kw'>def</span> <span class='pluralize_maybe identifier id'>pluralize_maybe</span> <span class='count identifier id'>count</span><span class='comma token'>,</span> <span class='singular identifier id'>singular</span><span class='comma token'>,</span> <span class='plural identifier id'>plural</span> <span class='assign token'>=</span> <span class='nil nil kw'>nil</span>
  <span class='plural identifier id'>plural</span> <span class='opasgn op'>||=</span> <span class='singular identifier id'>singular</span> <span class='plus op'>+</span> <span class='string val'>'s'</span>
  <span class='count identifier id'>count</span> <span class='eq op'>==</span> <span class='integer val'>1</span> <span class='question op'>?</span> <span class='singular identifier id'>singular</span> <span class='colon op'>:</span> <span class='plural identifier id'>plural</span>
<span class='end end kw'>end</span>
</pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <p class="signature " id="restore_to_scratch_disk-instance_method">
  
    - (<tt>Object</tt>) <strong>restore_to_scratch_disk</strong>(tape_server, silo, destination_directory) 
  

  
</p><div class="docstring">
  <div class="discussion">
    <p>
restore_to_scratch_disk 
</p>
<p>
restore the daitssfs silo from Tivoli to the scratch disk.
</p>


  </div>
</div>
<div class="tags">
  <h3>Raises:</h3>
<ul class="raise">
  
    <li>
      
        <span class='type'>(<tt><span class='object_link'><a href="Store/FatalFixityError.html" title="Store::FatalFixityError (class)">FatalFixityError</a></span></tt>)</span>
      
      
      
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File '/Users/fischer/WorkProjects/daitss2/silo-pool/lib/store/fixityutils.rb', line 181</span>

<span class='def def kw'>def</span> <span class='restore_to_scratch_disk identifier id'>restore_to_scratch_disk</span> <span class='tape_server identifier id'>tape_server</span><span class='comma token'>,</span> <span class='silo identifier id'>silo</span><span class='comma token'>,</span> <span class='destination_directory identifier id'>destination_directory</span>

  <span class='silo identifier id'>silo</span> <span class='assign token'>=</span> <span class='silo identifier id'>silo</span><span class='dot token'>.</span><span class='gsub identifier id'>gsub</span><span class='lparen token'>(</span><span class='regexp val'>%r{/+$}</span><span class='comma token'>,</span> <span class='string val'>''</span><span class='rparen token'>)</span> <span class='plus op'>+</span> <span class='string val'>'/'</span>
  <span class='destination_directory identifier id'>destination_directory</span> <span class='assign token'>=</span> <span class='destination_directory identifier id'>destination_directory</span><span class='dot token'>.</span><span class='gsub identifier id'>gsub</span><span class='lparen token'>(</span><span class='regexp val'>%r{/+$}</span><span class='comma token'>,</span> <span class='string val'>''</span><span class='rparen token'>)</span> <span class='plus op'>+</span> <span class='string val'>'/'</span>

  <span class='Logger constant id'>Logger</span><span class='dot token'>.</span><span class='info identifier id'>info</span> <span class='dstring node'>&quot;Restoring silo #{silo} from tape to scratch disk #{destination_directory}.&quot;</span>

  <span class='tsm identifier id'>tsm</span> <span class='assign token'>=</span> <span class='Store constant id'>Store</span><span class='colon2 op'>::</span><span class='TsmExecutor constant id'>TsmExecutor</span><span class='dot token'>.</span><span class='new identifier id'>new</span><span class='lparen token'>(</span><span class='tape_server identifier id'>tape_server</span><span class='rparen token'>)</span>
  <span class='tsm identifier id'>tsm</span><span class='dot token'>.</span><span class='restore identifier id'>restore</span><span class='lparen token'>(</span><span class='silo identifier id'>silo</span><span class='comma token'>,</span> <span class='destination_directory identifier id'>destination_directory</span><span class='comma token'>,</span> <span class='integer val'>16</span> <span class='mult op'>*</span> <span class='integer val'>60</span> <span class='mult op'>*</span> <span class='integer val'>60</span><span class='rparen token'>)</span>   <span class='comment val'># Sixteen hours to restore - twice the expected time</span>

  <span class='if if kw'>if</span> <span class='tsm identifier id'>tsm</span><span class='dot token'>.</span><span class='status identifier id'>status</span> <span class='gt op'>&gt;</span> <span class='integer val'>4</span>
    <span class='Logger constant id'>Logger</span><span class='dot token'>.</span><span class='err identifier id'>err</span> <span class='dstring node'>&quot;Command '#{tsm.command}', exited with status #{tsm.status}&quot;</span>
    <span class='if if kw'>if</span> <span class='not not kw'>not</span> <span class='tsm identifier id'>tsm</span><span class='dot token'>.</span><span class='errors identifier id'>errors</span><span class='dot token'>.</span><span class='empty? fid id'>empty?</span>
      <span class='Logger constant id'>Logger</span><span class='dot token'>.</span><span class='err identifier id'>err</span> <span class='string val'>&quot;Tivoli error log follows:&quot;</span>
      <span class='tsm identifier id'>tsm</span><span class='dot token'>.</span><span class='errors identifier id'>errors</span><span class='dot token'>.</span><span class='each identifier id'>each</span> <span class='lbrace token'>{</span> <span class='bitor op'>|</span><span class='line identifier id'>line</span><span class='bitor op'>|</span> <span class='Logger constant id'>Logger</span><span class='dot token'>.</span><span class='err identifier id'>err</span> <span class='line identifier id'>line</span><span class='dot token'>.</span><span class='chomp identifier id'>chomp</span> <span class='rbrace token'>}</span>
    <span class='end end kw'>end</span>
    <span class='if if kw'>if</span> <span class='not not kw'>not</span> <span class='tsm identifier id'>tsm</span><span class='dot token'>.</span><span class='output identifier id'>output</span><span class='dot token'>.</span><span class='empty? fid id'>empty?</span>
      <span class='Logger constant id'>Logger</span><span class='dot token'>.</span><span class='err identifier id'>err</span> <span class='string val'>&quot;Tivoli output log follows:&quot;</span>
      <span class='tsm identifier id'>tsm</span><span class='dot token'>.</span><span class='output identifier id'>output</span><span class='dot token'>.</span><span class='each identifier id'>each</span> <span class='lbrace token'>{</span> <span class='bitor op'>|</span><span class='line identifier id'>line</span><span class='bitor op'>|</span> <span class='Logger constant id'>Logger</span><span class='dot token'>.</span><span class='err identifier id'>err</span> <span class='line identifier id'>line</span><span class='dot token'>.</span><span class='chomp identifier id'>chomp</span> <span class='rbrace token'>}</span>
    <span class='end end kw'>end</span>
    <span class='raise identifier id'>raise</span> <span class='string val'>&quot;fatal tivloi error&quot;</span>
  <span class='end end kw'>end</span>
  
<span class='rescue rescue kw'>rescue</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='e identifier id'>e</span>
  <span class='raise identifier id'>raise</span> <span class='FatalFixityError constant id'>FatalFixityError</span><span class='comma token'>,</span> <span class='dstring node'>&quot;Restore failure: #{e}&quot;</span>
<span class='end end kw'>end</span>
</pre>
    </td>
  </tr>
</table>
</div>
    
  </div>

</div>
    
    <div id="footer">
  Generated on Wed Jan 26 13:31:06 2011 by 
  <a href="http://yardoc.org" title="Yay! A Ruby Documentation Tool" target="_parent">yard</a>
  0.6.0 (ruby-1.8.7).
</div>

  </body>
</html>