<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
    <meta name="Content-Type" content="text/html; charset=utf-8" />
<title>Module: PostgresTableMixIn</title>
<link rel="stylesheet" href="css/style.css" type="text/css" media="screen" charset="utf-8" />
<link rel="stylesheet" href="css/common.css" type="text/css" media="screen" charset="utf-8" />

<script type="text/javascript" charset="utf-8">
  relpath = '';
  if (relpath != '') relpath += '/';
</script>
<script type="text/javascript" charset="utf-8" src="js/jquery.js"></script>
<script type="text/javascript" charset="utf-8" src="js/app.js"></script>

  </head>
  <body>
    <script type="text/javascript" charset="utf-8">
      if (window.top.frames.main) document.body.className = 'frames';
    </script>
    
    <div id="header">
      <div id="menu">
  
    <a href="_index.html">Index (P)</a> &raquo; 
    
    
    <span class="title">PostgresTableMixIn</span>
  
  
  <div class="noframes"><span class="title">(</span><a href="." target="_top">no frames</a><span class="title">)</span></div>
</div>

      <div id="search">
  <a id="class_list_link" href="#">Class List</a>
  <a id="method_list_link" href="#">Method List</a>
  <a id ="file_list_link" href="#">File List</a>
</div>

      <div class="clear"></div>
    </div>
    
    <iframe id="search_frame"></iframe>
    
    <div id="content"><h1>Module: PostgresTableMixIn
  
  
  
</h1>

<dl class="box">
  
  
    
  
    
  
  
  
    <dt class="r1 last">Defined in:</dt>
    <dd class="r1 last">/Users/fischer/WorkProjects/daitss2/silo-pool/lib/datyl/tables.rb</dd>
  
</dl>
<div class="clear"></div>

<h2>Overview</h2><div class="docstring">
  <div class="discussion">
    <p>
TableMixIns will have access to dbh, table_name attributes of their
underlying classes.
</p>


  </div>
</div>
<div class="tags">
  
</div>


  
    <h2>
      Instance Method Summary
      <small>(<a href="#" class="summary_toggle">collapse</a>)</small>
    </h2>

    <ul class="summary">
      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#_build_data_dictionary-instance_method" title="#_build_data_dictionary (instance method)">- (Object) <strong>_build_data_dictionary</strong>(table, fields) </a>
    

    
  </span>
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'><p>
In field order, return information.&#8230;
</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#_escape-instance_method" title="#_escape (instance method)">- (Object) <strong>_escape</strong>(string) </a>
    

    
  </span>
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'></div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#_get_fields-instance_method" title="#_get_fields (instance method)">- (Object) <strong>_get_fields</strong>(name_of_table) </a>
    

    
  </span>
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'></div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#_last_insert_id-instance_method" title="#_last_insert_id (instance method)">- (Object) <strong>_last_insert_id</strong> </a>
    

    
  </span>
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'></div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#_modify-instance_method" title="#_modify (instance method)">- (Object) <strong>_modify</strong>(command) </a>
    

    
  </span>
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'><p>
use for update, insert, delete: get a count back of the number of rows
affected.
</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#_query-instance_method" title="#_query (instance method)">- (Object) <strong>_query</strong>(query_string) </a>
    

    
  </span>
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'></div></span>
  
</li>

      
    </ul>
  



  <div id="instance_method_details" class="method_details_list">
    <h2>Instance Method Details</h2>
    
    
      <div class="method_details first">
  <p class="signature first" id="_build_data_dictionary-instance_method">
  
    - (<tt>Object</tt>) <strong>_build_data_dictionary</strong>(table, fields) 
  

  
</p><div class="docstring">
  <div class="discussion">
    <p>
In field order, return information.&#8230;
</p>


  </div>
</div>
<div class="tags">
  
</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218
219
220
221
222
223
224
225
226
227
228
229
230
231
232
233
234
235
236
237
238
239
240
241
242
243
244
245
246
247
248
249
250
251</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File '/Users/fischer/WorkProjects/daitss2/silo-pool/lib/datyl/tables.rb', line 201</span>

<span class='def def kw'>def</span> <span class='_build_data_dictionary identifier id'>_build_data_dictionary</span> <span class='table identifier id'>table</span><span class='comma token'>,</span> <span class='fields identifier id'>fields</span>

<span class='comment val'>#  Example field check for PostgreSQL for silos table; see the comments on the _build_data_dictionary MySQL method</span>
<span class='comment val'>#  for the details on the silos table structure.</span>
<span class='comment val'>#</span>
<span class='comment val'>#    SELECT column_name, column_default, is_nullable, data_type FROM information_schema.columns WHERE table_name = 'silos';</span>
<span class='comment val'>#</span>
<span class='comment val'>#      column_name  |          column_default           | is_nullable |     data_type</span>
<span class='comment val'>#    ---------------+-----------------------------------+-------------+-------------------</span>
<span class='comment val'>#     id            | nextval('silos_id_seq'::regclass) | NO          | integer</span>
<span class='comment val'>#     hostname      |                                   | NO          | character varying</span>
<span class='comment val'>#     filesystem    |                                   | NO          | character varying</span>
<span class='comment val'>#     state         | 'disk_master'::silo_state         | NO          | USER-DEFINED</span>
<span class='comment val'>#     forbid_get    | false                             | NO          | boolean</span>
<span class='comment val'>#     forbid_put    | false                             | NO          | boolean</span>
<span class='comment val'>#     forbid_delete | false                             | NO          | boolean</span>
<span class='comment val'>#     forbid_post   | false                             | NO          | boolean</span>
<span class='comment val'>#     version       | 1                                 | YES         | integer</span>

  <span class='data_dictionary identifier id'>data_dictionary</span> <span class='assign token'>=</span> <span class='lbrace token'>{</span><span class='rbrace token'>}</span>

  <span class='comment val'># note that dbh.query is not the same method as our class's query.</span>

  <span class='res identifier id'>res</span> <span class='assign token'>=</span> <span class='dbh identifier id'>dbh</span><span class='dot token'>.</span><span class='query identifier id'>query</span> <span class='dstring node'>&quot;SELECT column_name, column_default, is_nullable, data_type FROM information_schema.columns WHERE table_name = #{quote(table)}&quot;</span>

  <span class='lparen token'>(</span><span class='integer val'>0</span> <span class='dot2 op'>..</span> <span class='res identifier id'>res</span><span class='dot token'>.</span><span class='num_tuples identifier id'>num_tuples</span> <span class='minus op'>-</span> <span class='integer val'>1</span><span class='rparen token'>)</span><span class='dot token'>.</span><span class='each identifier id'>each</span> <span class='do do kw'>do</span> <span class='bitor op'>|</span><span class='row identifier id'>row</span><span class='bitor op'>|</span>

    <span class='name identifier id'>name</span>        <span class='assign token'>=</span> <span class='res identifier id'>res</span><span class='dot token'>.</span><span class='getvalue identifier id'>getvalue</span><span class='lparen token'>(</span><span class='row identifier id'>row</span><span class='comma token'>,</span> <span class='integer val'>0</span><span class='rparen token'>)</span>
    <span class='nullable identifier id'>nullable</span>    <span class='assign token'>=</span> <span class='res identifier id'>res</span><span class='dot token'>.</span><span class='getvalue identifier id'>getvalue</span><span class='lparen token'>(</span><span class='row identifier id'>row</span><span class='comma token'>,</span> <span class='integer val'>2</span><span class='rparen token'>)</span> <span class='match op'>=~</span> <span class='regexp val'>/YES/i</span>
    <span class='type identifier id'>type</span>        <span class='assign token'>=</span> <span class='res identifier id'>res</span><span class='dot token'>.</span><span class='getvalue identifier id'>getvalue</span><span class='lparen token'>(</span><span class='row identifier id'>row</span><span class='comma token'>,</span> <span class='integer val'>3</span><span class='rparen token'>)</span>

    <span class='data_dictionary identifier id'>data_dictionary</span><span class='lbrack token'>[</span><span class='name identifier id'>name</span><span class='rbrack token'>]</span> <span class='assign token'>=</span> <span class='lbrace token'>{</span><span class='rbrace token'>}</span>

    <span class='data_dictionary identifier id'>data_dictionary</span><span class='lbrack token'>[</span><span class='name identifier id'>name</span><span class='rbrack token'>]</span><span class='lbrack token'>[</span><span class='symbol val'>:name</span><span class='rbrack token'>]</span>             <span class='assign token'>=</span>  <span class='name identifier id'>name</span>

    <span class='data_dictionary identifier id'>data_dictionary</span><span class='lbrack token'>[</span><span class='name identifier id'>name</span><span class='rbrack token'>]</span><span class='lbrack token'>[</span><span class='symbol val'>:integer?</span><span class='rbrack token'>]</span>         <span class='assign token'>=</span>  <span class='case case kw'>case</span> <span class='type identifier id'>type</span>
                                                <span class='when when kw'>when</span> <span class='regexp val'>/boolean/</span><span class='semicolon token'>;</span>          <span class='false false kw'>false</span>
                                                <span class='when when kw'>when</span> <span class='regexp val'>/integer|bigint/i</span><span class='semicolon token'>;</span>  <span class='true true kw'>true</span>
                                                <span class='else else kw'>else</span><span class='semicolon token'>;</span> <span class='false false kw'>false</span>
                                                <span class='end end kw'>end</span>

    <span class='comment val'># casts are done on reading records only. They add significant overhead: don't specify fields you don't need</span>

    <span class='data_dictionary identifier id'>data_dictionary</span><span class='lbrack token'>[</span><span class='name identifier id'>name</span><span class='rbrack token'>]</span><span class='lbrack token'>[</span><span class='symbol val'>:cast</span><span class='rbrack token'>]</span>             <span class='assign token'>=</span>  <span class='case case kw'>case</span> <span class='type identifier id'>type</span>
                                                <span class='when when kw'>when</span> <span class='regexp val'>/boolean/i</span><span class='semicolon token'>;</span>         <span class='lambda identifier id'>lambda</span> <span class='lbrace token'>{</span> <span class='bitor op'>|</span><span class='val identifier id'>val</span><span class='bitor op'>|</span> <span class='val identifier id'>val</span> <span class='match op'>=~</span> <span class='regexp val'>/^f|0/</span> <span class='question op'>?</span> <span class='integer val'>0</span> <span class='colon op'>:</span> <span class='integer val'>1</span> <span class='rbrace token'>}</span>
                                                <span class='when when kw'>when</span> <span class='regexp val'>/integer|bigint/i</span><span class='semicolon token'>;</span>  <span class='lambda identifier id'>lambda</span> <span class='lbrace token'>{</span> <span class='bitor op'>|</span><span class='val identifier id'>val</span><span class='bitor op'>|</span> <span class='val identifier id'>val</span><span class='dot token'>.</span><span class='to_i identifier id'>to_i</span> <span class='rbrace token'>}</span>
                                                <span class='else else kw'>else</span><span class='semicolon token'>;</span> <span class='nil nil kw'>nil</span>
                                                <span class='end end kw'>end</span>
  <span class='end end kw'>end</span>
  <span class='return return kw'>return</span> <span class='fields identifier id'>fields</span><span class='dot token'>.</span><span class='map identifier id'>map</span> <span class='lbrace token'>{</span> <span class='bitor op'>|</span><span class='name identifier id'>name</span><span class='bitor op'>|</span> <span class='data_dictionary identifier id'>data_dictionary</span><span class='lbrack token'>[</span><span class='name identifier id'>name</span><span class='rbrack token'>]</span> <span class='rbrace token'>}</span>  <span class='comment val'># return array of info in field order</span>
<span class='end end kw'>end</span>
</pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <p class="signature " id="_escape-instance_method">
  
    - (<tt>Object</tt>) <strong>_escape</strong>(string) 
  

  
</p><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


163
164
165</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File '/Users/fischer/WorkProjects/daitss2/silo-pool/lib/datyl/tables.rb', line 163</span>

<span class='def def kw'>def</span> <span class='_escape identifier id'>_escape</span> <span class='string identifier id'>string</span>
  <span class='dbh identifier id'>dbh</span><span class='dot token'>.</span><span class='escape identifier id'>escape</span> <span class='string identifier id'>string</span>
<span class='end end kw'>end</span>
</pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <p class="signature " id="_get_fields-instance_method">
  
    - (<tt>Object</tt>) <strong>_get_fields</strong>(name_of_table) 
  

  
</p><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


158
159
160
161</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File '/Users/fischer/WorkProjects/daitss2/silo-pool/lib/datyl/tables.rb', line 158</span>

<span class='def def kw'>def</span> <span class='_get_fields identifier id'>_get_fields</span> <span class='name_of_table identifier id'>name_of_table</span>
  <span class='res identifier id'>res</span> <span class='assign token'>=</span> <span class='dbh identifier id'>dbh</span><span class='dot token'>.</span><span class='query identifier id'>query</span><span class='lparen token'>(</span><span class='dstring node'>&quot;SELECT * FROM #{name_of_table} LIMIT 0&quot;</span><span class='rparen token'>)</span>
  <span class='res identifier id'>res</span><span class='dot token'>.</span><span class='fields identifier id'>fields</span>
<span class='end end kw'>end</span>
</pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <p class="signature " id="_last_insert_id-instance_method">
  
    - (<tt>Object</tt>) <strong>_last_insert_id</strong> 
  

  
</p><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


254
255
256
257
258</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File '/Users/fischer/WorkProjects/daitss2/silo-pool/lib/datyl/tables.rb', line 254</span>

<span class='def def kw'>def</span> <span class='_last_insert_id identifier id'>_last_insert_id</span>
  <span class='res identifier id'>res</span> <span class='assign token'>=</span> <span class='dbh identifier id'>dbh</span><span class='dot token'>.</span><span class='query identifier id'>query</span> <span class='dstring node'>&quot;SELECT currval(#{quote(table_name + '_id_seq')})&quot;</span>
  <span class='return return kw'>return</span> <span class='nil nil kw'>nil</span> <span class='if if_mod kw'>if</span> <span class='res identifier id'>res</span><span class='dot token'>.</span><span class='num_tuples identifier id'>num_tuples</span> <span class='neq op'>!=</span> <span class='integer val'>1</span>
  <span class='res identifier id'>res</span><span class='dot token'>.</span><span class='getvalue identifier id'>getvalue</span><span class='lparen token'>(</span><span class='integer val'>0</span><span class='comma token'>,</span><span class='integer val'>0</span><span class='rparen token'>)</span><span class='dot token'>.</span><span class='to_i identifier id'>to_i</span>
<span class='end end kw'>end</span>
</pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <p class="signature " id="_modify-instance_method">
  
    - (<tt>Object</tt>) <strong>_modify</strong>(command) 
  

  
</p><div class="docstring">
  <div class="discussion">
    <p>
use for update, insert, delete: get a count back of the number of rows
affected
</p>


  </div>
</div>
<div class="tags">
  
</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


192
193
194
195
196</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File '/Users/fischer/WorkProjects/daitss2/silo-pool/lib/datyl/tables.rb', line 192</span>

<span class='def def kw'>def</span> <span class='_modify identifier id'>_modify</span> <span class='command identifier id'>command</span>
<span class='comment val'>####    STDERR.puts &quot;_modify: &quot; + command if DEBUG</span>
  <span class='res identifier id'>res</span> <span class='assign token'>=</span> <span class='dbh identifier id'>dbh</span><span class='dot token'>.</span><span class='query identifier id'>query</span> <span class='command identifier id'>command</span>
  <span class='res identifier id'>res</span><span class='dot token'>.</span><span class='cmd_tuples identifier id'>cmd_tuples</span>
<span class='end end kw'>end</span>
</pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <p class="signature " id="_query-instance_method">
  
    - (<tt>Object</tt>) <strong>_query</strong>(query_string) 
  

  
</p><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File '/Users/fischer/WorkProjects/daitss2/silo-pool/lib/datyl/tables.rb', line 167</span>

<span class='def def kw'>def</span> <span class='_query identifier id'>_query</span> <span class='query_string identifier id'>query_string</span>
<span class='comment val'>####    STDERR.puts &quot;_query: &quot; + query_string if DEBUG</span>

  <span class='res identifier id'>res</span> <span class='assign token'>=</span> <span class='dbh identifier id'>dbh</span><span class='dot token'>.</span><span class='query identifier id'>query</span> <span class='query_string identifier id'>query_string</span>
  <span class='rows identifier id'>rows</span> <span class='assign token'>=</span> <span class='lbrack token'>[</span><span class='rbrack token'>]</span>

  <span class='lparen token'>(</span><span class='integer val'>0</span> <span class='dot2 op'>..</span> <span class='res identifier id'>res</span><span class='dot token'>.</span><span class='num_tuples identifier id'>num_tuples</span> <span class='minus op'>-</span> <span class='integer val'>1</span><span class='rparen token'>)</span><span class='dot token'>.</span><span class='each identifier id'>each</span> <span class='do do kw'>do</span> <span class='bitor op'>|</span><span class='row_number identifier id'>row_number</span><span class='bitor op'>|</span>
    <span class='row identifier id'>row</span> <span class='assign token'>=</span> <span class='lbrack token'>[</span><span class='rbrack token'>]</span>
    <span class='lparen token'>(</span><span class='integer val'>0</span> <span class='dot2 op'>..</span> <span class='res identifier id'>res</span><span class='dot token'>.</span><span class='num_fields identifier id'>num_fields</span> <span class='minus op'>-</span> <span class='integer val'>1</span><span class='rparen token'>)</span><span class='dot token'>.</span><span class='each identifier id'>each</span> <span class='do do kw'>do</span> <span class='bitor op'>|</span><span class='col_number identifier id'>col_number</span><span class='bitor op'>|</span>
      <span class='row identifier id'>row</span><span class='dot token'>.</span><span class='push identifier id'>push</span> <span class='res identifier id'>res</span><span class='dot token'>.</span><span class='getvalue identifier id'>getvalue</span><span class='lparen token'>(</span><span class='row_number identifier id'>row_number</span><span class='comma token'>,</span> <span class='col_number identifier id'>col_number</span><span class='rparen token'>)</span>
    <span class='end end kw'>end</span>
    <span class='if if kw'>if</span> <span class='block_given? fid id'>block_given?</span>
      <span class='yield yield kw'>yield</span> <span class='row identifier id'>row</span>
    <span class='else else kw'>else</span>
      <span class='rows identifier id'>rows</span><span class='dot token'>.</span><span class='push identifier id'>push</span> <span class='row identifier id'>row</span>
    <span class='end end kw'>end</span>
  <span class='end end kw'>end</span>

  <span class='return return kw'>return</span> <span class='rows identifier id'>rows</span> <span class='unless unless_mod kw'>unless</span> <span class='block_given? fid id'>block_given?</span>
<span class='ensure ensure kw'>ensure</span>
  <span class='res identifier id'>res</span><span class='dot token'>.</span><span class='clear identifier id'>clear</span>
<span class='end end kw'>end</span>
</pre>
    </td>
  </tr>
</table>
</div>
    
  </div>

</div>
    
    <div id="footer">
  Generated on Thu May 12 23:42:24 2011 by 
  <a href="http://yardoc.org" title="Yay! A Ruby Documentation Tool" target="_parent">yard</a>
  0.6.0 (ruby-1.8.7).
</div>

  </body>
</html>