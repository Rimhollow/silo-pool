<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
    <meta name="Content-Type" content="text/html; charset=utf-8" />
<title>Module: MySqlTableMixIn</title>
<link rel="stylesheet" href="css/style.css" type="text/css" media="screen" charset="utf-8" />
<link rel="stylesheet" href="css/common.css" type="text/css" media="screen" charset="utf-8" />

<script type="text/javascript" charset="utf-8">
  relpath = '';
  if (relpath != '') relpath += '/';
</script>
<script type="text/javascript" charset="utf-8" src="js/jquery.js"></script>
<script type="text/javascript" charset="utf-8" src="js/app.js"></script>

  </head>
  <body>
    <script type="text/javascript" charset="utf-8">
      if (window.top.frames.main) document.body.className = 'frames';
    </script>
    
    <div id="header">
      <div id="menu">
  
    <a href="_index.html">Index (M)</a> &raquo; 
    
    
    <span class="title">MySqlTableMixIn</span>
  
  
  <div class="noframes"><span class="title">(</span><a href="." target="_top">no frames</a><span class="title">)</span></div>
</div>

      <div id="search">
  <a id="class_list_link" href="#">Class List</a>
  <a id="method_list_link" href="#">Method List</a>
  <a id ="file_list_link" href="#">File List</a>
</div>

      <div class="clear"></div>
    </div>
    
    <iframe id="search_frame"></iframe>
    
    <div id="content"><h1>Module: MySqlTableMixIn
  
  
  
</h1>

<dl class="box">
  
  
    
  
    
  
  
  
    <dt class="r1 last">Defined in:</dt>
    <dd class="r1 last">/Users/fischer/WorkProjects/daitss2/silo-pool/lib/datyl/tables.rb</dd>
  
</dl>
<div class="clear"></div>

<h2>Defined Under Namespace</h2>
<p class="children">
   
    
   
    
      <strong class="classes">Classes:</strong> <span class='object_link'><a href="MySqlTableMixIn/EquiJoinTable.html" title="MySqlTableMixIn::EquiJoinTable (class)">EquiJoinTable</a></span>, <span class='object_link'><a href="MySqlTableMixIn/HistoriesTable.html" title="MySqlTableMixIn::HistoriesTable (class)">HistoriesTable</a></span>, <span class='object_link'><a href="MySqlTableMixIn/PackagesTable.html" title="MySqlTableMixIn::PackagesTable (class)">PackagesTable</a></span>, <span class='object_link'><a href="MySqlTableMixIn/SiloLogsTable.html" title="MySqlTableMixIn::SiloLogsTable (class)">SiloLogsTable</a></span>, <span class='object_link'><a href="MySqlTableMixIn/SiloPackagesTable.html" title="MySqlTableMixIn::SiloPackagesTable (class)">SiloPackagesTable</a></span>, <span class='object_link'><a href="MySqlTableMixIn/SilosTable.html" title="MySqlTableMixIn::SilosTable (class)">SilosTable</a></span>, <span class='object_link'><a href="MySqlTableMixIn/Table.html" title="MySqlTableMixIn::Table (class)">Table</a></span>
    
  
</p>



  
    <h2>
      Instance Method Summary
      <small>(<a href="#" class="summary_toggle">collapse</a>)</small>
    </h2>

    <ul class="summary">
      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#_escape-instance_method" title="#_escape (instance method)">- (Object) <strong>_escape</strong>(string) </a>
    

    
  </span>
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'></div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#_get_fields-instance_method" title="#_get_fields (instance method)">- (Object) <strong>_get_fields</strong>(name_of_table) </a>
    

    
  </span>
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'></div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#_query-instance_method" title="#_query (instance method)">- (Object) <strong>_query</strong>(query_string) </a>
    

    
  </span>
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'></div></span>
  
</li>

      
    </ul>
  



  <div id="instance_method_details" class="method_details_list">
    <h2>Instance Method Details</h2>
    
    
      <div class="method_details first">
  <p class="signature first" id="_escape-instance_method">
  
    - (<tt>Object</tt>) <strong>_escape</strong>(string) 
  

  
</p><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


263
264
265</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File '/Users/fischer/WorkProjects/daitss2/silo-pool/lib/datyl/tables.rb', line 263</span>

<span class='def def kw'>def</span> <span class='_escape identifier id'>_escape</span> <span class='string identifier id'>string</span>
  <span class='dbh identifier id'>dbh</span><span class='dot token'>.</span><span class='escape_string identifier id'>escape_string</span> <span class='string identifier id'>string</span>
<span class='end end kw'>end</span>
</pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <p class="signature " id="_get_fields-instance_method">
  
    - (<tt>Object</tt>) <strong>_get_fields</strong>(name_of_table) 
  

  
</p><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


267
268
269</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File '/Users/fischer/WorkProjects/daitss2/silo-pool/lib/datyl/tables.rb', line 267</span>

<span class='def def kw'>def</span> <span class='_get_fields identifier id'>_get_fields</span> <span class='name_of_table identifier id'>name_of_table</span>
  <span class='dbh identifier id'>dbh</span><span class='dot token'>.</span><span class='list_fields identifier id'>list_fields</span><span class='lparen token'>(</span><span class='name_of_table identifier id'>name_of_table</span><span class='rparen token'>)</span><span class='dot token'>.</span><span class='fetch_fields identifier id'>fetch_fields</span><span class='dot token'>.</span><span class='map identifier id'>map</span> <span class='lbrace token'>{</span> <span class='bitor op'>|</span><span class='f identifier id'>f</span><span class='bitor op'>|</span> <span class='f identifier id'>f</span><span class='dot token'>.</span><span class='name identifier id'>name</span> <span class='rbrace token'>}</span>
<span class='end end kw'>end</span>
</pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <p class="signature " id="_query-instance_method">
  
    - (<tt>Object</tt>) <strong>_query</strong>(query_string) 
  

  
</p><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


271
272
273
274
275
276
277
278
279
280
281
282
283
284
285
286
287
288
289
290
291
292
293
294
295
296
297
298
299
300
301
302
303
304
305
306
307
308
309
310
311
312
313
314
315
316
317
318
319
320
321
322
323
324
325
326
327
328
329
330
331
332
333
334
335
336
337
338
339
340
341
342
343
344
345
346
347
348
349
350
351
352
353
354
355
356
357
358
359
360
361
362
363
364
365
366
367
368
369
370
371
372
373
374
375
376
377
378
379
380
381
382
383
384
385
386
387
388
389
390
391
392
393
394
395
396
397
398
399
400
401
402
403
404
405
406
407
408
409
410
411
412
413
414
415
416
417
418
419
420
421
422
423
424
425
426
427
428
429
430
431
432
433
434
435
436
437
438
439
440
441
442
443
444
445
446
447
448
449
450
451
452
453
454
455
456
457
458
459
460
461
462
463
464
465
466
467
468
469
470
471
472
473
474
475
476
477
478
479
480
481
482
483
484
485
486
487
488
489
490
491
492
493
494
495
496
497
498
499
500
501
502
503
504
505
506
507
508
509
510
511
512
513
514
515
516
517
518
519
520
521
522
523
524
525
526
527
528
529
530
531
532
533
534
535
536
537
538
539
540
541
542
543
544
545
546
547
548
549
550
551
552
553
554
555
556
557
558
559
560
561
562
563
564
565
566
567
568
569
570
571
572
573
574
575
576
577
578
579
580
581
582
583
584
585
586
587
588
589
590
591
592
593
594
595
596
597
598
599
600
601
602
603
604
605
606
607
608
609
610
611
612
613
614
615
616
617
618
619
620
621
622
623
624
625
626
627
628
629
630
631
632
633
634
635
636
637
638
639
640
641
642
643
644
645
646
647
648
649
650
651
652
653
654
655
656
657
658
659
660
661
662
663
664
665
666
667
668
669
670
671
672
673
674
675
676
677
678
679
680
681
682
683
684</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File '/Users/fischer/WorkProjects/daitss2/silo-pool/lib/datyl/tables.rb', line 271</span>

<span class='def def kw'>def</span> <span class='_query identifier id'>_query</span> <span class='query_string identifier id'>query_string</span>

<span class='comment val'>####    STDERR.puts &quot;_query: &quot; + query_string  if DEBUG</span>

    <span class='dbh identifier id'>dbh</span><span class='dot token'>.</span><span class='query_with_result identifier id'>query_with_result</span> <span class='assign token'>=</span> <span class='false false kw'>false</span>    <span class='comment val'># Huh. May need to record this and reset it in ensure block</span>
    <span class='dbh identifier id'>dbh</span><span class='dot token'>.</span><span class='query identifier id'>query</span> <span class='query_string identifier id'>query_string</span>
    <span class='res identifier id'>res</span> <span class='assign token'>=</span> <span class='dbh identifier id'>dbh</span><span class='dot token'>.</span><span class='use_result identifier id'>use_result</span>

    <span class='if if kw'>if</span> <span class='block_given? fid id'>block_given?</span>
      <span class='while while kw'>while</span> <span class='cols identifier id'>cols</span> <span class='assign token'>=</span> <span class='res identifier id'>res</span><span class='dot token'>.</span><span class='fetch_row identifier id'>fetch_row</span> <span class='do do kw'>do</span>
        <span class='yield yield kw'>yield</span> <span class='cols identifier id'>cols</span>
      <span class='end end kw'>end</span>
    <span class='else else kw'>else</span>
      <span class='list identifier id'>list</span> <span class='assign token'>=</span> <span class='lbrack token'>[</span><span class='rbrack token'>]</span>
      <span class='while while kw'>while</span> <span class='cols identifier id'>cols</span> <span class='assign token'>=</span> <span class='res identifier id'>res</span><span class='dot token'>.</span><span class='fetch_row identifier id'>fetch_row</span> <span class='do do kw'>do</span>
        <span class='list identifier id'>list</span><span class='dot token'>.</span><span class='push identifier id'>push</span> <span class='cols identifier id'>cols</span>
      <span class='end end kw'>end</span>
      <span class='list identifier id'>list</span>
    <span class='end end kw'>end</span>
    <span class='comment val'># TODO: clear res in ensure blcok</span>
  <span class='end end kw'>end</span>

  <span class='def def kw'>def</span> <span class='_modify identifier id'>_modify</span> <span class='command identifier id'>command</span>
<span class='comment val'>####    STDERR.puts &quot;_modify: &quot; + command  if DEBUG</span>
    <span class='st identifier id'>st</span>  <span class='assign token'>=</span> <span class='dbh identifier id'>dbh</span><span class='dot token'>.</span><span class='prepare identifier id'>prepare</span> <span class='command identifier id'>command</span>
    <span class='st identifier id'>st</span><span class='dot token'>.</span><span class='execute identifier id'>execute</span>
    <span class='st identifier id'>st</span><span class='dot token'>.</span><span class='affected_rows identifier id'>affected_rows</span>
  <span class='ensure ensure kw'>ensure</span>
    <span class='st identifier id'>st</span><span class='dot token'>.</span><span class='close identifier id'>close</span> <span class='if if_mod kw'>if</span> <span class='st identifier id'>st</span><span class='dot token'>.</span><span class='respond_to? fid id'>respond_to?</span> <span class='symbol val'>:close</span>
  <span class='end end kw'>end</span>

  <span class='comment val'># we Might need explicit table_name TABLE here to support joined tables.</span>

  <span class='def def kw'>def</span> <span class='_build_data_dictionary identifier id'>_build_data_dictionary</span> <span class='table identifier id'>table</span><span class='comma token'>,</span> <span class='fields identifier id'>fields</span>

    <span class='comment val'># MySQL provides a field object, these are some of the Mysql::Field methods output for the Silos table:</span>
    <span class='comment val'>#</span>
    <span class='comment val'>#  field object           decimals         def  flags is_not_null?  is_num? is_pri_key? length max_length table name</span>
    <span class='comment val'>#  ------------           --------         ---  ----- ------------  ------- ----------- ------ ---------- ----- ----</span>
    <span class='comment val'>#  &lt;Mysql::Field:id&gt;:            0           0  49699         true     true        true     10          0 silos id</span>
    <span class='comment val'>#  &lt;Mysql::Field:hostname&gt;:      0         nil  20489         true    false       false    127          0 silos hostname</span>
    <span class='comment val'>#  &lt;Mysql::Field:filesystem&gt;:    0         nil  20489         true    false       false    255          0 silos filesystem</span>
    <span class='comment val'>#  &lt;Mysql::Field:state&gt;:         0 disk_master  16649         true    false       false     11          0 silos state</span>
    <span class='comment val'>#  &lt;Mysql::Field:forbid_get&gt;:    0           0  32769         true     true       false      1          0 silos get</span>
    <span class='comment val'>#  &lt;Mysql::Field:forbid_put&gt;:    0           0  32769         true     true       false      1          0 silos put</span>
    <span class='comment val'>#  &lt;Mysql::Field:forbid_delete&gt;: 0           0  32769         true     true       false      1          0 silos delete</span>
    <span class='comment val'>#  &lt;Mysql::Field:forbid_post&gt;:   0           0  32769         true     true       false      1          0 silos post</span>
    <span class='comment val'>#  &lt;Mysql::Field:version&gt;:       0           1  49161         true     true       false     11          0 silos version</span>
    <span class='comment val'>#</span>
    <span class='comment val'># The silos table was defined as below when the above docs where</span>
    <span class='comment val'># generated (note that this definition is just for illustration of</span>
    <span class='comment val'># this method - the actual DDL for the silos table will probably</span>
    <span class='comment val'># drift from the below slightly)</span>
    <span class='comment val'>#</span>
    <span class='comment val'>#   id integer unsigned not null AUTO_INCREMENT,</span>
    <span class='comment val'>#   hostname       varchar(127) not null,</span>
    <span class='comment val'>#   filesystem     varchar(255) not null,</span>
    <span class='comment val'>#   state          enum('disk_master', 'disk_idling', 'disk_copied', 'tape_master')  default 'disk_master' not null,</span>
    <span class='comment val'>#   forbid_get     boolean    default false not null,</span>
    <span class='comment val'>#   forbid_put     boolean    default false not null,</span>
    <span class='comment val'>#   forbid_delete  boolean    default false not null,</span>
    <span class='comment val'>#   forbid_post    boolean    default false not null,</span>
    <span class='comment val'>#   version        integer    default 1 not null,</span>
    <span class='comment val'>#   primary key (id),</span>
    <span class='comment val'>#   unique (hostname, filesystem),</span>
    <span class='comment val'>#</span>

    <span class='records_by_field_name identifier id'>records_by_field_name</span> <span class='assign token'>=</span> <span class='lbrace token'>{</span><span class='rbrace token'>}</span>

    <span class='dbh identifier id'>dbh</span><span class='dot token'>.</span><span class='list_fields identifier id'>list_fields</span><span class='lparen token'>(</span><span class='table identifier id'>table</span><span class='rparen token'>)</span><span class='dot token'>.</span><span class='fetch_fields identifier id'>fetch_fields</span><span class='dot token'>.</span><span class='each identifier id'>each</span> <span class='do do kw'>do</span> <span class='bitor op'>|</span><span class='field identifier id'>field</span><span class='bitor op'>|</span>
      <span class='rec identifier id'>rec</span> <span class='assign token'>=</span> <span class='lbrace token'>{</span><span class='rbrace token'>}</span>
      <span class='rec identifier id'>rec</span><span class='lbrack token'>[</span><span class='symbol val'>:name</span><span class='rbrack token'>]</span>             <span class='assign token'>=</span> <span class='field identifier id'>field</span><span class='dot token'>.</span><span class='name identifier id'>name</span>
      <span class='rec identifier id'>rec</span><span class='lbrack token'>[</span><span class='symbol val'>:integer?</span><span class='rbrack token'>]</span>         <span class='assign token'>=</span> <span class='field identifier id'>field</span><span class='dot token'>.</span><span class='is_num? fid id'>is_num?</span>
      <span class='rec identifier id'>rec</span><span class='lbrack token'>[</span><span class='symbol val'>:cast</span><span class='rbrack token'>]</span>             <span class='assign token'>=</span> <span class='field identifier id'>field</span><span class='dot token'>.</span><span class='is_num? fid id'>is_num?</span> <span class='integer val'>? </span><span class='lambda identifier id'>lambda</span> <span class='lbrace token'>{</span> <span class='bitor op'>|</span><span class='val identifier id'>val</span><span class='bitor op'>|</span> <span class='val identifier id'>val</span><span class='dot token'>.</span><span class='to_i identifier id'>to_i</span> <span class='rbrace token'>}</span> <span class='colon op'>:</span> <span class='nil nil kw'>nil</span>
      
      <span class='records_by_field_name identifier id'>records_by_field_name</span><span class='lbrack token'>[</span><span class='field identifier id'>field</span><span class='dot token'>.</span><span class='name identifier id'>name</span><span class='rbrack token'>]</span> <span class='assign token'>=</span> <span class='rec identifier id'>rec</span>
    <span class='end end kw'>end</span>

    <span class='data_dictionary identifier id'>data_dictionary</span> <span class='assign token'>=</span> <span class='fields identifier id'>fields</span><span class='dot token'>.</span><span class='map identifier id'>map</span> <span class='lbrace token'>{</span> <span class='bitor op'>|</span><span class='fn identifier id'>fn</span><span class='bitor op'>|</span> <span class='records_by_field_name identifier id'>records_by_field_name</span><span class='lbrack token'>[</span><span class='fn identifier id'>fn</span><span class='rbrack token'>]</span> <span class='rbrace token'>}</span>

    <span class='return return kw'>return</span> <span class='data_dictionary identifier id'>data_dictionary</span>
  <span class='end end kw'>end</span>

  <span class='def def kw'>def</span> <span class='_last_insert_id identifier id'>_last_insert_id</span>
    <span class='dbh identifier id'>dbh</span><span class='dot token'>.</span><span class='insert_id identifier id'>insert_id</span>
  <span class='end end kw'>end</span>
<span class='end end kw'>end</span>


<span class='class class kw'>class</span> <span class='Table constant id'>Table</span>

  <span class='attr_reader identifier id'>attr_reader</span>   <span class='symbol val'>:table_name</span><span class='comma token'>,</span> <span class='symbol val'>:dbh</span><span class='comma token'>,</span> <span class='symbol val'>:record_constructor</span><span class='comma token'>,</span> <span class='symbol val'>:fields</span><span class='comma token'>,</span> <span class='symbol val'>:data_dictionary</span>

  <span class='def def kw'>def</span> <span class='initialize identifier id'>initialize</span> <span class='connection identifier id'>connection</span><span class='comma token'>,</span> <span class='table_name identifier id'>table_name</span><span class='comma token'>,</span> <span class='mult op'>*</span><span class='fields identifier id'>fields</span>

    <span class='@dbh ivar id'>@dbh</span>  <span class='assign token'>=</span> <span class='connection identifier id'>connection</span><span class='dot token'>.</span><span class='dbh identifier id'>dbh</span>
    <span class='@table_name ivar id'>@table_name</span>  <span class='assign token'>=</span> <span class='table_name identifier id'>table_name</span>

    <span class='comment val'># bring in _quote, _query and _fields, transact block, etc, etc</span>

    <span class='case case kw'>case</span> <span class='connection identifier id'>connection</span><span class='dot token'>.</span><span class='vendor identifier id'>vendor</span>
    <span class='when when kw'>when</span> <span class='string val'>'postgres'</span>
      <span class='extend identifier id'>extend</span> <span class='PostgresTableMixIn constant id'>PostgresTableMixIn</span>
    <span class='when when kw'>when</span> <span class='string val'>'mysql'</span>
      <span class='extend identifier id'>extend</span> <span class='MySqlTableMixIn constant id'>MySqlTableMixIn</span>
    <span class='else else kw'>else</span>
      <span class='raise identifier id'>raise</span> <span class='Store constant id'>Store</span><span class='colon2 op'>::</span><span class='ConfigurationError constant id'>ConfigurationError</span><span class='comma token'>,</span> <span class='dstring node'>&quot;Unsupported database #{connection.vendor}. Supported databases: 'mysql', 'postgres'.&quot;</span>
    <span class='end end kw'>end</span>

    <span class='if if kw'>if</span> <span class='fields identifier id'>fields</span><span class='dot token'>.</span><span class='empty? fid id'>empty?</span>
      <span class='@fields ivar id'>@fields</span> <span class='assign token'>=</span> <span class='_get_fields identifier id'>_get_fields</span><span class='lparen token'>(</span><span class='@table_name ivar id'>@table_name</span><span class='rparen token'>)</span>
    <span class='else else kw'>else</span>
      <span class='@fields ivar id'>@fields</span> <span class='assign token'>=</span> <span class='fields identifier id'>fields</span><span class='dot token'>.</span><span class='map identifier id'>map</span> <span class='lbrace token'>{</span> <span class='bitor op'>|</span><span class='f identifier id'>f</span><span class='bitor op'>|</span> <span class='f identifier id'>f</span><span class='dot token'>.</span><span class='to_s identifier id'>to_s</span> <span class='rbrace token'>}</span>
    <span class='end end kw'>end</span>

    <span class='@fields ivar id'>@fields</span><span class='dot token'>.</span><span class='unshift identifier id'>unshift</span> <span class='string val'>'version'</span> <span class='unless unless_mod kw'>unless</span> <span class='@fields ivar id'>@fields</span><span class='dot token'>.</span><span class='include? fid id'>include?</span> <span class='string val'>'version'</span>   <span class='comment val'># we always need these</span>
    <span class='@fields ivar id'>@fields</span><span class='dot token'>.</span><span class='unshift identifier id'>unshift</span> <span class='string val'>'id'</span>      <span class='unless unless_mod kw'>unless</span> <span class='@fields ivar id'>@fields</span><span class='dot token'>.</span><span class='include? fid id'>include?</span> <span class='string val'>'id'</span>

    <span class='struct_name identifier id'>struct_name</span> <span class='assign token'>=</span> <span class='connection identifier id'>connection</span><span class='dot token'>.</span><span class='vendor identifier id'>vendor</span><span class='dot token'>.</span><span class='capitalize identifier id'>capitalize</span> <span class='plus op'>+</span> <span class='string val'>'_'</span> <span class='plus op'>+</span> <span class='ConnectionId constant id'>ConnectionId</span><span class='dot token'>.</span><span class='next identifier id'>next</span><span class='dot token'>.</span><span class='to_s identifier id'>to_s</span> <span class='plus op'>+</span> <span class='string val'>'_'</span> <span class='plus op'>+</span> <span class='table_name identifier id'>table_name</span><span class='dot token'>.</span><span class='capitalize identifier id'>capitalize</span>

    <span class='@record_constructor ivar id'>@record_constructor</span> <span class='assign token'>=</span> <span class='Struct constant id'>Struct</span><span class='dot token'>.</span><span class='new identifier id'>new</span><span class='lparen token'>(</span><span class='struct_name identifier id'>struct_name</span><span class='comma token'>,</span> <span class='mult op'>*</span><span class='lparen token'>(</span><span class='@fields ivar id'>@fields</span><span class='dot token'>.</span><span class='map identifier id'>map</span><span class='lbrace token'>{</span> <span class='bitor op'>|</span><span class='f identifier id'>f</span><span class='bitor op'>|</span> <span class='f identifier id'>f</span><span class='dot token'>.</span><span class='gsub identifier id'>gsub</span><span class='lparen token'>(</span><span class='string val'>'.'</span><span class='comma token'>,</span> <span class='string val'>'_'</span><span class='rparen token'>)</span><span class='rbrace token'>}</span><span class='rparen token'>)</span><span class='rparen token'>)</span>
    <span class='@data_dictionary ivar id'>@data_dictionary</span>    <span class='assign token'>=</span> <span class='_build_data_dictionary identifier id'>_build_data_dictionary</span> <span class='table_name identifier id'>table_name</span><span class='comma token'>,</span> <span class='@fields ivar id'>@fields</span>

    <span class='comment val'># Ensure our connection works up front</span>

    <span class='begin begin kw'>begin</span>
      <span class='raise identifier id'>raise</span> <span class='Store constant id'>Store</span><span class='colon2 op'>::</span><span class='ConfigurationError constant id'>ConfigurationError</span><span class='comma token'>,</span> <span class='dstring node'>&quot;Can't connect to #{vendor} database #{database}&quot;</span> <span class='unless unless_mod kw'>unless</span> <span class='lparen token'>(</span><span class='_query identifier id'>_query</span><span class='lparen token'>(</span><span class='string val'>&quot;SELECT 1+1&quot;</span><span class='rparen token'>)</span><span class='dot token'>.</span><span class='flatten identifier id'>flatten</span><span class='dot token'>.</span><span class='pop identifier id'>pop</span><span class='dot token'>.</span><span class='to_i identifier id'>to_i</span> <span class='eq op'>==</span> <span class='integer val'>2</span><span class='rparen token'>)</span>
    <span class='rescue rescue kw'>rescue</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='e identifier id'>e</span>
      <span class='raise identifier id'>raise</span> <span class='Store constant id'>Store</span><span class='colon2 op'>::</span><span class='ConfigurationError constant id'>ConfigurationError</span><span class='comma token'>,</span> <span class='e identifier id'>e</span><span class='dot token'>.</span><span class='message identifier id'>message</span>
    <span class='end end kw'>end</span>

  <span class='end end kw'>end</span>

  <span class='comment val'># Return an empty record for an insert. Beware setting the ID - most always you'll want to leave it empty.</span>
  <span class='comment val'># Most fields default to :undefined and will not be used in an update or insert.  Set what you need to.</span>

  <span class='def def kw'>def</span> <span class='new_record identifier id'>new_record</span>
    <span class='rec identifier id'>rec</span> <span class='assign token'>=</span><span class='@record_constructor ivar id'>@record_constructor</span><span class='dot token'>.</span><span class='new identifier id'>new</span>
    <span class='rec identifier id'>rec</span><span class='dot token'>.</span><span class='members identifier id'>members</span><span class='dot token'>.</span><span class='each identifier id'>each</span> <span class='lbrace token'>{</span> <span class='bitor op'>|</span><span class='field identifier id'>field</span><span class='bitor op'>|</span> <span class='rec identifier id'>rec</span><span class='lbrack token'>[</span><span class='field identifier id'>field</span><span class='rbrack token'>]</span> <span class='assign token'>=</span> <span class='symbol val'>:undefined</span> <span class='rbrace token'>}</span>
    <span class='rec identifier id'>rec</span>
  <span class='end end kw'>end</span>

  <span class='def def kw'>def</span> <span class='select identifier id'>select</span> <span class='where identifier id'>where</span> <span class='assign token'>=</span> <span class='nil nil kw'>nil</span><span class='comma token'>,</span> <span class='order identifier id'>order</span> <span class='assign token'>=</span> <span class='nil nil kw'>nil</span><span class='comma token'>,</span> <span class='limit identifier id'>limit</span> <span class='assign token'>=</span> <span class='nil nil kw'>nil</span>

    <span class='procs identifier id'>procs</span> <span class='assign token'>=</span> <span class='data_dictionary identifier id'>data_dictionary</span><span class='dot token'>.</span><span class='map identifier id'>map</span> <span class='lbrace token'>{</span> <span class='bitor op'>|</span><span class='rec identifier id'>rec</span><span class='bitor op'>|</span> <span class='rec identifier id'>rec</span><span class='lbrack token'>[</span><span class='symbol val'>:cast</span><span class='rbrack token'>]</span> <span class='rbrace token'>}</span>         <span class='comment val'># array of cast procs or nils, in field order.</span>
    <span class='needs_cast identifier id'>needs_cast</span> <span class='assign token'>=</span> <span class='lbrack token'>[</span><span class='rbrack token'>]</span>
    <span class='procs identifier id'>procs</span><span class='dot token'>.</span><span class='each_index identifier id'>each_index</span> <span class='lbrace token'>{</span> <span class='bitor op'>|</span><span class='i identifier id'>i</span><span class='bitor op'>|</span> <span class='needs_cast identifier id'>needs_cast</span><span class='dot token'>.</span><span class='push identifier id'>push</span><span class='lparen token'>(</span><span class='i identifier id'>i</span><span class='rparen token'>)</span> <span class='if if_mod kw'>if</span> <span class='procs identifier id'>procs</span><span class='lbrack token'>[</span><span class='i identifier id'>i</span><span class='rbrack token'>]</span> <span class='rbrace token'>}</span>  <span class='comment val'># column indexes of procs from above we'll need to apply.</span>

    <span class='sql identifier id'>sql</span> <span class='assign token'>=</span>  <span class='dstring node'>&quot;SELECT #{fields.join(', ')} FROM #{table_name}&quot;</span> <span class='plus op'>+</span> <span class='clauses identifier id'>clauses</span><span class='lparen token'>(</span><span class='where identifier id'>where</span><span class='comma token'>,</span> <span class='order identifier id'>order</span><span class='comma token'>,</span> <span class='limit identifier id'>limit</span><span class='rparen token'>)</span>

    <span class='if if kw'>if</span> <span class='block_given? fid id'>block_given?</span>
      <span class='_query identifier id'>_query</span><span class='lparen token'>(</span><span class='sql identifier id'>sql</span><span class='rparen token'>)</span> <span class='do do kw'>do</span> <span class='bitor op'>|</span><span class='row identifier id'>row</span><span class='bitor op'>|</span>
        <span class='needs_cast identifier id'>needs_cast</span><span class='dot token'>.</span><span class='each identifier id'>each</span> <span class='lbrace token'>{</span> <span class='bitor op'>|</span><span class='i identifier id'>i</span><span class='bitor op'>|</span> <span class='row identifier id'>row</span><span class='lbrack token'>[</span><span class='i identifier id'>i</span><span class='rbrack token'>]</span> <span class='assign token'>=</span> <span class='lparen token'>(</span><span class='row identifier id'>row</span><span class='lbrack token'>[</span><span class='i identifier id'>i</span><span class='rbrack token'>]</span><span class='dot token'>.</span><span class='nil? fid id'>nil?</span> <span class='integer val'>? </span><span class='nil nil kw'>nil</span> <span class='colon op'>:</span> <span class='procs identifier id'>procs</span><span class='lbrack token'>[</span><span class='i identifier id'>i</span><span class='rbrack token'>]</span><span class='dot token'>.</span><span class='call identifier id'>call</span><span class='lparen token'>(</span><span class='row identifier id'>row</span><span class='lbrack token'>[</span><span class='i identifier id'>i</span><span class='rbrack token'>]</span><span class='rparen token'>)</span><span class='rparen token'>)</span> <span class='rbrace token'>}</span>
        <span class='yield yield kw'>yield</span>  <span class='@record_constructor ivar id'>@record_constructor</span><span class='dot token'>.</span><span class='new identifier id'>new</span><span class='lparen token'>(</span><span class='mult op'>*</span><span class='row identifier id'>row</span><span class='rparen token'>)</span>
      <span class='end end kw'>end</span>

    <span class='else else kw'>else</span>
      <span class='list identifier id'>list</span> <span class='assign token'>=</span> <span class='lbrack token'>[</span><span class='rbrack token'>]</span>
      <span class='_query identifier id'>_query</span><span class='lparen token'>(</span><span class='sql identifier id'>sql</span><span class='rparen token'>)</span><span class='dot token'>.</span><span class='each identifier id'>each</span> <span class='do do kw'>do</span> <span class='bitor op'>|</span><span class='row identifier id'>row</span><span class='bitor op'>|</span>
        <span class='needs_cast identifier id'>needs_cast</span><span class='dot token'>.</span><span class='each identifier id'>each</span> <span class='lbrace token'>{</span> <span class='bitor op'>|</span><span class='i identifier id'>i</span><span class='bitor op'>|</span> <span class='row identifier id'>row</span><span class='lbrack token'>[</span><span class='i identifier id'>i</span><span class='rbrack token'>]</span> <span class='assign token'>=</span> <span class='lparen token'>(</span><span class='row identifier id'>row</span><span class='lbrack token'>[</span><span class='i identifier id'>i</span><span class='rbrack token'>]</span><span class='dot token'>.</span><span class='nil? fid id'>nil?</span> <span class='integer val'>? </span><span class='nil nil kw'>nil</span> <span class='colon op'>:</span> <span class='procs identifier id'>procs</span><span class='lbrack token'>[</span><span class='i identifier id'>i</span><span class='rbrack token'>]</span><span class='dot token'>.</span><span class='call identifier id'>call</span><span class='lparen token'>(</span><span class='row identifier id'>row</span><span class='lbrack token'>[</span><span class='i identifier id'>i</span><span class='rbrack token'>]</span><span class='rparen token'>)</span><span class='rparen token'>)</span> <span class='rbrace token'>}</span>
        <span class='list identifier id'>list</span><span class='dot token'>.</span><span class='push identifier id'>push</span> <span class='@record_constructor ivar id'>@record_constructor</span><span class='dot token'>.</span><span class='new identifier id'>new</span><span class='lparen token'>(</span><span class='mult op'>*</span><span class='row identifier id'>row</span><span class='rparen token'>)</span>
      <span class='end end kw'>end</span>
      <span class='return return kw'>return</span> <span class='list identifier id'>list</span>
    <span class='end end kw'>end</span>
  <span class='end end kw'>end</span>

  <span class='def def kw'>def</span> <span class='delete identifier id'>delete</span> <span class='where identifier id'>where</span> <span class='assign token'>=</span> <span class='nil nil kw'>nil</span>
    <span class='_modify identifier id'>_modify</span> <span class='dstring node'>&quot;DELETE FROM #{table_name}&quot;</span> <span class='plus op'>+</span> <span class='clauses identifier id'>clauses</span><span class='lparen token'>(</span><span class='where identifier id'>where</span><span class='comma token'>,</span> <span class='nil nil kw'>nil</span><span class='comma token'>,</span> <span class='nil nil kw'>nil</span><span class='rparen token'>)</span>
  <span class='end end kw'>end</span>

  <span class='comment val'># count [ where-clause ] [ order-clause ] [ limit-clause ]</span>
  <span class='comment val'>#</span>
  <span class='comment val'># Count the records to be returned for given conditions.</span>

  <span class='def def kw'>def</span> <span class='count identifier id'>count</span> <span class='where identifier id'>where</span> <span class='assign token'>=</span> <span class='nil nil kw'>nil</span><span class='comma token'>,</span> <span class='order identifier id'>order</span> <span class='assign token'>=</span> <span class='nil nil kw'>nil</span><span class='comma token'>,</span> <span class='limit identifier id'>limit</span> <span class='assign token'>=</span> <span class='nil nil kw'>nil</span>
    <span class='comment val'># query returns something like [ ['number'] ]</span>
    <span class='query identifier id'>query</span><span class='lparen token'>(</span><span class='dstring node'>&quot;SELECT COUNT(*) FROM #{table_name}&quot;</span> <span class='plus op'>+</span> <span class='clauses identifier id'>clauses</span><span class='lparen token'>(</span><span class='where identifier id'>where</span><span class='comma token'>,</span> <span class='order identifier id'>order</span><span class='comma token'>,</span> <span class='limit identifier id'>limit</span><span class='rparen token'>)</span><span class='rparen token'>)</span><span class='lbrack token'>[</span><span class='integer val'>0</span><span class='rbrack token'>]</span><span class='dot token'>.</span><span class='pop identifier id'>pop</span><span class='dot token'>.</span><span class='to_i identifier id'>to_i</span>
  <span class='end end kw'>end</span>

  <span class='comment val'># ids [ where-clause ] [ order-clause ] [ limit-clause ]</span>
  <span class='comment val'>#</span>
  <span class='comment val'># Return the ids for the given conditions; useful for sub-selects.</span>

  <span class='def def kw'>def</span> <span class='ids identifier id'>ids</span> <span class='where identifier id'>where</span> <span class='assign token'>=</span> <span class='nil nil kw'>nil</span><span class='comma token'>,</span> <span class='order identifier id'>order</span> <span class='assign token'>=</span> <span class='nil nil kw'>nil</span><span class='comma token'>,</span> <span class='limit identifier id'>limit</span> <span class='assign token'>=</span> <span class='nil nil kw'>nil</span>
    <span class='comment val'># query returns something like [ ['id-1'], ['id-2'] ... ]</span>
    <span class='query identifier id'>query</span><span class='lparen token'>(</span><span class='dstring node'>&quot;SELECT id FROM #{table_name}&quot;</span> <span class='plus op'>+</span> <span class='clauses identifier id'>clauses</span><span class='lparen token'>(</span><span class='where identifier id'>where</span><span class='comma token'>,</span> <span class='order identifier id'>order</span><span class='comma token'>,</span> <span class='limit identifier id'>limit</span><span class='rparen token'>)</span><span class='rparen token'>)</span><span class='dot token'>.</span><span class='flatten identifier id'>flatten</span><span class='dot token'>.</span><span class='map identifier id'>map</span> <span class='lbrace token'>{</span> <span class='bitor op'>|</span><span class='id identifier id'>id</span><span class='bitor op'>|</span> <span class='id identifier id'>id</span><span class='dot token'>.</span><span class='to_i identifier id'>to_i</span> <span class='rbrace token'>}</span>
  <span class='end end kw'>end</span>

  <span class='def def kw'>def</span> <span class='update identifier id'>update</span> <span class='record identifier id'>record</span>

    <span class='keys identifier id'>keys</span><span class='comma token'>,</span> <span class='vals identifier id'>vals</span> <span class='assign token'>=</span> <span class='prep identifier id'>prep</span><span class='lparen token'>(</span><span class='record identifier id'>record</span><span class='comma token'>,</span> <span class='string val'>'id'</span><span class='comma token'>,</span> <span class='string val'>'version'</span><span class='rparen token'>)</span>

    <span class='raise identifier id'>raise</span> <span class='string val'>&quot;No version set in this record. Did you mean to do an insert here?&quot;</span> <span class='if if_mod kw'>if</span> <span class='record identifier id'>record</span><span class='dot token'>.</span><span class='version identifier id'>version</span> <span class='eq op'>==</span> <span class='symbol val'>:undefined</span>

    <span class='keys identifier id'>keys</span><span class='dot token'>.</span><span class='push identifier id'>push</span> <span class='string val'>'version'</span>
    <span class='vals identifier id'>vals</span><span class='dot token'>.</span><span class='push identifier id'>push</span> <span class='record identifier id'>record</span><span class='dot token'>.</span><span class='version identifier id'>version</span> <span class='plus op'>+</span> <span class='integer val'>1</span>

    <span class='settings identifier id'>settings</span> <span class='assign token'>=</span> <span class='lparen token'>(</span><span class='keys identifier id'>keys</span><span class='dot token'>.</span><span class='zip identifier id'>zip</span> <span class='vals identifier id'>vals</span><span class='rparen token'>)</span><span class='dot token'>.</span><span class='map identifier id'>map</span> <span class='lbrace token'>{</span> <span class='bitor op'>|</span><span class='key identifier id'>key</span><span class='comma token'>,</span> <span class='val identifier id'>val</span><span class='bitor op'>|</span> <span class='dstring node'>&quot;#{key}=#{val}&quot;</span> <span class='rbrace token'>}</span><span class='dot token'>.</span><span class='join identifier id'>join</span><span class='lparen token'>(</span><span class='string val'>&quot;, &quot;</span><span class='rparen token'>)</span>

    <span class='number_affected identifier id'>number_affected</span> <span class='assign token'>=</span> <span class='_modify identifier id'>_modify</span> <span class='dstring node'>&quot;UPDATE #{table_name} SET #{settings} WHERE id=#{record.id} and version=#{record.version}&quot;</span>

    <span class='if if kw'>if</span> <span class='number_affected identifier id'>number_affected</span> <span class='eq op'>==</span> <span class='integer val'>1</span>
      <span class='record identifier id'>record</span><span class='dot token'>.</span><span class='version identifier id'>version</span> <span class='assign token'>=</span> <span class='record identifier id'>record</span><span class='dot token'>.</span><span class='version identifier id'>version</span> <span class='plus op'>+</span> <span class='integer val'>1</span>
      <span class='true true kw'>true</span>
    <span class='else else kw'>else</span>
      <span class='false false kw'>false</span>
    <span class='end end kw'>end</span>
  <span class='end end kw'>end</span>

  <span class='comment val'># id and version should not, in general, be set on these;</span>

  <span class='def def kw'>def</span> <span class='insert identifier id'>insert</span> <span class='record identifier id'>record</span>

    <span class='keys identifier id'>keys</span><span class='comma token'>,</span> <span class='vals identifier id'>vals</span> <span class='assign token'>=</span> <span class='prep identifier id'>prep</span><span class='lparen token'>(</span><span class='record identifier id'>record</span><span class='comma token'>,</span> <span class='string val'>'id'</span><span class='rparen token'>)</span>

    <span class='number_affected identifier id'>number_affected</span> <span class='assign token'>=</span> <span class='_modify identifier id'>_modify</span> <span class='dstring node'>&quot;INSERT INTO #{table_name}(#{keys.join(', ')}) VALUES(#{vals.join(', ')})&quot;</span>

    <span class='comment val'># could we get the id from this?  We lose track of our default values.</span>

    <span class='if if kw'>if</span> <span class='number_affected identifier id'>number_affected</span> <span class='eq op'>==</span> <span class='integer val'>1</span>
      <span class='record identifier id'>record</span><span class='dot token'>.</span><span class='version identifier id'>version</span> <span class='assign token'>=</span> <span class='integer val'>1</span>
      <span class='record identifier id'>record</span><span class='dot token'>.</span><span class='id identifier id'>id</span> <span class='assign token'>=</span> <span class='_last_insert_id identifier id'>_last_insert_id</span>
      <span class='true true kw'>true</span>
    <span class='else else kw'>else</span>
      <span class='false false kw'>false</span>
    <span class='end end kw'>end</span>

  <span class='rescue rescue kw'>rescue</span> <span class='PGError constant id'>PGError</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='e identifier id'>e</span>
    <span class='raise identifier id'>raise</span> <span class='Store constant id'>Store</span><span class='colon2 op'>::</span><span class='DataBaseError constant id'>DataBaseError</span><span class='comma token'>,</span> <span class='dstring node'>&quot;Postgres Insert error: #{e.message}&quot;</span>
  <span class='rescue rescue kw'>rescue</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='e identifier id'>e</span>
    <span class='raise identifier id'>raise</span> <span class='Store constant id'>Store</span><span class='colon2 op'>::</span><span class='DataBaseError constant id'>DataBaseError</span><span class='comma token'>,</span> <span class='dstring node'>&quot;Insert error: #{e.message}&quot;</span>
  <span class='end end kw'>end</span>

  <span class='def def kw'>def</span> <span class='quote identifier id'>quote</span> <span class='string identifier id'>string</span>
    <span class='return return kw'>return</span> <span class='string val'>'NULL'</span> <span class='if if_mod kw'>if</span> <span class='string identifier id'>string</span><span class='dot token'>.</span><span class='nil? fid id'>nil?</span>
    <span class='return return kw'>return</span> <span class='string val'>'NULL'</span> <span class='if if_mod kw'>if</span> <span class='string identifier id'>string</span> <span class='match op'>=~</span> <span class='regexp val'>/^NULL$/i</span>
    <span class='return return kw'>return</span> <span class='string val'>&quot;'&quot;</span> <span class='plus op'>+</span> <span class='_escape identifier id'>_escape</span><span class='lparen token'>(</span><span class='string identifier id'>string</span><span class='dot token'>.</span><span class='to_s identifier id'>to_s</span><span class='rparen token'>)</span> <span class='plus op'>+</span> <span class='string val'>&quot;'&quot;</span>
  <span class='end end kw'>end</span>

  <span class='private identifier id'>private</span>

  <span class='comment val'># 'WHERE     expects a string that gives conditions, e.g. &quot;filesystem like '%silos%' AND id &lt; 100&quot;</span>
  <span class='comment val'># 'ORDER BY' e.g. &quot;field DESC&quot; or &quot;field1, field2&quot;</span>
  <span class='comment val'># 'LIMIT'    expects a string like &quot;&lt;number&gt;&quot; or even &quot;&lt;number&gt; OFFSET &lt;start&gt;&quot; (sqlite, postgress, mysql extension)</span>

  <span class='def def kw'>def</span> <span class='clauses identifier id'>clauses</span> <span class='where identifier id'>where</span><span class='comma token'>,</span> <span class='order identifier id'>order</span><span class='comma token'>,</span> <span class='limit identifier id'>limit</span>
    <span class='phrase identifier id'>phrase</span> <span class='assign token'>=</span> <span class='lbrack token'>[</span> <span class='lparen token'>(</span><span class='where identifier id'>where</span> <span class='integer val'>? </span><span class='dstring node'>&quot;WHERE #{where}&quot;</span>    <span class='colon op'>:</span> <span class='nil nil kw'>nil</span><span class='rparen token'>)</span><span class='comma token'>,</span>
               <span class='lparen token'>(</span><span class='order identifier id'>order</span> <span class='integer val'>? </span><span class='dstring node'>&quot;ORDER BY #{order}&quot;</span> <span class='colon op'>:</span> <span class='nil nil kw'>nil</span><span class='rparen token'>)</span><span class='comma token'>,</span>
               <span class='lparen token'>(</span><span class='limit identifier id'>limit</span> <span class='integer val'>? </span><span class='dstring node'>&quot;LIMIT #{limit}&quot;</span>    <span class='colon op'>:</span> <span class='nil nil kw'>nil</span><span class='rparen token'>)</span> <span class='rbrack token'>]</span><span class='dot token'>.</span><span class='compact identifier id'>compact</span><span class='dot token'>.</span><span class='join identifier id'>join</span><span class='lparen token'>(</span><span class='string val'>&quot; &quot;</span><span class='rparen token'>)</span>

    <span class='phrase identifier id'>phrase</span><span class='dot token'>.</span><span class='empty? fid id'>empty?</span>  <span class='integer val'>? </span><span class='string val'>''</span> <span class='colon op'>:</span> <span class='string val'>' '</span> <span class='plus op'>+</span> <span class='phrase identifier id'>phrase</span>
  <span class='end end kw'>end</span>

  <span class='comment val'># Query is for rapid return of array of arrays; normally you'll want to use select.</span>

  <span class='def def kw'>def</span> <span class='query identifier id'>query</span> <span class='query_string identifier id'>query_string</span>
    <span class='if if kw'>if</span> <span class='block_given? fid id'>block_given?</span>
      <span class='_query identifier id'>_query</span><span class='lparen token'>(</span><span class='query_string identifier id'>query_string</span><span class='rparen token'>)</span> <span class='lbrace token'>{</span> <span class='bitor op'>|</span><span class='row identifier id'>row</span><span class='bitor op'>|</span> <span class='yield yield kw'>yield</span> <span class='row identifier id'>row</span> <span class='rbrace token'>}</span>
    <span class='else else kw'>else</span>
      <span class='rows identifier id'>rows</span> <span class='assign token'>=</span> <span class='lbrack token'>[</span><span class='rbrack token'>]</span>
      <span class='_query identifier id'>_query</span><span class='lparen token'>(</span><span class='query_string identifier id'>query_string</span><span class='rparen token'>)</span> <span class='lbrace token'>{</span> <span class='bitor op'>|</span><span class='row identifier id'>row</span><span class='bitor op'>|</span> <span class='rows identifier id'>rows</span><span class='dot token'>.</span><span class='push identifier id'>push</span> <span class='row identifier id'>row</span> <span class='rbrace token'>}</span>
      <span class='return return kw'>return</span> <span class='rows identifier id'>rows</span>
    <span class='end end kw'>end</span>
  <span class='end end kw'>end</span>


  <span class='comment val'># Quote the elements in a record as necessary.  Return two arrays: a subset of the field names, and values, possibly quoted.</span>

  <span class='def def kw'>def</span> <span class='prep identifier id'>prep</span> <span class='record identifier id'>record</span><span class='comma token'>,</span> <span class='mult op'>*</span><span class='discards identifier id'>discards</span>

    <span class='keys identifier id'>keys</span> <span class='assign token'>=</span> <span class='lbrack token'>[</span><span class='rbrack token'>]</span>
    <span class='vals identifier id'>vals</span> <span class='assign token'>=</span> <span class='lbrack token'>[</span><span class='rbrack token'>]</span>
    <span class='data_dictionary identifier id'>data_dictionary</span><span class='dot token'>.</span><span class='each identifier id'>each</span> <span class='do do kw'>do</span> <span class='bitor op'>|</span><span class='info identifier id'>info</span><span class='bitor op'>|</span>  <span class='comment val'># we get these in field order</span>
      <span class='field_name identifier id'>field_name</span> <span class='assign token'>=</span> <span class='info identifier id'>info</span><span class='lbrack token'>[</span><span class='symbol val'>:name</span><span class='rbrack token'>]</span>
      <span class='next next kw'>next</span> <span class='if if_mod kw'>if</span> <span class='record identifier id'>record</span><span class='lbrack token'>[</span><span class='field_name identifier id'>field_name</span><span class='rbrack token'>]</span> <span class='eq op'>==</span> <span class='symbol val'>:undefined</span>  <span class='comment val'># new records are born with this default.</span>
      <span class='next next kw'>next</span> <span class='if if_mod kw'>if</span> <span class='discards identifier id'>discards</span><span class='dot token'>.</span><span class='include? fid id'>include?</span> <span class='field_name identifier id'>field_name</span>
      <span class='keys identifier id'>keys</span><span class='dot token'>.</span><span class='push identifier id'>push</span> <span class='field_name identifier id'>field_name</span>
      <span class='if if kw'>if</span> <span class='record identifier id'>record</span><span class='lbrack token'>[</span><span class='field_name identifier id'>field_name</span><span class='rbrack token'>]</span><span class='dot token'>.</span><span class='nil? fid id'>nil?</span>
        <span class='vals identifier id'>vals</span><span class='dot token'>.</span><span class='push identifier id'>push</span> <span class='string val'>'NULL'</span>
      <span class='else else kw'>else</span>
        <span class='vals identifier id'>vals</span><span class='dot token'>.</span><span class='push identifier id'>push</span> <span class='info identifier id'>info</span><span class='lbrack token'>[</span><span class='symbol val'>:integer?</span><span class='rbrack token'>]</span> <span class='question op'>?</span> <span class='record identifier id'>record</span><span class='lbrack token'>[</span><span class='field_name identifier id'>field_name</span><span class='rbrack token'>]</span><span class='dot token'>.</span><span class='to_i identifier id'>to_i</span> <span class='colon op'>:</span> <span class='quote identifier id'>quote</span><span class='lparen token'>(</span><span class='record identifier id'>record</span><span class='lbrack token'>[</span><span class='field_name identifier id'>field_name</span><span class='rbrack token'>]</span><span class='rparen token'>)</span>
      <span class='end end kw'>end</span>
    <span class='end end kw'>end</span>

    <span class='return return kw'>return</span> <span class='keys identifier id'>keys</span><span class='comma token'>,</span> <span class='vals identifier id'>vals</span>
  <span class='end end kw'>end</span>

  <span class='comment val'># Assumes we have a version and id field.</span>

<span class='end end kw'>end</span> <span class='comment val'># of class Table</span>


<span class='comment val'># Simple left inner join;  to do: add update/inserts in a transaction - let the first specified</span>
<span class='comment val'># table have any preconditions.</span>

<span class='class class kw'>class</span> <span class='EquiJoinTable constant id'>EquiJoinTable</span> <span class='lt op'>&lt;</span> <span class='Table constant id'>Table</span>

  <span class='attr_reader identifier id'>attr_reader</span>  <span class='symbol val'>:table1_name</span><span class='comma token'>,</span> <span class='symbol val'>:table2_name</span><span class='comma token'>,</span> <span class='symbol val'>:dbh</span><span class='comma token'>,</span> <span class='symbol val'>:record_constructor</span><span class='comma token'>,</span> <span class='symbol val'>:join1</span><span class='comma token'>,</span> <span class='symbol val'>:join2</span><span class='comma token'>,</span> <span class='symbol val'>:fields</span><span class='comma token'>,</span> <span class='symbol val'>:fields1</span><span class='comma token'>,</span> <span class='symbol val'>:fields2</span><span class='comma token'>,</span> <span class='symbol val'>:data_dictionary</span>

  <span class='def def kw'>def</span> <span class='initialize identifier id'>initialize</span> <span class='connection identifier id'>connection</span><span class='comma token'>,</span> <span class='table1_name identifier id'>table1_name</span><span class='comma token'>,</span> <span class='table2_name identifier id'>table2_name</span><span class='comma token'>,</span> <span class='join1 identifier id'>join1</span><span class='comma token'>,</span> <span class='join2 identifier id'>join2</span><span class='comma token'>,</span> <span class='fields1 identifier id'>fields1</span> <span class='assign token'>=</span> <span class='lbrack token'>[</span><span class='rbrack token'>]</span><span class='comma token'>,</span> <span class='fields2 identifier id'>fields2</span> <span class='assign token'>=</span> <span class='lbrack token'>[</span><span class='rbrack token'>]</span>

    <span class='@dbh ivar id'>@dbh</span>  <span class='assign token'>=</span> <span class='connection identifier id'>connection</span><span class='dot token'>.</span><span class='dbh identifier id'>dbh</span>
    <span class='@table1_name ivar id'>@table1_name</span>  <span class='assign token'>=</span> <span class='table1_name identifier id'>table1_name</span>
    <span class='@table2_name ivar id'>@table2_name</span>  <span class='assign token'>=</span> <span class='table2_name identifier id'>table2_name</span>
    <span class='@join1 ivar id'>@join1</span> <span class='assign token'>=</span> <span class='join1 identifier id'>join1</span><span class='dot token'>.</span><span class='to_s identifier id'>to_s</span>
    <span class='@join2 ivar id'>@join2</span> <span class='assign token'>=</span> <span class='join2 identifier id'>join2</span><span class='dot token'>.</span><span class='to_s identifier id'>to_s</span>

    <span class='comment val'># bring in _escape, _query and _fields</span>

    <span class='case case kw'>case</span> <span class='connection identifier id'>connection</span><span class='dot token'>.</span><span class='vendor identifier id'>vendor</span>
    <span class='when when kw'>when</span> <span class='string val'>'postgres'</span>
      <span class='extend identifier id'>extend</span> <span class='PostgresTableMixIn constant id'>PostgresTableMixIn</span>
    <span class='when when kw'>when</span> <span class='string val'>'mysql'</span>
      <span class='extend identifier id'>extend</span> <span class='MySqlTableMixIn constant id'>MySqlTableMixIn</span>
    <span class='else else kw'>else</span>
      <span class='raise identifier id'>raise</span> <span class='dstring node'>&quot;Unsupported database #{connection.vendor}. Supported databases: 'mysql', 'postgres'.&quot;</span>
    <span class='end end kw'>end</span>

    <span class='@fields1 ivar id'>@fields1</span> <span class='assign token'>=</span>  <span class='_get_fields identifier id'>_get_fields</span><span class='lparen token'>(</span><span class='table1_name identifier id'>table1_name</span><span class='rparen token'>)</span>  <span class='if if_mod kw'>if</span> <span class='fields1 identifier id'>fields1</span><span class='dot token'>.</span><span class='empty? fid id'>empty?</span>
    <span class='@fields2 ivar id'>@fields2</span> <span class='assign token'>=</span>  <span class='_get_fields identifier id'>_get_fields</span><span class='lparen token'>(</span><span class='table2_name identifier id'>table2_name</span><span class='rparen token'>)</span>  <span class='if if_mod kw'>if</span> <span class='fields2 identifier id'>fields2</span><span class='dot token'>.</span><span class='empty? fid id'>empty?</span>

    <span class='@fields ivar id'>@fields</span> <span class='assign token'>=</span> <span class='@fields1 ivar id'>@fields1</span><span class='dot token'>.</span><span class='map identifier id'>map</span> <span class='lbrace token'>{</span> <span class='bitor op'>|</span><span class='f identifier id'>f</span><span class='bitor op'>|</span> <span class='table1_name identifier id'>table1_name</span> <span class='plus op'>+</span> <span class='string val'>'.'</span> <span class='plus op'>+</span> <span class='f identifier id'>f</span><span class='dot token'>.</span><span class='to_s identifier id'>to_s</span> <span class='rbrace token'>}</span>  <span class='plus op'>+</span>  <span class='@fields2 ivar id'>@fields2</span><span class='dot token'>.</span><span class='map identifier id'>map</span> <span class='lbrace token'>{</span> <span class='bitor op'>|</span><span class='f identifier id'>f</span><span class='bitor op'>|</span> <span class='table2_name identifier id'>table2_name</span> <span class='plus op'>+</span> <span class='string val'>'.'</span> <span class='plus op'>+</span> <span class='f identifier id'>f</span><span class='dot token'>.</span><span class='to_s identifier id'>to_s</span> <span class='rbrace token'>}</span>

    <span class='recname identifier id'>recname</span> <span class='assign token'>=</span> <span class='connection identifier id'>connection</span><span class='dot token'>.</span><span class='vendor identifier id'>vendor</span><span class='dot token'>.</span><span class='capitalize identifier id'>capitalize</span>  <span class='plus op'>+</span> <span class='string val'>'_'</span> <span class='plus op'>+</span> <span class='ConnectionId constant id'>ConnectionId</span><span class='dot token'>.</span><span class='next identifier id'>next</span><span class='dot token'>.</span><span class='to_s identifier id'>to_s</span> <span class='plus op'>+</span> <span class='string val'>'_'</span> <span class='plus op'>+</span> <span class='table1_name identifier id'>table1_name</span><span class='dot token'>.</span><span class='capitalize identifier id'>capitalize</span> <span class='plus op'>+</span> <span class='string val'>'_'</span> <span class='plus op'>+</span> <span class='table2_name identifier id'>table2_name</span><span class='dot token'>.</span><span class='capitalize identifier id'>capitalize</span>

    <span class='@record_constructor ivar id'>@record_constructor</span> <span class='assign token'>=</span> <span class='Struct constant id'>Struct</span><span class='dot token'>.</span><span class='new identifier id'>new</span><span class='lparen token'>(</span><span class='recname identifier id'>recname</span><span class='comma token'>,</span> <span class='mult op'>*</span><span class='lparen token'>(</span><span class='@fields ivar id'>@fields</span><span class='dot token'>.</span><span class='map identifier id'>map</span><span class='lbrace token'>{</span> <span class='bitor op'>|</span><span class='f identifier id'>f</span><span class='bitor op'>|</span> <span class='f identifier id'>f</span><span class='dot token'>.</span><span class='gsub identifier id'>gsub</span><span class='lparen token'>(</span><span class='string val'>'.'</span><span class='comma token'>,</span> <span class='string val'>'_'</span><span class='rparen token'>)</span><span class='rbrace token'>}</span><span class='rparen token'>)</span><span class='rparen token'>)</span>   <span class='comment val'># don't use dots in record constructor</span>

    <span class='ddl1 identifier id'>ddl1</span> <span class='assign token'>=</span> <span class='_build_data_dictionary identifier id'>_build_data_dictionary</span><span class='lparen token'>(</span><span class='table1_name identifier id'>table1_name</span><span class='comma token'>,</span> <span class='@fields1 ivar id'>@fields1</span><span class='rparen token'>)</span>
    <span class='ddl2 identifier id'>ddl2</span> <span class='assign token'>=</span> <span class='_build_data_dictionary identifier id'>_build_data_dictionary</span><span class='lparen token'>(</span><span class='table2_name identifier id'>table2_name</span><span class='comma token'>,</span> <span class='@fields2 ivar id'>@fields2</span><span class='rparen token'>)</span>

    <span class='ddl1 identifier id'>ddl1</span><span class='dot token'>.</span><span class='each identifier id'>each</span> <span class='lbrace token'>{</span> <span class='bitor op'>|</span><span class='rec identifier id'>rec</span><span class='bitor op'>|</span> <span class='rec identifier id'>rec</span><span class='lbrack token'>[</span><span class='symbol val'>:name</span><span class='rbrack token'>]</span> <span class='assign token'>=</span> <span class='table1_name identifier id'>table1_name</span> <span class='plus op'>+</span> <span class='string val'>'.'</span> <span class='plus op'>+</span> <span class='rec identifier id'>rec</span><span class='lbrack token'>[</span><span class='symbol val'>:name</span><span class='rbrack token'>]</span> <span class='rbrace token'>}</span>
    <span class='ddl2 identifier id'>ddl2</span><span class='dot token'>.</span><span class='each identifier id'>each</span> <span class='lbrace token'>{</span> <span class='bitor op'>|</span><span class='rec identifier id'>rec</span><span class='bitor op'>|</span> <span class='rec identifier id'>rec</span><span class='lbrack token'>[</span><span class='symbol val'>:name</span><span class='rbrack token'>]</span> <span class='assign token'>=</span> <span class='table2_name identifier id'>table2_name</span> <span class='plus op'>+</span> <span class='string val'>'.'</span> <span class='plus op'>+</span> <span class='rec identifier id'>rec</span><span class='lbrack token'>[</span><span class='symbol val'>:name</span><span class='rbrack token'>]</span> <span class='rbrace token'>}</span>

    <span class='@data_dictionary ivar id'>@data_dictionary</span> <span class='assign token'>=</span> <span class='ddl1 identifier id'>ddl1</span> <span class='plus op'>+</span> <span class='ddl2 identifier id'>ddl2</span>

    <span class='comment val'># Ensure our connection works up front</span>

    <span class='begin begin kw'>begin</span>
      <span class='raise identifier id'>raise</span> <span class='Store constant id'>Store</span><span class='colon2 op'>::</span><span class='ConfigurationError constant id'>ConfigurationError</span><span class='comma token'>,</span> <span class='dstring node'>&quot;Can't connect to #{vendor} database #{database}&quot;</span> <span class='unless unless_mod kw'>unless</span> <span class='lparen token'>(</span><span class='_query identifier id'>_query</span><span class='lparen token'>(</span><span class='string val'>&quot;SELECT 1+1&quot;</span><span class='rparen token'>)</span><span class='dot token'>.</span><span class='flatten identifier id'>flatten</span><span class='dot token'>.</span><span class='pop identifier id'>pop</span><span class='dot token'>.</span><span class='to_i identifier id'>to_i</span> <span class='eq op'>==</span> <span class='integer val'>2</span><span class='rparen token'>)</span>
    <span class='rescue rescue kw'>rescue</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='e identifier id'>e</span>
      <span class='raise identifier id'>raise</span> <span class='Store constant id'>Store</span><span class='colon2 op'>::</span><span class='ConfigurationError constant id'>ConfigurationError</span><span class='comma token'>,</span> <span class='e identifier id'>e</span><span class='dot token'>.</span><span class='message identifier id'>message</span>
    <span class='end end kw'>end</span>

  <span class='end end kw'>end</span>

  <span class='comment val'># SELECT requires a block, and does minimal type casting - integers, boolean strings to fixnums (or bignums)</span>

  <span class='def def kw'>def</span> <span class='select identifier id'>select</span> <span class='where identifier id'>where</span> <span class='assign token'>=</span> <span class='nil nil kw'>nil</span><span class='comma token'>,</span> <span class='order identifier id'>order</span> <span class='assign token'>=</span> <span class='nil nil kw'>nil</span><span class='comma token'>,</span> <span class='limit identifier id'>limit</span> <span class='assign token'>=</span> <span class='nil nil kw'>nil</span>

    <span class='phrase identifier id'>phrase</span> <span class='assign token'>=</span>  <span class='dstring node'>&quot;SELECT #{fields.join(', ')} &quot;</span> <span class='plus op'>+</span>
                <span class='dstring node'>&quot;FROM #{table1_name}, #{table2_name} &quot;</span> <span class='plus op'>+</span>
               <span class='dstring node'>&quot;WHERE #{table1_name}.#{join1} = #{table2_name}.#{join2}&quot;</span> <span class='plus op'>+</span>
               <span class='clauses identifier id'>clauses</span><span class='lparen token'>(</span><span class='where identifier id'>where</span><span class='comma token'>,</span> <span class='order identifier id'>order</span><span class='comma token'>,</span> <span class='limit identifier id'>limit</span><span class='rparen token'>)</span><span class='dot token'>.</span><span class='sub identifier id'>sub</span><span class='lparen token'>(</span><span class='regexp val'>/WHERE/i</span><span class='comma token'>,</span> <span class='string val'>&quot;AND&quot;</span><span class='rparen token'>)</span>

    <span class='procs identifier id'>procs</span> <span class='assign token'>=</span> <span class='data_dictionary identifier id'>data_dictionary</span><span class='dot token'>.</span><span class='map identifier id'>map</span> <span class='lbrace token'>{</span> <span class='bitor op'>|</span><span class='rec identifier id'>rec</span><span class='bitor op'>|</span> <span class='rec identifier id'>rec</span><span class='lbrack token'>[</span><span class='symbol val'>:cast</span><span class='rbrack token'>]</span> <span class='rbrace token'>}</span>         <span class='comment val'># array of cast procs or nils, in field order.</span>
    <span class='needs_cast identifier id'>needs_cast</span> <span class='assign token'>=</span> <span class='lbrack token'>[</span><span class='rbrack token'>]</span>
    <span class='procs identifier id'>procs</span><span class='dot token'>.</span><span class='each_index identifier id'>each_index</span> <span class='lbrace token'>{</span> <span class='bitor op'>|</span><span class='i identifier id'>i</span><span class='bitor op'>|</span> <span class='needs_cast identifier id'>needs_cast</span><span class='dot token'>.</span><span class='push identifier id'>push</span><span class='lparen token'>(</span><span class='i identifier id'>i</span><span class='rparen token'>)</span> <span class='if if_mod kw'>if</span> <span class='procs identifier id'>procs</span><span class='lbrack token'>[</span><span class='i identifier id'>i</span><span class='rbrack token'>]</span> <span class='rbrace token'>}</span>  <span class='comment val'># column indexes of procs we'll need to apply.</span>
    

    <span class='if if kw'>if</span> <span class='block_given? fid id'>block_given?</span>
      <span class='_query identifier id'>_query</span><span class='lparen token'>(</span><span class='phrase identifier id'>phrase</span><span class='rparen token'>)</span> <span class='do do kw'>do</span> <span class='bitor op'>|</span><span class='row identifier id'>row</span><span class='bitor op'>|</span>
        <span class='needs_cast identifier id'>needs_cast</span><span class='dot token'>.</span><span class='each identifier id'>each</span> <span class='lbrace token'>{</span> <span class='bitor op'>|</span><span class='i identifier id'>i</span><span class='bitor op'>|</span> <span class='row identifier id'>row</span><span class='lbrack token'>[</span><span class='i identifier id'>i</span><span class='rbrack token'>]</span> <span class='assign token'>=</span> <span class='lparen token'>(</span><span class='row identifier id'>row</span><span class='lbrack token'>[</span><span class='i identifier id'>i</span><span class='rbrack token'>]</span><span class='dot token'>.</span><span class='nil? fid id'>nil?</span> <span class='integer val'>? </span><span class='nil nil kw'>nil</span> <span class='colon op'>:</span> <span class='procs identifier id'>procs</span><span class='lbrack token'>[</span><span class='i identifier id'>i</span><span class='rbrack token'>]</span><span class='dot token'>.</span><span class='call identifier id'>call</span><span class='lparen token'>(</span><span class='row identifier id'>row</span><span class='lbrack token'>[</span><span class='i identifier id'>i</span><span class='rbrack token'>]</span><span class='rparen token'>)</span><span class='rparen token'>)</span> <span class='rbrace token'>}</span>
        <span class='yield yield kw'>yield</span>  <span class='@record_constructor ivar id'>@record_constructor</span><span class='dot token'>.</span><span class='new identifier id'>new</span><span class='lparen token'>(</span><span class='mult op'>*</span><span class='row identifier id'>row</span><span class='rparen token'>)</span>
      <span class='end end kw'>end</span>
    <span class='else else kw'>else</span>
      <span class='list identifier id'>list</span> <span class='assign token'>=</span> <span class='lbrack token'>[</span><span class='rbrack token'>]</span>
      <span class='_query identifier id'>_query</span><span class='lparen token'>(</span><span class='phrase identifier id'>phrase</span><span class='rparen token'>)</span> <span class='do do kw'>do</span> <span class='bitor op'>|</span><span class='row identifier id'>row</span><span class='bitor op'>|</span>
        <span class='needs_cast identifier id'>needs_cast</span><span class='dot token'>.</span><span class='each identifier id'>each</span> <span class='lbrace token'>{</span> <span class='bitor op'>|</span><span class='i identifier id'>i</span><span class='bitor op'>|</span> <span class='row identifier id'>row</span><span class='lbrack token'>[</span><span class='i identifier id'>i</span><span class='rbrack token'>]</span> <span class='assign token'>=</span> <span class='lparen token'>(</span><span class='row identifier id'>row</span><span class='lbrack token'>[</span><span class='i identifier id'>i</span><span class='rbrack token'>]</span><span class='dot token'>.</span><span class='nil? fid id'>nil?</span> <span class='integer val'>? </span><span class='nil nil kw'>nil</span> <span class='colon op'>:</span> <span class='procs identifier id'>procs</span><span class='lbrack token'>[</span><span class='i identifier id'>i</span><span class='rbrack token'>]</span><span class='dot token'>.</span><span class='call identifier id'>call</span><span class='lparen token'>(</span><span class='row identifier id'>row</span><span class='lbrack token'>[</span><span class='i identifier id'>i</span><span class='rbrack token'>]</span><span class='rparen token'>)</span><span class='rparen token'>)</span> <span class='rbrace token'>}</span>
        <span class='list identifier id'>list</span><span class='dot token'>.</span><span class='push identifier id'>push</span> <span class='@record_constructor ivar id'>@record_constructor</span><span class='dot token'>.</span><span class='new identifier id'>new</span><span class='lparen token'>(</span><span class='mult op'>*</span><span class='row identifier id'>row</span><span class='rparen token'>)</span>
      <span class='end end kw'>end</span>
      <span class='list identifier id'>list</span>
    <span class='end end kw'>end</span>
  <span class='end end kw'>end</span>

  <span class='def def kw'>def</span> <span class='update identifier id'>update</span>
    <span class='raise identifier id'>raise</span> <span class='NotImplementedError constant id'>NotImplementedError</span>
  <span class='end end kw'>end</span>

  <span class='def def kw'>def</span> <span class='insert identifier id'>insert</span>
    <span class='raise identifier id'>raise</span> <span class='NotImplementedError constant id'>NotImplementedError</span>
  <span class='end end kw'>end</span>

<span class='end end kw'>end</span> <span class='comment val'># of class EquiJoinTable</span>


<span class='class class kw'>class</span> <span class='SilosTable constant id'>SilosTable</span> <span class='lt op'>&lt;</span> <span class='Table constant id'>Table</span>
  <span class='def def kw'>def</span> <span class='initialize identifier id'>initialize</span> <span class='connection identifier id'>connection</span><span class='comma token'>,</span> <span class='mult op'>*</span><span class='fields identifier id'>fields</span>
    <span class='super super kw'>super</span><span class='lparen token'>(</span><span class='connection identifier id'>connection</span><span class='comma token'>,</span> <span class='string val'>'silos'</span><span class='comma token'>,</span> <span class='mult op'>*</span><span class='fields identifier id'>fields</span><span class='rparen token'>)</span>
  <span class='end end kw'>end</span>
<span class='end end kw'>end</span>

<span class='class class kw'>class</span> <span class='PackagesTable constant id'>PackagesTable</span> <span class='lt op'>&lt;</span> <span class='Table constant id'>Table</span>
  <span class='def def kw'>def</span> <span class='initialize identifier id'>initialize</span> <span class='connection identifier id'>connection</span><span class='comma token'>,</span> <span class='mult op'>*</span><span class='fields identifier id'>fields</span>
    <span class='super super kw'>super</span><span class='lparen token'>(</span><span class='connection identifier id'>connection</span><span class='comma token'>,</span> <span class='string val'>'packages'</span><span class='comma token'>,</span> <span class='mult op'>*</span><span class='fields identifier id'>fields</span><span class='rparen token'>)</span>
  <span class='end end kw'>end</span>
<span class='end end kw'>end</span>

<span class='class class kw'>class</span> <span class='HistoriesTable constant id'>HistoriesTable</span> <span class='lt op'>&lt;</span> <span class='Table constant id'>Table</span>
  <span class='def def kw'>def</span> <span class='initialize identifier id'>initialize</span> <span class='connection identifier id'>connection</span><span class='comma token'>,</span> <span class='mult op'>*</span><span class='fields identifier id'>fields</span>
    <span class='super super kw'>super</span><span class='lparen token'>(</span><span class='connection identifier id'>connection</span><span class='comma token'>,</span> <span class='string val'>'histories'</span><span class='comma token'>,</span> <span class='mult op'>*</span><span class='fields identifier id'>fields</span><span class='rparen token'>)</span>
  <span class='end end kw'>end</span>
<span class='end end kw'>end</span>

<span class='class class kw'>class</span> <span class='SiloLogsTable constant id'>SiloLogsTable</span> <span class='lt op'>&lt;</span> <span class='Table constant id'>Table</span>
  <span class='def def kw'>def</span> <span class='initialize identifier id'>initialize</span> <span class='connection identifier id'>connection</span><span class='comma token'>,</span> <span class='mult op'>*</span><span class='fields identifier id'>fields</span>
    <span class='super super kw'>super</span><span class='lparen token'>(</span><span class='connection identifier id'>connection</span><span class='comma token'>,</span> <span class='string val'>'silo_logs'</span><span class='comma token'>,</span> <span class='mult op'>*</span><span class='fields identifier id'>fields</span><span class='rparen token'>)</span>
  <span class='end end kw'>end</span>
<span class='end end kw'>end</span>

<span class='class class kw'>class</span> <span class='SiloPackagesTable constant id'>SiloPackagesTable</span> <span class='lt op'>&lt;</span> <span class='EquiJoinTable constant id'>EquiJoinTable</span>
  <span class='def def kw'>def</span> <span class='initialize identifier id'>initialize</span> <span class='connection identifier id'>connection</span><span class='comma token'>,</span> <span class='silos_fields identifier id'>silos_fields</span> <span class='assign token'>=</span> <span class='lbrack token'>[</span><span class='rbrack token'>]</span><span class='comma token'>,</span> <span class='packages_fields identifier id'>packages_fields</span> <span class='assign token'>=</span> <span class='lbrack token'>[</span><span class='rbrack token'>]</span>
    <span class='super super kw'>super</span><span class='lparen token'>(</span><span class='connection identifier id'>connection</span><span class='comma token'>,</span> <span class='string val'>'silos'</span><span class='comma token'>,</span> <span class='string val'>'packages'</span><span class='comma token'>,</span> <span class='string val'>'id'</span><span class='comma token'>,</span> <span class='string val'>'silo_id'</span><span class='comma token'>,</span> <span class='silos_fields identifier id'>silos_fields</span><span class='comma token'>,</span> <span class='packages_fields identifier id'>packages_fields</span><span class='rparen token'>)</span>
  <span class='end end kw'>end</span>
<span class='end end kw'>end</span>
</pre>
    </td>
  </tr>
</table>
</div>
    
  </div>

</div>
    
    <div id="footer">
  Generated on Wed Jan 26 13:30:54 2011 by 
  <a href="http://yardoc.org" title="Yay! A Ruby Documentation Tool" target="_parent">yard</a>
  0.6.0 (ruby-1.8.7).
</div>

  </body>
</html>