<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>
  Class: Store::TarReader
  
    &mdash; Silo Service
  
</title>

  <link rel="stylesheet" href="../css/style.css" type="text/css" media="screen" charset="utf-8" />

  <link rel="stylesheet" href="../css/common.css" type="text/css" media="screen" charset="utf-8" />

<script type="text/javascript" charset="utf-8">
  relpath = '..';
  if (relpath != '') relpath += '/';
</script>

  <script type="text/javascript" charset="utf-8" src="../js/jquery.js"></script>

  <script type="text/javascript" charset="utf-8" src="../js/app.js"></script>


  </head>
  <body>
    <script type="text/javascript" charset="utf-8">
      if (window.top.frames.main) document.body.className = 'frames';
    </script>
    
    <div id="header">
      <div id="menu">
  
    <a href="../_index.html">Index (T)</a> &raquo; 
    <span class='title'><span class='object_link'><a href="../Store.html" title="Store (module)">Store</a></span></span>
     &raquo; 
    <span class="title">TarReader</span>
  
  
  <div class="noframes"><span class="title">(</span><a href="." target="_top">no frames</a><span class="title">)</span></div>
</div>

      <div id="search">
  
    <a id="class_list_link" href="#">Class List</a>
  
    <a id="method_list_link" href="#">Method List</a>
  
    <a id="file_list_link" href="#">File List</a>
  
</div>
      <div class="clear"></div>
    </div>
    
    <iframe id="search_frame"></iframe>
    
    <div id="content"><h1>Class: Store::TarReader
  
  
  
</h1>

<dl class="box">
  
    <dt class="r1">Inherits:</dt>
    <dd class="r1">
      <span class="inheritName">Object</span>
      
        <ul class="fullTree">
          <li>Object</li>
          
            <li class="next">Store::TarReader</li>
          
        </ul>
        <a href="#" class="inheritanceTree">show all</a>
      
      </dd>
    
  
  
    
  
    
      <dt class="r2">Includes:</dt>
      <dd class="r2">Enumerable</dd>
      
    
  
  
  
    <dt class="r1 last">Defined in:</dt>
    <dd class="r1 last">/Users/fischer/WorkProjects/daitss2/silo-pool/lib/store/tarreader.rb</dd>
  
</dl>
<div class="clear"></div>


  <h2>Constant Summary</h2>
  
    <dl class="constants">
      
        <dt id="BUFFSIZE-constant" class="">BUFFSIZE =
          
        </dt>
        <dd><pre class="code"><span class='integer val'>1048576</span>
</pre></dd>
      
    </dl>
  


  
  <h2>Instance Attribute Summary <small>(<a href="#" class="summary_toggle">collapse</a>)</small></h2>
  <ul class="summary">
    
      <li class="public ">
  <span class="summary_signature">
    
      <a href="#filename-instance_method" title="#filename (instance method)">- (Object) <strong>filename</strong> </a>
    

    
  </span>
  
  
    <span class="note title readonly">readonly</span>
    
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Returns the value of attribute filename.</p>
</div></span>
  
</li>

    
      <li class="public ">
  <span class="summary_signature">
    
      <a href="#headers-instance_method" title="#headers (instance method)">- (Object) <strong>headers</strong> </a>
    

    
  </span>
  
  
    <span class="note title readonly">readonly</span>
    
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Returns the value of attribute headers.</p>
</div></span>
  
</li>

    
  </ul>



  

  
    <h2>
      Instance Method Summary
      <small>(<a href="#" class="summary_toggle">collapse</a>)</small>
    </h2>

    <ul class="summary">
      
        <li class="private ">
  <span class="summary_signature">
    
      <a href="#compute_header_checksum-instance_method" title="#compute_header_checksum (instance method)">- (Object) <strong>compute_header_checksum</strong>(buff) </a>
    

    
  </span>
  
  
  <span class="note title private">private</span>
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>COMPUTE_HEADER_CHECKSUM(BUFF) returns the computed checksum of the supplied
512-byte USTAR tar file header BUFF.</p>
</div></span>
  
</li>

      
        <li class="private ">
  <span class="summary_signature">
    
      <a href="#convert_from_binary_maybe-instance_method" title="#convert_from_binary_maybe (instance method)">- (Object) <strong>convert_from_binary_maybe</strong>(buff) </a>
    

    
  </span>
  
  
  <span class="note title private">private</span>
  
  
  

  
    <span class="summary_desc"><div class='inline'></div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#each-instance_method" title="#each (instance method)">- (Object) <strong>each</strong> </a>
    

    
  </span>
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>EACH  yields the pair (file-name, io-object) for each regular file in the
archive;.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#initialize-instance_method" title="#initialize (instance method)">- (TarReader) <strong>initialize</strong>(file_path) </a>
    

    
  </span>
  
    <span class="note title constructor">constructor</span>
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>A new instance of TarReader.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#io-instance_method" title="#io (instance method)">- (Object) <strong>io</strong> </a>
    

    
  </span>
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'></div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#md5-instance_method" title="#md5 (instance method)">- (Object) <strong>md5</strong> </a>
    

    
  </span>
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'></div></span>
  
</li>

      
        <li class="private ">
  <span class="summary_signature">
    
      <a href="#oct_maybe-instance_method" title="#oct_maybe (instance method)">- (Object) <strong>oct_maybe</strong>(str) </a>
    

    
  </span>
  
  
  <span class="note title private">private</span>
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>OCT_MAYBE(STR) takes a string STR, presumably an octal representation of
number, and returns it as a fixnum.</p>
</div></span>
  
</li>

      
        <li class="private ">
  <span class="summary_signature">
    
      <a href="#parse_file_header-instance_method" title="#parse_file_header (instance method)">- (Object) <strong>parse_file_header</strong>(buff) </a>
    

    
  </span>
  
  
  <span class="note title private">private</span>
  
  
  

  
    <span class="summary_desc"><div class='inline'></div></span>
  
</li>

      
        <li class="private ">
  <span class="summary_signature">
    
      <a href="#round_to_block-instance_method" title="#round_to_block (instance method)">- (Object) <strong>round_to_block</strong>(num) </a>
    

    
  </span>
  
  
  <span class="note title private">private</span>
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>ROUND_TO_BLOCK(NUM) takes the positive fixnum NUM and rounds up to the next
multiple of 512  (unless, of course, NUM is already a multiple of 512).</p>
</div></span>
  
</li>

      
        <li class="private ">
  <span class="summary_signature">
    
      <a href="#strip_nulls-instance_method" title="#strip_nulls (instance method)">- (Object) <strong>strip_nulls</strong>(buff) </a>
    

    
  </span>
  
  
  <span class="note title private">private</span>
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>STRIP_NULLS(BUFF) takes a byte buffer BUFF and strips off everything after
the first null, inclusive.</p>
</div></span>
  
</li>

      
    </ul>
  


  <div id="constructor_details" class="method_details_list">
  <h2>Constructor Details</h2>
  
    <div class="method_details first">
  <p class="signature first" id="initialize-instance_method">
  
    - (<tt><span class='object_link'><a href="" title="Store::TarReader (class)">TarReader</a></span></tt>) <strong>initialize</strong>(file_path) 
  

  
</p><div class="docstring">
  <div class="discussion">
    
<p>A new instance of TarReader</p>


  </div>
</div>
<div class="tags">
  
<h3>Raises:</h3>
<ul class="raise">
  
    <li>
      
      
        <span class='type'>(<tt><span class='object_link'><a href="TarReaderError.html" title="Store::TarReaderError (class)">TarReaderError</a></span></tt>)</span>
      
      
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File '/Users/fischer/WorkProjects/daitss2/silo-pool/lib/store/tarreader.rb', line 96</span>

<span class='def def kw'>def</span> <span class='initialize identifier id'>initialize</span> <span class='file_path identifier id'>file_path</span>
  <span class='@headers ivar id'>@headers</span>  <span class='assign token'>=</span> <span class='lbrack token'>[</span><span class='rbrack token'>]</span>
  <span class='@filename ivar id'>@filename</span> <span class='assign token'>=</span> <span class='file_path identifier id'>file_path</span>   <span class='comment val'># the tar file name</span>
  <span class='@io ivar id'>@io</span>       <span class='assign token'>=</span> <span class='open identifier id'>open</span><span class='lparen token'>(</span><span class='file_path identifier id'>file_path</span><span class='rparen token'>)</span>
  <span class='@md5 ivar id'>@md5</span>      <span class='assign token'>=</span> <span class='nil nil kw'>nil</span>
  <span class='end_state identifier id'>end_state</span> <span class='assign token'>=</span> <span class='false false kw'>false</span>
  <span class='offset identifier id'>offset</span>    <span class='assign token'>=</span> <span class='integer val'>0</span>
  <span class='last_entry_supplied_long_name identifier id'>last_entry_supplied_long_name</span> <span class='assign token'>=</span> <span class='false false kw'>false</span>   

  <span class='while while kw'>while</span> <span class='lparen token'>(</span><span class='header identifier id'>header</span> <span class='assign token'>=</span> <span class='@io ivar id'>@io</span><span class='dot token'>.</span><span class='read identifier id'>read</span><span class='lparen token'>(</span><span class='integer val'>512</span><span class='rparen token'>)</span><span class='rparen token'>)</span>  <span class='comment val'># read the next file header</span>
    <span class='offset identifier id'>offset</span> <span class='opasgn op'>+=</span> <span class='integer val'>512</span>                 <span class='comment val'># keep track of having read the header</span>

    <span class='if if kw'>if</span> <span class='header identifier id'>header</span> <span class='eq op'>==</span> <span class='integer val'>0</span><span class='dot token'>.</span><span class='chr identifier id'>chr</span> <span class='mult op'>*</span> <span class='integer val'>512</span>      <span class='comment val'># a tar file is padded at the end with 2 or more null 512-byte blocks</span>
      <span class='end_state identifier id'>end_state</span> <span class='assign token'>=</span> <span class='true true kw'>true</span>
      <span class='next next kw'>next</span>
    <span class='elsif elsif kw'>elsif</span> <span class='end_state identifier id'>end_state</span>               <span class='comment val'># TODO: strictly speaking, we should properly ignore trailing garbage after two sets of 512-byte blocks</span>
      <span class='raise identifier id'>raise</span> <span class='TarReaderError constant id'>TarReaderError</span><span class='comma token'>,</span> <span class='dstring node'>&quot;Error reading the final bits of #{file_path} - tar file is corrupted.&quot;</span>
    <span class='end end kw'>end</span>

    <span class='metadata identifier id'>metadata</span> <span class='assign token'>=</span> <span class='parse_file_header identifier id'>parse_file_header</span> <span class='header identifier id'>header</span>

    <span class='metadata identifier id'>metadata</span><span class='lbrack token'>[</span><span class='string val'>'offset'</span><span class='rbrack token'>]</span> <span class='assign token'>=</span> <span class='offset identifier id'>offset</span>            <span class='comment val'># where our file starts in the tar archive</span>

    <span class='comment val'># TODO: strictly speaking, we must have a regular file as current entry, or we have an error:</span>

    <span class='if if kw'>if</span> <span class='last_entry_supplied_long_name identifier id'>last_entry_supplied_long_name</span>       <span class='comment val'># last tar archive entry was actually a long name for this entry</span>
      <span class='metadata identifier id'>metadata</span><span class='lbrack token'>[</span><span class='string val'>'filename'</span><span class='rbrack token'>]</span> <span class='assign token'>=</span> <span class='last_entry_supplied_long_name identifier id'>last_entry_supplied_long_name</span>
      <span class='last_entry_supplied_long_name identifier id'>last_entry_supplied_long_name</span> <span class='assign token'>=</span> <span class='false false kw'>false</span>
    <span class='end end kw'>end</span>

    <span class='if if kw'>if</span> <span class='metadata identifier id'>metadata</span><span class='lbrack token'>[</span><span class='string val'>'type'</span><span class='rbrack token'>]</span> <span class='eq op'>==</span> <span class='string val'>'long file name'</span>                            <span class='comment val'># this tarchive entry is supplying a long name for next entry</span>
      <span class='last_entry_supplied_long_name identifier id'>last_entry_supplied_long_name</span> <span class='assign token'>=</span> <span class='@io ivar id'>@io</span><span class='dot token'>.</span><span class='read identifier id'>read</span><span class='lparen token'>(</span><span class='metadata identifier id'>metadata</span><span class='lbrack token'>[</span><span class='string val'>'size'</span><span class='rbrack token'>]</span> <span class='minus op'>-</span> <span class='integer val'>1</span><span class='rparen token'>)</span>   <span class='comment val'># so remember the name less the null</span>
    <span class='end end kw'>end</span>

    <span class='offset identifier id'>offset</span> <span class='opasgn op'>+=</span> <span class='round_to_block identifier id'>round_to_block</span><span class='lparen token'>(</span><span class='metadata identifier id'>metadata</span><span class='lbrack token'>[</span><span class='string val'>'size'</span><span class='rbrack token'>]</span><span class='rparen token'>)</span>   <span class='comment val'># set offset to skip over the (padded) file data</span>
    <span class='@io ivar id'>@io</span><span class='dot token'>.</span><span class='seek identifier id'>seek</span><span class='lparen token'>(</span><span class='offset identifier id'>offset</span><span class='comma token'>,</span> <span class='IO constant id'>IO</span><span class='colon2 op'>::</span><span class='SEEK_SET constant id'>SEEK_SET</span><span class='rparen token'>)</span>               <span class='comment val'># and position to the next tar archive header</span>

    <span class='@headers ivar id'>@headers</span><span class='dot token'>.</span><span class='push identifier id'>push</span> <span class='metadata identifier id'>metadata</span>
  <span class='end end kw'>end</span>

<span class='rescue rescue kw'>rescue</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='e identifier id'>e</span>
  <span class='raise identifier id'>raise</span> <span class='TarReaderError constant id'>TarReaderError</span><span class='comma token'>,</span> <span class='dstring node'>&quot;Error reading file #{file_path}: #{e.class} #{e.message}&quot;</span>
<span class='end end kw'>end</span>
</pre>
    </td>
  </tr>
</table>
</div>
  
</div>

  <div id="instance_attr_details" class="attr_details">
    <h2>Instance Attribute Details</h2>
    
      
      <span id=""></span>
      <span id="filename-instance_method"></span>
      <div class="method_details first">
  <p class="signature first" id="filename-instance_method">
  
    - (<tt>Object</tt>) <strong>filename</strong>  <span class="extras">(readonly)</span>
  

  
</p><div class="docstring">
  <div class="discussion">
    
<p>Returns the value of attribute filename</p>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


93
94
95</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File '/Users/fischer/WorkProjects/daitss2/silo-pool/lib/store/tarreader.rb', line 93</span>

<span class='def def kw'>def</span> <span class='filename identifier id'>filename</span>
  <span class='@filename ivar id'>@filename</span>
<span class='end end kw'>end</span>
</pre>
    </td>
  </tr>
</table>
</div>
    
      
      <span id=""></span>
      <span id="headers-instance_method"></span>
      <div class="method_details ">
  <p class="signature " id="headers-instance_method">
  
    - (<tt>Object</tt>) <strong>headers</strong>  <span class="extras">(readonly)</span>
  

  
</p><div class="docstring">
  <div class="discussion">
    
<p>Returns the value of attribute headers</p>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


93
94
95</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File '/Users/fischer/WorkProjects/daitss2/silo-pool/lib/store/tarreader.rb', line 93</span>

<span class='def def kw'>def</span> <span class='headers identifier id'>headers</span>
  <span class='@headers ivar id'>@headers</span>
<span class='end end kw'>end</span>
</pre>
    </td>
  </tr>
</table>
</div>
    
  </div>


  <div id="instance_method_details" class="method_details_list">
    <h2>Instance Method Details</h2>
    
    
      <div class="method_details first">
  <p class="signature first" id="compute_header_checksum-instance_method">
  
    - (<tt>Object</tt>) <strong>compute_header_checksum</strong>(buff)  <span class="extras">(private)</span>
  

  
</p><div class="docstring">
  <div class="discussion">
    
<p>COMPUTE_HEADER_CHECKSUM(BUFF) returns the computed checksum of the supplied
512-byte USTAR tar file header BUFF. The location of the checksum itself
(at <a href="http://148..155">buff</a>) is treated as a string of blanks.</p>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


194
195
196
197
198
199</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File '/Users/fischer/WorkProjects/daitss2/silo-pool/lib/store/tarreader.rb', line 194</span>

<span class='def def kw'>def</span> <span class='compute_header_checksum identifier id'>compute_header_checksum</span> <span class='buff identifier id'>buff</span>
  <span class='sum identifier id'>sum</span> <span class='assign token'>=</span>  <span class='integer val'>0</span>
  <span class='lparen token'>(</span><span class='integer val'>0</span>   <span class='dot2 op'>..</span> <span class='integer val'>147</span><span class='rparen token'>)</span><span class='dot token'>.</span><span class='each identifier id'>each</span> <span class='lbrace token'>{</span> <span class='bitor op'>|</span><span class='i identifier id'>i</span><span class='bitor op'>|</span> <span class='sum identifier id'>sum</span> <span class='opasgn op'>+=</span> <span class='buff identifier id'>buff</span><span class='lbrack token'>[</span><span class='i identifier id'>i</span><span class='rbrack token'>]</span> <span class='rbrace token'>}</span>
  <span class='lparen token'>(</span><span class='integer val'>156</span> <span class='dot2 op'>..</span> <span class='integer val'>511</span><span class='rparen token'>)</span><span class='dot token'>.</span><span class='each identifier id'>each</span> <span class='lbrace token'>{</span> <span class='bitor op'>|</span><span class='i identifier id'>i</span><span class='bitor op'>|</span> <span class='sum identifier id'>sum</span> <span class='opasgn op'>+=</span> <span class='buff identifier id'>buff</span><span class='lbrack token'>[</span><span class='i identifier id'>i</span><span class='rbrack token'>]</span> <span class='rbrace token'>}</span>
  <span class='sum identifier id'>sum</span> <span class='plus op'>+</span> <span class='integer val'>32</span> <span class='mult op'>*</span> <span class='integer val'>8</span>   
<span class='end end kw'>end</span>
</pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <p class="signature " id="convert_from_binary_maybe-instance_method">
  
    - (<tt>Object</tt>) <strong>convert_from_binary_maybe</strong>(buff)  <span class="extras">(private)</span>
  

  
</p><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


217
218
219
220
221
222
223
224
225</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File '/Users/fischer/WorkProjects/daitss2/silo-pool/lib/store/tarreader.rb', line 217</span>

<span class='def def kw'>def</span> <span class='convert_from_binary_maybe identifier id'>convert_from_binary_maybe</span> <span class='buff identifier id'>buff</span>
  <span class='if if kw'>if</span> <span class='buff identifier id'>buff</span><span class='lbrack token'>[</span><span class='integer val'>0</span><span class='rbrack token'>]</span> <span class='bitand op'>&amp;</span> <span class='integer val'>0</span><span class='b1000_0000 identifier id'>b1000_0000</span> <span class='eq op'>==</span> <span class='integer val'>0</span><span class='b1000_0000 identifier id'>b1000_0000</span>
    <span class='s identifier id'>s</span> <span class='assign token'>=</span> <span class='buff identifier id'>buff</span><span class='lbrack token'>[</span><span class='integer val'>0</span><span class='rbrack token'>]</span> <span class='bitand op'>&amp;</span> <span class='bitnot op'>~</span> <span class='integer val'>0</span><span class='b1000_0000 identifier id'>b1000_0000</span>                                       <span class='comment val'># mask out high bit</span>
    <span class='lparen token'>(</span><span class='float val'>1</span><span class='dot2 op'>..</span><span class='lparen token'>(</span><span class='buff identifier id'>buff</span><span class='dot token'>.</span><span class='length identifier id'>length</span> <span class='minus op'>-</span> <span class='integer val'>1</span><span class='rparen token'>)</span><span class='rparen token'>)</span><span class='dot token'>.</span><span class='each identifier id'>each</span> <span class='lbrace token'>{</span> <span class='bitor op'>|</span><span class='i identifier id'>i</span><span class='bitor op'>|</span> <span class='s identifier id'>s</span> <span class='assign token'>=</span> <span class='integer val'>256</span> <span class='mult op'>*</span> <span class='s identifier id'>s</span> <span class='plus op'>+</span> <span class='buff identifier id'>buff</span><span class='lbrack token'>[</span><span class='i identifier id'>i</span><span class='rbrack token'>]</span> <span class='rbrace token'>}</span>         <span class='comment val'># Horner's algorithm</span>
    <span class='return return kw'>return</span> <span class='s identifier id'>s</span>
  <span class='else else kw'>else</span>
    <span class='return return kw'>return</span> <span class='strip_nulls identifier id'>strip_nulls</span><span class='lparen token'>(</span><span class='buff identifier id'>buff</span><span class='rparen token'>)</span><span class='dot token'>.</span><span class='oct identifier id'>oct</span>    
  <span class='end end kw'>end</span>
<span class='end end kw'>end</span>
</pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <p class="signature " id="each-instance_method">
  
    - (<tt>Object</tt>) <strong>each</strong> 
  

  
</p><div class="docstring">
  <div class="discussion">
    
<p>EACH  yields the pair (file-name, io-object) for each regular file in the
archive;</p>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


142
143
144
145
146
147</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File '/Users/fischer/WorkProjects/daitss2/silo-pool/lib/store/tarreader.rb', line 142</span>

<span class='def def kw'>def</span> <span class='each identifier id'>each</span>
  <span class='headers identifier id'>headers</span><span class='dot token'>.</span><span class='each identifier id'>each</span> <span class='do do kw'>do</span> <span class='bitor op'>|</span><span class='h identifier id'>h</span><span class='bitor op'>|</span>
    <span class='next next kw'>next</span> <span class='unless unless_mod kw'>unless</span> <span class='h identifier id'>h</span><span class='lbrack token'>[</span><span class='string val'>'type'</span><span class='rbrack token'>]</span> <span class='eq op'>==</span> <span class='string val'>'regular file'</span>
    <span class='yield yield kw'>yield</span> <span class='h identifier id'>h</span><span class='lbrack token'>[</span><span class='string val'>'filename'</span><span class='rbrack token'>]</span><span class='comma token'>,</span> <span class='TarIO constant id'>TarIO</span><span class='dot token'>.</span><span class='new identifier id'>new</span><span class='lparen token'>(</span><span class='@io ivar id'>@io</span><span class='comma token'>,</span> <span class='h identifier id'>h</span><span class='lbrack token'>[</span><span class='string val'>'offset'</span><span class='rbrack token'>]</span><span class='comma token'>,</span> <span class='h identifier id'>h</span><span class='lbrack token'>[</span><span class='string val'>'size'</span><span class='rbrack token'>]</span><span class='rparen token'>)</span>
  <span class='end end kw'>end</span>
<span class='end end kw'>end</span>
</pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <p class="signature " id="io-instance_method">
  
    - (<tt>Object</tt>) <strong>io</strong> 
  

  
</p><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


159
160
161
162</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File '/Users/fischer/WorkProjects/daitss2/silo-pool/lib/store/tarreader.rb', line 159</span>

<span class='def def kw'>def</span> <span class='io identifier id'>io</span>
  <span class='@io ivar id'>@io</span><span class='dot token'>.</span><span class='rewind identifier id'>rewind</span>
  <span class='@io ivar id'>@io</span>
<span class='end end kw'>end</span>
</pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <p class="signature " id="md5-instance_method">
  
    - (<tt>Object</tt>) <strong>md5</strong> 
  

  
</p><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


149
150
151
152
153
154
155
156
157</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File '/Users/fischer/WorkProjects/daitss2/silo-pool/lib/store/tarreader.rb', line 149</span>

<span class='def def kw'>def</span> <span class='md5 identifier id'>md5</span>
  <span class='return return kw'>return</span> <span class='@md5 ivar id'>@md5</span> <span class='if if_mod kw'>if</span> <span class='@md5 ivar id'>@md5</span>
  <span class='@io ivar id'>@io</span><span class='dot token'>.</span><span class='rewind identifier id'>rewind</span>
  <span class='md5 identifier id'>md5</span> <span class='assign token'>=</span> <span class='Digest constant id'>Digest</span><span class='colon2 op'>::</span><span class='MD5 constant id'>MD5</span><span class='dot token'>.</span><span class='new identifier id'>new</span>    
  <span class='while while kw'>while</span> <span class='lparen token'>(</span><span class='buff identifier id'>buff</span> <span class='assign token'>=</span> <span class='@io ivar id'>@io</span><span class='dot token'>.</span><span class='read identifier id'>read</span> <span class='BUFFSIZE constant id'>BUFFSIZE</span><span class='rparen token'>)</span>
    <span class='md5 identifier id'>md5</span> <span class='lshft op'>&lt;&lt;</span> <span class='buff identifier id'>buff</span>
  <span class='end end kw'>end</span>
  <span class='return return kw'>return</span> <span class='@md5 ivar id'>@md5</span> <span class='assign token'>=</span> <span class='md5 identifier id'>md5</span>
<span class='end end kw'>end</span>
</pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <p class="signature " id="oct_maybe-instance_method">
  
    - (<tt>Object</tt>) <strong>oct_maybe</strong>(str)  <span class="extras">(private)</span>
  

  
</p><div class="docstring">
  <div class="discussion">
    
<p>OCT_MAYBE(STR) takes a string STR, presumably an octal representation of
number, and returns it as a fixnum. If STR is nil or false, return STR.</p>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


186
187
188
189</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File '/Users/fischer/WorkProjects/daitss2/silo-pool/lib/store/tarreader.rb', line 186</span>

<span class='def def kw'>def</span> <span class='oct_maybe identifier id'>oct_maybe</span> <span class='str identifier id'>str</span>
  <span class='return return kw'>return</span> <span class='unless unless_mod kw'>unless</span> <span class='str identifier id'>str</span>
  <span class='str identifier id'>str</span><span class='dot token'>.</span><span class='oct identifier id'>oct</span>
<span class='end end kw'>end</span>
</pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <p class="signature " id="parse_file_header-instance_method">
  
    - (<tt>Object</tt>) <strong>parse_file_header</strong>(buff)  <span class="extras">(private)</span>
  

  
</p><div class="docstring">
  <div class="discussion">
    

  </div>
</div>
<div class="tags">
  
<h3>Raises:</h3>
<ul class="raise">
  
    <li>
      
      
        <span class='type'>(<tt><span class='object_link'><a href="TarReaderError.html" title="Store::TarReaderError (class)">TarReaderError</a></span></tt>)</span>
      
      
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


245
246
247
248
249
250
251
252
253
254
255
256
257
258
259
260
261
262
263
264
265
266
267
268
269
270
271
272
273
274
275
276
277
278
279
280
281
282
283
284
285
286
287
288
289</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File '/Users/fischer/WorkProjects/daitss2/silo-pool/lib/store/tarreader.rb', line 245</span>

<span class='def def kw'>def</span> <span class='parse_file_header identifier id'>parse_file_header</span> <span class='buff identifier id'>buff</span>
  <span class='data identifier id'>data</span> <span class='assign token'>=</span> <span class='lbrace token'>{</span><span class='rbrace token'>}</span>

  <span class='raise identifier id'>raise</span> <span class='TarReaderError constant id'>TarReaderError</span><span class='comma token'>,</span> <span class='string val'>&quot;TarReader: Not a tar file (only USTAR format files (with some GNU tar extensions) are supported).&quot;</span> \
    <span class='unless unless_mod kw'>unless</span> <span class='strip_nulls identifier id'>strip_nulls</span><span class='lparen token'>(</span><span class='buff identifier id'>buff</span><span class='lbrack token'>[</span><span class='float val'>257</span><span class='dot2 op'>..</span><span class='integer val'>261</span><span class='rbrack token'>]</span><span class='rparen token'>)</span> <span class='eq op'>==</span> <span class='string val'>'ustar'</span>

  <span class='data identifier id'>data</span><span class='lbrack token'>[</span><span class='string val'>'checksum'</span><span class='rbrack token'>]</span> <span class='assign token'>=</span> <span class='strip_nulls identifier id'>strip_nulls</span><span class='lparen token'>(</span><span class='buff identifier id'>buff</span><span class='lbrack token'>[</span><span class='float val'>148</span><span class='dot2 op'>..</span><span class='integer val'>155</span><span class='rbrack token'>]</span><span class='rparen token'>)</span><span class='dot token'>.</span><span class='oct identifier id'>oct</span>
  <span class='actual_checksum identifier id'>actual_checksum</span>  <span class='assign token'>=</span> <span class='compute_header_checksum identifier id'>compute_header_checksum</span> <span class='buff identifier id'>buff</span>

  <span class='raise identifier id'>raise</span> <span class='TarReaderError constant id'>TarReaderError</span><span class='comma token'>,</span> <span class='dstring node'>&quot;TarReader: computed header checksum #{actual_checksum} doesn't match expected checksum #{data['checksum']} (tar file corrupted).&quot;</span> \
    <span class='unless unless_mod kw'>unless</span> <span class='actual_checksum identifier id'>actual_checksum</span> <span class='eq op'>==</span> <span class='data identifier id'>data</span><span class='lbrack token'>[</span><span class='string val'>'checksum'</span><span class='rbrack token'>]</span>
    
  <span class='data identifier id'>data</span><span class='lbrack token'>[</span><span class='string val'>'filename'</span><span class='rbrack token'>]</span> <span class='assign token'>=</span> <span class='strip_nulls identifier id'>strip_nulls</span><span class='lparen token'>(</span><span class='buff identifier id'>buff</span><span class='lbrack token'>[</span><span class='integer val'>0</span><span class='dot2 op'>..</span><span class='integer val'>99</span><span class='rbrack token'>]</span><span class='rparen token'>)</span>
  <span class='data identifier id'>data</span><span class='lbrack token'>[</span><span class='string val'>'mode'</span><span class='rbrack token'>]</span>     <span class='assign token'>=</span> <span class='strip_nulls identifier id'>strip_nulls</span><span class='lparen token'>(</span><span class='buff identifier id'>buff</span><span class='lbrack token'>[</span><span class='float val'>100</span><span class='dot2 op'>..</span><span class='integer val'>107</span><span class='rbrack token'>]</span><span class='rparen token'>)</span>
  <span class='data identifier id'>data</span><span class='lbrack token'>[</span><span class='string val'>'user'</span><span class='rbrack token'>]</span>     <span class='assign token'>=</span> <span class='strip_nulls identifier id'>strip_nulls</span><span class='lparen token'>(</span><span class='buff identifier id'>buff</span><span class='lbrack token'>[</span><span class='float val'>108</span><span class='dot2 op'>..</span><span class='integer val'>115</span><span class='rbrack token'>]</span><span class='rparen token'>)</span>
  <span class='data identifier id'>data</span><span class='lbrack token'>[</span><span class='string val'>'group'</span><span class='rbrack token'>]</span>    <span class='assign token'>=</span> <span class='strip_nulls identifier id'>strip_nulls</span><span class='lparen token'>(</span><span class='buff identifier id'>buff</span><span class='lbrack token'>[</span><span class='float val'>116</span><span class='dot2 op'>..</span><span class='integer val'>123</span><span class='rbrack token'>]</span><span class='rparen token'>)</span>
  <span class='data identifier id'>data</span><span class='lbrack token'>[</span><span class='string val'>'size'</span><span class='rbrack token'>]</span>     <span class='assign token'>=</span> <span class='convert_from_binary_maybe identifier id'>convert_from_binary_maybe</span><span class='lparen token'>(</span><span class='buff identifier id'>buff</span><span class='lbrack token'>[</span><span class='float val'>124</span><span class='dot2 op'>..</span><span class='integer val'>135</span><span class='rbrack token'>]</span><span class='rparen token'>)</span>
  <span class='data identifier id'>data</span><span class='lbrack token'>[</span><span class='string val'>'mtime'</span><span class='rbrack token'>]</span>    <span class='assign token'>=</span> <span class='Time constant id'>Time</span><span class='dot token'>.</span><span class='at identifier id'>at</span><span class='lparen token'>(</span><span class='strip_nulls identifier id'>strip_nulls</span><span class='lparen token'>(</span><span class='buff identifier id'>buff</span><span class='lbrack token'>[</span><span class='float val'>136</span><span class='dot2 op'>..</span><span class='integer val'>147</span><span class='rbrack token'>]</span><span class='rparen token'>)</span><span class='dot token'>.</span><span class='oct identifier id'>oct</span><span class='rparen token'>)</span>
  <span class='data identifier id'>data</span><span class='lbrack token'>[</span><span class='string val'>'linkname'</span><span class='rbrack token'>]</span> <span class='assign token'>=</span> <span class='strip_nulls identifier id'>strip_nulls</span><span class='lparen token'>(</span><span class='buff identifier id'>buff</span><span class='lbrack token'>[</span><span class='float val'>157</span><span class='dot2 op'>..</span><span class='integer val'>256</span><span class='rbrack token'>]</span><span class='rparen token'>)</span>

  <span class='data identifier id'>data</span><span class='lbrack token'>[</span><span class='string val'>'type'</span><span class='rbrack token'>]</span>  <span class='assign token'>=</span> <span class='case case kw'>case</span> <span class='buff identifier id'>buff</span><span class='lbrack token'>[</span><span class='float val'>156</span><span class='dot2 op'>..</span><span class='integer val'>156</span><span class='rbrack token'>]</span>
                  <span class='when when kw'>when</span> <span class='string val'>'0'</span> <span class='semicolon token'>;</span> <span class='string val'>'regular file'</span>
                  <span class='when when kw'>when</span> <span class='string val'>'1'</span> <span class='semicolon token'>;</span> <span class='string val'>'hard link'</span>
                  <span class='when when kw'>when</span> <span class='string val'>'2'</span> <span class='semicolon token'>;</span> <span class='string val'>'symbolic link'</span>
                  <span class='when when kw'>when</span> <span class='string val'>'3'</span> <span class='semicolon token'>;</span> <span class='string val'>'character special'</span>
                  <span class='when when kw'>when</span> <span class='string val'>'4'</span> <span class='semicolon token'>;</span> <span class='string val'>'block special'</span>
                  <span class='when when kw'>when</span> <span class='string val'>'5'</span> <span class='semicolon token'>;</span> <span class='string val'>'directory'</span>
                  <span class='when when kw'>when</span> <span class='string val'>'6'</span> <span class='semicolon token'>;</span> <span class='string val'>'fifo'</span>
                  <span class='when when kw'>when</span> <span class='string val'>'L'</span> <span class='semicolon token'>;</span> <span class='string val'>'long file name'</span>  <span class='comment val'># an extension that means the contents of this file is actually the file name of the next tar entry, which must be a regular file</span>
                  <span class='else else kw'>else</span> <span class='buff identifier id'>buff</span><span class='lbrack token'>[</span><span class='float val'>156</span><span class='dot2 op'>..</span><span class='integer val'>156</span><span class='rbrack token'>]</span>          <span class='comment val'># plenty of other extensions here, none of which we care about</span>
                  <span class='end end kw'>end</span>
  
  <span class='data identifier id'>data</span><span class='lbrack token'>[</span><span class='string val'>'ustar version'</span><span class='rbrack token'>]</span>       <span class='assign token'>=</span> <span class='strip_nulls identifier id'>strip_nulls</span><span class='lparen token'>(</span><span class='buff identifier id'>buff</span><span class='lbrack token'>[</span><span class='float val'>263</span><span class='dot2 op'>..</span><span class='integer val'>264</span><span class='rbrack token'>]</span><span class='rparen token'>)</span>
  <span class='data identifier id'>data</span><span class='lbrack token'>[</span><span class='string val'>'user name'</span><span class='rbrack token'>]</span>           <span class='assign token'>=</span> <span class='strip_nulls identifier id'>strip_nulls</span><span class='lparen token'>(</span><span class='buff identifier id'>buff</span><span class='lbrack token'>[</span><span class='float val'>265</span><span class='dot2 op'>..</span><span class='integer val'>296</span><span class='rbrack token'>]</span><span class='rparen token'>)</span>
  <span class='data identifier id'>data</span><span class='lbrack token'>[</span><span class='string val'>'group name'</span><span class='rbrack token'>]</span>          <span class='assign token'>=</span> <span class='strip_nulls identifier id'>strip_nulls</span><span class='lparen token'>(</span><span class='buff identifier id'>buff</span><span class='lbrack token'>[</span><span class='float val'>297</span><span class='dot2 op'>..</span><span class='integer val'>328</span><span class='rbrack token'>]</span><span class='rparen token'>)</span>
  <span class='data identifier id'>data</span><span class='lbrack token'>[</span><span class='string val'>'device major number'</span><span class='rbrack token'>]</span> <span class='assign token'>=</span> <span class='oct_maybe identifier id'>oct_maybe</span> <span class='strip_nulls identifier id'>strip_nulls</span><span class='lparen token'>(</span><span class='buff identifier id'>buff</span><span class='lbrack token'>[</span><span class='float val'>329</span><span class='dot2 op'>..</span><span class='integer val'>336</span><span class='rbrack token'>]</span><span class='rparen token'>)</span>
  <span class='data identifier id'>data</span><span class='lbrack token'>[</span><span class='string val'>'device minor number'</span><span class='rbrack token'>]</span> <span class='assign token'>=</span> <span class='oct_maybe identifier id'>oct_maybe</span> <span class='strip_nulls identifier id'>strip_nulls</span><span class='lparen token'>(</span><span class='buff identifier id'>buff</span><span class='lbrack token'>[</span><span class='float val'>337</span><span class='dot2 op'>..</span><span class='integer val'>344</span><span class='rbrack token'>]</span><span class='rparen token'>)</span> 
  <span class='data identifier id'>data</span><span class='lbrack token'>[</span><span class='string val'>'filename prefix'</span><span class='rbrack token'>]</span>     <span class='assign token'>=</span> <span class='strip_nulls identifier id'>strip_nulls</span><span class='lparen token'>(</span><span class='buff identifier id'>buff</span><span class='lbrack token'>[</span><span class='float val'>345</span><span class='dot2 op'>..</span><span class='integer val'>499</span><span class='rbrack token'>]</span><span class='rparen token'>)</span>          <span class='comment val'># huh. GNU tar doesn't use at all for long filenames? Or for something else?</span>

  <span class='comment val'># Not sure whether it is wise to use the standard here:</span>

  <span class='data identifier id'>data</span><span class='lbrack token'>[</span><span class='string val'>'filename'</span><span class='rbrack token'>]</span> <span class='assign token'>=</span> <span class='data identifier id'>data</span><span class='lbrack token'>[</span><span class='string val'>'filename'</span><span class='rbrack token'>]</span> <span class='plus op'>+</span> <span class='string val'>&quot;/&quot;</span> <span class='plus op'>+</span> <span class='data identifier id'>data</span><span class='lbrack token'>[</span><span class='string val'>'filename prefix'</span><span class='rbrack token'>]</span> <span class='if if_mod kw'>if</span> <span class='not not kw'>not</span> <span class='data identifier id'>data</span><span class='lbrack token'>[</span><span class='string val'>'filename prefix'</span><span class='rbrack token'>]</span><span class='dot token'>.</span><span class='nil? fid id'>nil?</span>

  <span class='return return kw'>return</span> <span class='data identifier id'>data</span>
<span class='end end kw'>end</span>
</pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <p class="signature " id="round_to_block-instance_method">
  
    - (<tt>Object</tt>) <strong>round_to_block</strong>(num)  <span class="extras">(private)</span>
  

  
</p><div class="docstring">
  <div class="discussion">
    
<p>ROUND_TO_BLOCK(NUM) takes the positive fixnum NUM and rounds up to the next
multiple of 512  (unless, of course, NUM is already a multiple of 512). 
Headers and files within a tar file all start on 512-byte boundries.</p>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


171
172
173</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File '/Users/fischer/WorkProjects/daitss2/silo-pool/lib/store/tarreader.rb', line 171</span>

<span class='def def kw'>def</span> <span class='round_to_block identifier id'>round_to_block</span> <span class='num identifier id'>num</span>
  <span class='num identifier id'>num</span><span class='dot token'>.</span><span class='modulo identifier id'>modulo</span><span class='lparen token'>(</span><span class='integer val'>512</span><span class='rparen token'>)</span> <span class='eq op'>==</span> <span class='integer val'>0</span> <span class='question op'>?</span> <span class='num identifier id'>num</span> <span class='colon op'>:</span> <span class='integer val'>512</span> <span class='mult op'>*</span> <span class='lparen token'>(</span><span class='integer val'>1</span> <span class='plus op'>+</span> <span class='num identifier id'>num</span><span class='dot token'>.</span><span class='div identifier id'>div</span><span class='lparen token'>(</span><span class='integer val'>512</span><span class='rparen token'>)</span><span class='rparen token'>)</span>
<span class='end end kw'>end</span>
</pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <p class="signature " id="strip_nulls-instance_method">
  
    - (<tt>Object</tt>) <strong>strip_nulls</strong>(buff)  <span class="extras">(private)</span>
  

  
</p><div class="docstring">
  <div class="discussion">
    
<p>STRIP_NULLS(BUFF) takes a byte buffer BUFF and strips off everything after
the first null, inclusive.   It returns the original string if no null
characters are present.  It returns nil for an empty string or a string
starting a null character.</p>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


179
180
181</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File '/Users/fischer/WorkProjects/daitss2/silo-pool/lib/store/tarreader.rb', line 179</span>

<span class='def def kw'>def</span> <span class='strip_nulls identifier id'>strip_nulls</span> <span class='buff identifier id'>buff</span>
  <span class='buff identifier id'>buff</span><span class='dot token'>.</span><span class='to_s identifier id'>to_s</span><span class='dot token'>.</span><span class='split identifier id'>split</span><span class='lparen token'>(</span><span class='dregexp node'>/#{0.chr}/</span><span class='rparen token'>)</span><span class='lbrack token'>[</span><span class='integer val'>0</span><span class='rbrack token'>]</span>
<span class='end end kw'>end</span>
</pre>
    </td>
  </tr>
</table>
</div>
    
  </div>

</div>
    
    <div id="footer">
  Generated on Mon Nov 21 17:48:03 2011 by 
  <a href="http://yardoc.org" title="Yay! A Ruby Documentation Tool" target="_parent">yard</a>
  0.7.3 (ruby-1.8.7).
</div>

  </body>
</html>