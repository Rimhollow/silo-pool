<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
    <meta name="Content-Type" content="text/html; charset=utf-8" />
<title>Class: Store::PoolReservation</title>
<link rel="stylesheet" href="../css/style.css" type="text/css" media="screen" charset="utf-8" />
<link rel="stylesheet" href="../css/common.css" type="text/css" media="screen" charset="utf-8" />

<script type="text/javascript" charset="utf-8">
  relpath = '..';
  if (relpath != '') relpath += '/';
</script>
<script type="text/javascript" charset="utf-8" src="../js/jquery.js"></script>
<script type="text/javascript" charset="utf-8" src="../js/app.js"></script>

  </head>
  <body>
    <script type="text/javascript" charset="utf-8">
      if (window.top.frames.main) document.body.className = 'frames';
    </script>
    
    <div id="header">
      <div id="menu">
  
    <a href="../_index.html">Index (P)</a> &raquo; 
    <span class='title'><span class='object_link'><a href="../Store.html" title="Store (module)">Store</a></span></span>
     &raquo; 
    <span class="title">PoolReservation</span>
  
  
  <div class="noframes"><span class="title">(</span><a href="." target="_top">no frames</a><span class="title">)</span></div>
</div>

      <div id="search">
  <a id="class_list_link" href="#">Class List</a>
  <a id="method_list_link" href="#">Method List</a>
  <a id ="file_list_link" href="#">File List</a>
</div>

      <div class="clear"></div>
    </div>
    
    <iframe id="search_frame"></iframe>
    
    <div id="content"><h1>Class: Store::PoolReservation
  
  
  
</h1>

<dl class="box">
  
    <dt class="r1">Inherits:</dt>
    <dd class="r1">
      <span class="inheritName">Object</span>
      
        <ul class="fullTree">
          <li>Object</li>
          
            <li class="next">Store::PoolReservation</li>
          
        </ul>
        <a href="#" class="inheritanceTree">show all</a>
      
      </dd>
    
  
  
    
  
    
  
  
  
    <dt class="r2 last">Defined in:</dt>
    <dd class="r2 last">/Users/fischer/WorkProjects/daitss2/silo-pool/lib/store/poolreservation.rb</dd>
  
</dl>
<div class="clear"></div>

<h2>Overview</h2><div class="docstring">
  <div class="discussion">
    <p>
Class PoolReservation provides a way to find and reserve a silo with enough
free space to store a package of a known size.
</p>
<p>
One proceeds as follows:
</p>
<pre class="code">
  <span class='require identifier id'>require</span> <span class='string val'>'store/db'</span>
  <span class='require identifier id'>require</span> <span class='string val'>'store/poolreservation'</span>
  <span class='include identifier id'>include</span> <span class='Store constant id'>Store</span>

  <span class='DB constant id'>DB</span><span class='dot token'>.</span><span class='setup identifier id'>setup</span><span class='lparen token'>(</span><span class='string val'>'/etc/db.yml'</span><span class='comma token'>,</span> <span class='string val'>'store_master'</span><span class='rparen token'>)</span>
  <span class='PoolReservation constant id'>PoolReservation</span><span class='dot token'>.</span><span class='lockfile_directory identifier id'>lockfile_directory</span> <span class='assign token'>=</span> <span class='string val'>'/var/run/silos/'</span> <span class='comment val'># defaults to /var/tmp/</span>

  <span class='PoolReservation constant id'>PoolReservation</span><span class='dot token'>.</span><span class='new identifier id'>new</span><span class='lparen token'>(</span><span class='size identifier id'>size</span><span class='rparen token'>)</span> <span class='do do kw'>do</span> <span class='bitor op'>|</span><span class='silo identifier id'>silo</span><span class='bitor op'>|</span>
    <span class='silo identifier id'>silo</span><span class='dot token'>.</span><span class='put identifier id'>put</span><span class='lparen token'>(</span><span class='name identifier id'>name</span><span class='rparen token'>)</span> <span class='dot3 op'>...</span>
  <span class='end end kw'>end</span>
</pre>


  </div>
</div>
<div class="tags">
  
</div>
  <h2>Constant Summary</h2>
  
    <dl class="constants">
      
        <dt id="MAX_RESERVATION-constant" class="">MAX_RESERVATION =
          <div class="docstring">
  <div class="discussion">
    <p>
3 hours expressed in days
</p>


  </div>
</div>
<div class="tags">
  
</div>
        </dt>
        <dd><pre class="code"><span class='float val'>3.0</span> <span class='div op'>/</span> <span class='float val'>24.0</span>
</pre></dd>
      
        <dt id="LOCK_TIMEOUT-constant" class="">LOCK_TIMEOUT =
          <div class="docstring">
  <div class="discussion">
    <p>
seconds we&#8217;ll wait to get at the DB ReservedDiskSpace table
</p>


  </div>
</div>
<div class="tags">
  
</div>
        </dt>
        <dd><pre class="code"><span class='integer val'>30</span>
</pre></dd>
      
        <dt id="HEADROOM-constant" class="">HEADROOM =
          <div class="docstring">
  <div class="discussion">
    <p>
we&#8217;ll add a fudge factor of this many KB (about four times that taken
up by the containing directories with metadata files).
</p>


  </div>
</div>
<div class="tags">
  
</div>
        </dt>
        <dd><pre class="code"><span class='integer val'>256</span> <span class='mult op'>*</span> <span class='integer val'>1024</span>
</pre></dd>
      
        <dt id="lockfile_directory-classvariable" class="">@@lockfile_directory =
          
        </dt>
        <dd><pre class="code"><span class='string val'>'/var/tmp/'</span>
</pre></dd>
      
    </dl>
  


  <h2>Instance Attribute Summary <small>(<a href="#" class="summary_toggle">collapse</a>)</small></h2>
  <ul class="summary">
    
      <li class="public ">
  <span class="summary_signature">
    
      <a href="#record_id-instance_method" title="#record_id (instance method)">- (Object) <strong>record_id</strong> </a>
    

    
  </span>
  
  
    <span class="note title readonly">readonly</span>
    
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'><p>
Returns the value of attribute record_id.
</p>
</div></span>
  
</li>

    
  </ul>


  
    <h2>
      Class Method Summary
      <small>(<a href="#" class="summary_toggle">collapse</a>)</small>
    </h2>

    <ul class="summary">
      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#lockfile-class_method" title="lockfile (class method)">+ (Object) <strong>lockfile</strong> </a>
    

    
  </span>
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'></div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#lockfile_directory%3D-class_method" title="lockfile_directory= (class method)">+ (Object) <strong>lockfile_directory=</strong>(path) </a>
    

    
  </span>
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'></div></span>
  
</li>

      
    </ul>
  
    <h2>
      Instance Method Summary
      <small>(<a href="#" class="summary_toggle">collapse</a>)</small>
    </h2>

    <ul class="summary">
      
        <li class="private ">
  <span class="summary_signature">
    
      <a href="#best_fit_silo-instance_method" title="#best_fit_silo (instance method)">- (Object) <strong>best_fit_silo</strong>(size_needed) </a>
    

    
  </span>
  
  
  <span class="note title private">private</span>
  
  
  

  
    <span class="summary_desc"><div class='inline'><p>
best_fit_silo(size_needed) returns a silo, or raises a NoSilosAvailable
exception.
</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#initialize-instance_method" title="#initialize (instance method)">- (PoolReservation) <strong>initialize</strong>(size) {|reservation_lock{ ... }| ... }</a>
    

    
  </span>
  
    <span class="note title constructor">constructor</span>
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'><p>
A new instance of PoolReservation.
</p>
</div></span>
  
</li>

      
        <li class="private ">
  <span class="summary_signature">
    
      <a href="#reservation_lock-instance_method" title="#reservation_lock (instance method)">- (Object) <strong>reservation_lock</strong>(wait_time = LOCK_TIMEOUT) </a>
    

    
  </span>
  
  
  <span class="note title private">private</span>
  
  
  

  
    <span class="summary_desc"><div class='inline'><p>
reservation_lock.
</p>
</div></span>
  
</li>

      
        <li class="private ">
  <span class="summary_signature">
    
      <a href="#writable_silos-instance_method" title="#writable_silos (instance method)">- (Object) <strong>writable_silos</strong> </a>
    

    
  </span>
  
  
  <span class="note title private">private</span>
  
  
  

  
    <span class="summary_desc"><div class='inline'><p>
writable_silos .
</p>
</div></span>
  
</li>

      
    </ul>
  

<div id="constructor_details" class="method_details_list">
  <h2>Constructor Details</h2>
  
    <div class="method_details first">
  <p class="signature first" id="initialize-instance_method">
  
    - (<tt><span class='object_link'><a href="" title="Store::PoolReservation (class)">PoolReservation</a></span></tt>) <strong>initialize</strong>(size) {|reservation_lock{ ... }| ... }
  

  
</p><div class="docstring">
  <div class="discussion">
    <p>
A new instance of PoolReservation
</p>


  </div>
</div>
<div class="tags">
  <h3>Yields:</h3>
<ul class="yield">
  
    <li>
      
        <span class='type'>(<tt>reservation_lock{ ... }</tt>)</span>
      
      
      
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


34
35
36
37
38
39
40</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File '/Users/fischer/WorkProjects/daitss2/silo-pool/lib/store/poolreservation.rb', line 34</span>

<span class='def def kw'>def</span> <span class='initialize identifier id'>initialize</span> <span class='size identifier id'>size</span>
  <span class='@record_id ivar id'>@record_id</span> <span class='assign token'>=</span> <span class='nil nil kw'>nil</span>      
  <span class='yield yield kw'>yield</span> <span class='reservation_lock identifier id'>reservation_lock</span> <span class='lbrace token'>{</span> <span class='best_fit_silo identifier id'>best_fit_silo</span><span class='lparen token'>(</span><span class='size identifier id'>size</span><span class='rparen token'>)</span> <span class='rbrace token'>}</span>
<span class='ensure ensure kw'>ensure</span>
  <span class='rec identifier id'>rec</span> <span class='assign token'>=</span> <span class='nil nil kw'>nil</span>
  <span class='reservation_lock identifier id'>reservation_lock</span> <span class='lbrace token'>{</span> <span class='rec identifier id'>rec</span><span class='dot token'>.</span><span class='destroy identifier id'>destroy</span> <span class='if if_mod kw'>if</span> <span class='@record_id ivar id'>@record_id</span> <span class='andop op'>&amp;&amp;</span> <span class='lparen token'>(</span><span class='rec identifier id'>rec</span> <span class='assign token'>=</span> <span class='DB constant id'>DB</span><span class='colon2 op'>::</span><span class='ReservedDiskSpace constant id'>ReservedDiskSpace</span><span class='dot token'>.</span><span class='get identifier id'>get</span><span class='lparen token'>(</span><span class='@record_id ivar id'>@record_id</span><span class='rparen token'>)</span><span class='rparen token'>)</span> <span class='rbrace token'>}</span>
<span class='end end kw'>end</span>
</pre>
    </td>
  </tr>
</table>
</div>
  
</div>

  <div id="instance_attr_details" class="attr_details">
    <h2>Instance Attribute Details</h2>
    
      
      <span id=""></span>
      <span id="record_id-instance_method"></span>
      <div class="method_details first">
  <p class="signature first" id="record_id-instance_method">
  
    - (<tt>Object</tt>) <strong>record_id</strong>  <span class="extras">(readonly)</span>
  

  
</p><div class="docstring">
  <div class="discussion">
    <p>
Returns the value of attribute record_id
</p>


  </div>
</div>
<div class="tags">
  
</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


32
33
34</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File '/Users/fischer/WorkProjects/daitss2/silo-pool/lib/store/poolreservation.rb', line 32</span>

<span class='def def kw'>def</span> <span class='record_id identifier id'>record_id</span>
  <span class='@record_id ivar id'>@record_id</span>
<span class='end end kw'>end</span>
</pre>
    </td>
  </tr>
</table>
</div>
    
  </div>


  <div id="class_method_details" class="method_details_list">
    <h2>Class Method Details</h2>
    
    
      <div class="method_details first">
  <p class="signature first" id="lockfile-class_method">
  
    + (<tt>Object</tt>) <strong>lockfile</strong> 
  

  
</p><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


42
43
44</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File '/Users/fischer/WorkProjects/daitss2/silo-pool/lib/store/poolreservation.rb', line 42</span>

<span class='def def kw'>def</span> <span class='self self kw'>self</span><span class='dot token'>.</span><span class='lockfile identifier id'>lockfile</span>
  <span class='File constant id'>File</span><span class='dot token'>.</span><span class='join identifier id'>join</span><span class='lparen token'>(</span><span class='@@lockfile_directory ivar id'>@@lockfile_directory</span><span class='comma token'>,</span> <span class='string val'>'pool.lockfile'</span><span class='rparen token'>)</span>
<span class='end end kw'>end</span>
</pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <p class="signature " id="lockfile_directory=-class_method">
  
    + (<tt>Object</tt>) <strong>lockfile_directory=</strong>(path) 
  

  
</p><div class="docstring">
  <div class="discussion">
    

  </div>
</div>
<div class="tags">
  <h3>Raises:</h3>
<ul class="raise">
  
    <li>
      
        <span class='type'>(<tt><span class='object_link'><a href="ConfigurationError.html" title="Store::ConfigurationError (class)">ConfigurationError</a></span></tt>)</span>
      
      
      
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


46
47
48
49
50
51
52
53
54
55
56</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File '/Users/fischer/WorkProjects/daitss2/silo-pool/lib/store/poolreservation.rb', line 46</span>

<span class='def def kw'>def</span> <span class='self self kw'>self</span><span class='dot token'>.</span><span class='lockfile_directory identifier id'>lockfile_directory</span><span class='assign token'>=</span> <span class='path identifier id'>path</span>
  <span class='me identifier id'>me</span>   <span class='assign token'>=</span>  <span class='Etc constant id'>Etc</span><span class='dot token'>.</span><span class='getpwuid identifier id'>getpwuid</span><span class='lparen token'>(</span><span class='Process constant id'>Process</span><span class='dot token'>.</span><span class='uid identifier id'>uid</span><span class='rparen token'>)</span><span class='dot token'>.</span><span class='name identifier id'>name</span>
  <span class='oops identifier id'>oops</span> <span class='assign token'>=</span> <span class='dstring node'>&quot;The directory used for writing a lockfile, '#{path}', &quot;</span>

  <span class='raise identifier id'>raise</span> <span class='ConfigurationError constant id'>ConfigurationError</span><span class='comma token'>,</span> <span class='dstring node'>&quot;#{oops} doesn't exist.&quot;</span>              <span class='unless unless_mod kw'>unless</span> <span class='File constant id'>File</span><span class='dot token'>.</span><span class='exists? fid id'>exists?</span> <span class='path identifier id'>path</span>
  <span class='raise identifier id'>raise</span> <span class='ConfigurationError constant id'>ConfigurationError</span><span class='comma token'>,</span> <span class='dstring node'>&quot;#{oops} isn't actually a directory.&quot;</span> <span class='unless unless_mod kw'>unless</span> <span class='File constant id'>File</span><span class='dot token'>.</span><span class='directory? fid id'>directory?</span> <span class='path identifier id'>path</span>
  <span class='raise identifier id'>raise</span> <span class='ConfigurationError constant id'>ConfigurationError</span><span class='comma token'>,</span> <span class='dstring node'>&quot;#{oops} isn't readable by #{me}.&quot;</span>    <span class='unless unless_mod kw'>unless</span> <span class='File constant id'>File</span><span class='dot token'>.</span><span class='readable? fid id'>readable?</span> <span class='path identifier id'>path</span>
  <span class='raise identifier id'>raise</span> <span class='ConfigurationError constant id'>ConfigurationError</span><span class='comma token'>,</span> <span class='dstring node'>&quot;#{oops} isn't writable by #{me}.&quot;</span>    <span class='unless unless_mod kw'>unless</span> <span class='File constant id'>File</span><span class='dot token'>.</span><span class='writable? fid id'>writable?</span> <span class='path identifier id'>path</span>

  <span class='@@lockfile_directory ivar id'>@@lockfile_directory</span> <span class='assign token'>=</span> <span class='path identifier id'>path</span>
<span class='end end kw'>end</span>
</pre>
    </td>
  </tr>
</table>
</div>
    
  </div>

  <div id="instance_method_details" class="method_details_list">
    <h2>Instance Method Details</h2>
    
    
      <div class="method_details first">
  <p class="signature first" id="best_fit_silo-instance_method">
  
    - (<tt>Object</tt>) <strong>best_fit_silo</strong>(size_needed)  <span class="extras">(private)</span>
  

  
</p><div class="docstring">
  <div class="discussion">
    <p>
best_fit_silo(size_needed) returns a silo, or raises a NoSilosAvailable
exception.
</p>
<p>
Our strategy is to sort silos by the size of their disk partitions such
that we get the partition with the least free space that is greater than
<tt>size_needed</tt>. We return one of the silos that uses that partition.
While it is true that at the FDA a silo&#8217;s filesystem maps to a unique
partition, there&#8217;s no requirement in this code for that to be the
case.  On succees, we reserve <tt>size_needed</tt> bytes for the selected
paritition.
</p>


  </div>
</div>
<div class="tags">
  <h3>Raises:</h3>
<ul class="raise">
  
    <li>
      
        <span class='type'>(<tt><span class='object_link'><a href="NoSilosAvailable.html" title="Store::NoSilosAvailable (class)">NoSilosAvailable</a></span></tt>)</span>
      
      
      
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File '/Users/fischer/WorkProjects/daitss2/silo-pool/lib/store/poolreservation.rb', line 104</span>

<span class='def def kw'>def</span> <span class='best_fit_silo identifier id'>best_fit_silo</span> <span class='size_needed identifier id'>size_needed</span>

  <span class='available identifier id'>available</span> <span class='assign token'>=</span> <span class='lbrace token'>{</span><span class='rbrace token'>}</span> <span class='semicolon token'>;</span> <span class='reserved identifier id'>reserved</span> <span class='assign token'>=</span> <span class='lbrace token'>{</span><span class='rbrace token'>}</span> <span class='semicolon token'>;</span> <span class='silos identifier id'>silos</span> <span class='assign token'>=</span> <span class='lbrace token'>{</span><span class='rbrace token'>}</span>   <span class='comment val'># all hashes are keyed by partition</span>

  <span class='DB constant id'>DB</span><span class='colon2 op'>::</span><span class='ReservedDiskSpace constant id'>ReservedDiskSpace</span><span class='dot token'>.</span><span class='partition_reservations identifier id'>partition_reservations</span><span class='lparen token'>(</span><span class='MAX_RESERVATION constant id'>MAX_RESERVATION</span><span class='rparen token'>)</span><span class='dot token'>.</span><span class='each identifier id'>each</span> <span class='do do kw'>do</span> <span class='bitor op'>|</span><span class='partition identifier id'>partition</span><span class='comma token'>,</span> <span class='reservation identifier id'>reservation</span><span class='bitor op'>|</span>
    <span class='reserved identifier id'>reserved</span><span class='lbrack token'>[</span><span class='partition identifier id'>partition</span><span class='rbrack token'>]</span> <span class='assign token'>=</span> <span class='reservation identifier id'>reservation</span>
  <span class='end end kw'>end</span>

  <span class='writable_silos identifier id'>writable_silos</span><span class='dot token'>.</span><span class='each identifier id'>each</span> <span class='do do kw'>do</span> <span class='bitor op'>|</span><span class='silo identifier id'>silo</span><span class='bitor op'>|</span>

    <span class='partition identifier id'>partition</span> <span class='assign token'>=</span> <span class='StoreUtils constant id'>StoreUtils</span><span class='dot token'>.</span><span class='disk_mount_point identifier id'>disk_mount_point</span><span class='lparen token'>(</span><span class='silo identifier id'>silo</span><span class='dot token'>.</span><span class='filesystem identifier id'>filesystem</span><span class='rparen token'>)</span>
    <span class='freespace identifier id'>freespace</span> <span class='assign token'>=</span> <span class='StoreUtils constant id'>StoreUtils</span><span class='dot token'>.</span><span class='disk_free identifier id'>disk_free</span><span class='lparen token'>(</span><span class='partition identifier id'>partition</span><span class='rparen token'>)</span> <span class='minus op'>-</span> <span class='lparen token'>(</span><span class='reserved identifier id'>reserved</span><span class='lbrack token'>[</span><span class='partition identifier id'>partition</span><span class='rbrack token'>]</span> <span class='orop op'>||</span> <span class='integer val'>0</span><span class='rparen token'>)</span> <span class='minus op'>-</span> <span class='size_needed identifier id'>size_needed</span> <span class='minus op'>-</span> <span class='HEADROOM constant id'>HEADROOM</span>

    <span class='next next kw'>next</span> <span class='if if_mod kw'>if</span> <span class='freespace identifier id'>freespace</span> <span class='lt op'>&lt;</span> <span class='integer val'>0</span>

    <span class='available identifier id'>available</span><span class='lbrack token'>[</span><span class='partition identifier id'>partition</span><span class='rbrack token'>]</span> <span class='assign token'>=</span> <span class='freespace identifier id'>freespace</span> 

    <span class='silos identifier id'>silos</span><span class='lbrack token'>[</span><span class='partition identifier id'>partition</span><span class='rbrack token'>]</span> <span class='opasgn op'>||=</span> <span class='lbrack token'>[</span><span class='rbrack token'>]</span>
    <span class='silos identifier id'>silos</span><span class='lbrack token'>[</span><span class='partition identifier id'>partition</span><span class='rbrack token'>]</span> <span class='lshft op'>&lt;&lt;</span> <span class='silo identifier id'>silo</span>
  <span class='end end kw'>end</span>

  <span class='raise identifier id'>raise</span> <span class='NoSilosAvailable constant id'>NoSilosAvailable</span><span class='comma token'>,</span> <span class='string val'>&quot;There are no free silos in this pool&quot;</span>  <span class='if if_mod kw'>if</span> <span class='available identifier id'>available</span><span class='dot token'>.</span><span class='empty? fid id'>empty?</span>

  <span class='comment val'># find the partition with the least free space...</span>
    
  <span class='partition identifier id'>partition</span> <span class='assign token'>=</span> <span class='available identifier id'>available</span><span class='dot token'>.</span><span class='sort identifier id'>sort</span><span class='lbrace token'>{</span> <span class='bitor op'>|</span><span class='a identifier id'>a</span><span class='comma token'>,</span> <span class='b identifier id'>b</span><span class='bitor op'>|</span>  <span class='a identifier id'>a</span><span class='lbrack token'>[</span><span class='integer val'>1</span><span class='rbrack token'>]</span> <span class='cmp op'>&lt;=&gt;</span> <span class='b identifier id'>b</span><span class='lbrack token'>[</span><span class='integer val'>1</span><span class='rbrack token'>]</span> <span class='rbrace token'>}</span><span class='dot token'>.</span><span class='map identifier id'>map</span><span class='lbrace token'>{</span> <span class='bitor op'>|</span><span class='rec identifier id'>rec</span><span class='bitor op'>|</span>  <span class='rec identifier id'>rec</span><span class='lbrack token'>[</span><span class='integer val'>0</span><span class='rbrack token'>]</span> <span class='rbrace token'>}</span><span class='dot token'>.</span><span class='shift identifier id'>shift</span>

  <span class='comment val'># ...and reserve +size_needed+ (and change) bytes for that partition.</span>

  <span class='@record_id ivar id'>@record_id</span> <span class='assign token'>=</span> <span class='DB constant id'>DB</span><span class='colon2 op'>::</span><span class='ReservedDiskSpace constant id'>ReservedDiskSpace</span><span class='dot token'>.</span><span class='create identifier id'>create</span><span class='lparen token'>(</span><span class='symbol val'>:partition</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='partition identifier id'>partition</span><span class='comma token'>,</span> <span class='symbol val'>:size</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='size_needed identifier id'>size_needed</span> <span class='plus op'>+</span> <span class='HEADROOM constant id'>HEADROOM</span><span class='rparen token'>)</span><span class='lbrack token'>[</span><span class='string val'>'id'</span><span class='rbrack token'>]</span>           
  <span class='return return kw'>return</span> <span class='silos identifier id'>silos</span><span class='lbrack token'>[</span><span class='partition identifier id'>partition</span><span class='rbrack token'>]</span><span class='dot token'>.</span><span class='shift identifier id'>shift</span>
<span class='end end kw'>end</span>
</pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <p class="signature " id="reservation_lock-instance_method">
  
    - (<tt>Object</tt>) <strong>reservation_lock</strong>(wait_time = LOCK_TIMEOUT)  <span class="extras">(private)</span>
  

  
</p><div class="docstring">
  <div class="discussion">
    <p>
reservation_lock
</p>
<p>
provide a wrapper that ensures exclusive access to something. In our case,
that something is a set of certain write/delete operations on the
DB::ReservedDiskSpace table.  We use it when we want to determine, augment,
or delete disk space reservations for a particular disk partition.
</p>


  </div>
</div>
<div class="tags">
  <h3>Raises:</h3>
<ul class="raise">
  
    <li>
      
        <span class='type'>(<tt><span class='object_link'><a href="CouldNotLockPool.html" title="Store::CouldNotLockPool (class)">CouldNotLockPool</a></span></tt>)</span>
      
      
      
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


85
86
87
88
89
90
91
92</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File '/Users/fischer/WorkProjects/daitss2/silo-pool/lib/store/poolreservation.rb', line 85</span>

<span class='def def kw'>def</span> <span class='reservation_lock identifier id'>reservation_lock</span> <span class='wait_time identifier id'>wait_time</span> <span class='assign token'>=</span> <span class='LOCK_TIMEOUT constant id'>LOCK_TIMEOUT</span>
  <span class='open identifier id'>open</span><span class='lparen token'>(</span><span class='PoolReservation constant id'>PoolReservation</span><span class='dot token'>.</span><span class='lockfile identifier id'>lockfile</span><span class='comma token'>,</span> <span class='string val'>'w'</span><span class='rparen token'>)</span> <span class='do do kw'>do</span> <span class='bitor op'>|</span><span class='fd identifier id'>fd</span><span class='bitor op'>|</span> 
   <span class='Timeout constant id'>Timeout</span><span class='dot token'>.</span><span class='timeout identifier id'>timeout</span><span class='lparen token'>(</span><span class='wait_time identifier id'>wait_time</span><span class='rparen token'>)</span> <span class='lbrace token'>{</span> <span class='fd identifier id'>fd</span><span class='dot token'>.</span><span class='flock identifier id'>flock</span><span class='lparen token'>(</span><span class='File constant id'>File</span><span class='colon2 op'>::</span><span class='LOCK_EX constant id'>LOCK_EX</span><span class='rparen token'>)</span> <span class='rbrace token'>}</span>
    <span class='yield yield kw'>yield</span>
  <span class='end end kw'>end</span>
<span class='rescue rescue kw'>rescue</span> <span class='Timeout constant id'>Timeout</span><span class='colon2 op'>::</span><span class='Error constant id'>Error</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='e identifier id'>e</span>
  <span class='raise identifier id'>raise</span> <span class='CouldNotLockPool constant id'>CouldNotLockPool</span><span class='comma token'>,</span> <span class='dstring node'>&quot;Timed out waiting #{wait_time} seconds to get the pool lockfile #{PoolReservation.lockfile}: #{e.message}&quot;</span>
<span class='end end kw'>end</span>
</pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <p class="signature " id="writable_silos-instance_method">
  
    - (<tt>Object</tt>) <strong>writable_silos</strong>  <span class="extras">(private)</span>
  

  
</p><div class="docstring">
  <div class="discussion">
    <p>
writable_silos 
</p>
<p>
returns a list of candidate silos for a PUT, sorted by the name of
silo&#8217;s filesystem. No checks are made for free space at this time.
</p>


  </div>
</div>
<div class="tags">
  
</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


66
67
68
69
70
71
72
73
74
75</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File '/Users/fischer/WorkProjects/daitss2/silo-pool/lib/store/poolreservation.rb', line 66</span>

<span class='def def kw'>def</span> <span class='writable_silos identifier id'>writable_silos</span>
  <span class='list identifier id'>list</span> <span class='assign token'>=</span> <span class='lbrack token'>[</span><span class='rbrack token'>]</span>
  <span class='DB constant id'>DB</span><span class='colon2 op'>::</span><span class='SiloRecord constant id'>SiloRecord</span><span class='dot token'>.</span><span class='list identifier id'>list</span><span class='dot token'>.</span><span class='each identifier id'>each</span> <span class='do do kw'>do</span> <span class='bitor op'>|</span><span class='rec identifier id'>rec</span><span class='bitor op'>|</span>                       <span class='comment val'># TODO: part of the silo refactoring here.</span>
    <span class='next next kw'>next</span> <span class='unless unless_mod kw'>unless</span> <span class='rec identifier id'>rec</span><span class='dot token'>.</span><span class='media_device identifier id'>media_device</span> <span class='eq op'>==</span> <span class='symbol val'>:disk</span>
    <span class='silo identifier id'>silo</span> <span class='assign token'>=</span> <span class='SiloDB constant id'>SiloDB</span><span class='dot token'>.</span><span class='new identifier id'>new</span> <span class='rec identifier id'>rec</span><span class='dot token'>.</span><span class='hostname identifier id'>hostname</span><span class='comma token'>,</span> <span class='rec identifier id'>rec</span><span class='dot token'>.</span><span class='filesystem identifier id'>filesystem</span>
    <span class='list identifier id'>list</span><span class='dot token'>.</span><span class='push identifier id'>push</span> <span class='silo identifier id'>silo</span> <span class='if if_mod kw'>if</span> <span class='silo identifier id'>silo</span><span class='dot token'>.</span><span class='allowed_methods identifier id'>allowed_methods</span><span class='dot token'>.</span><span class='include? fid id'>include?</span> <span class='symbol val'>:put</span>
  <span class='end end kw'>end</span>

  <span class='return return kw'>return</span> <span class='list identifier id'>list</span><span class='dot token'>.</span><span class='sort identifier id'>sort</span> <span class='lbrace token'>{</span> <span class='bitor op'>|</span><span class='a identifier id'>a</span><span class='comma token'>,</span><span class='b identifier id'>b</span><span class='bitor op'>|</span> <span class='a identifier id'>a</span><span class='dot token'>.</span><span class='filesystem identifier id'>filesystem</span> <span class='cmp op'>&lt;=&gt;</span> <span class='b identifier id'>b</span><span class='dot token'>.</span><span class='filesystem identifier id'>filesystem</span> <span class='rbrace token'>}</span>
<span class='end end kw'>end</span>
</pre>
    </td>
  </tr>
</table>
</div>
    
  </div>

</div>
    
    <div id="footer">
  Generated on Wed Jan 26 13:31:02 2011 by 
  <a href="http://yardoc.org" title="Yay! A Ruby Documentation Tool" target="_parent">yard</a>
  0.6.0 (ruby-1.8.7).
</div>

  </body>
</html>